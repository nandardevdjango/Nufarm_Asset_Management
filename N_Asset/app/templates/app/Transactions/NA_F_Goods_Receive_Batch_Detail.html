{% extends "../../app/layout.html" %}
{% block SearchData %}
{% for itemCombo in populateColumn %}
<li><a href="#" data-tipe="{{itemCombo.dataType}}" data-column="{{itemCombo.columnName}}">{{itemCombo.label}}</a></li>
{% endfor %}

{% endblock %}

{% block javascriptAndUI %}
<!--================================Load Script Modules NA ===========================================-->
<script type="text/javascript" src="../../../static/app/scripts/NAJS.js"></script>
<!--=======================================================================================================-->

<script type="text/javascript">

    (function () {
        var txtSearchMaster = NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
	    btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default');
        var defPlaceHolder = txtSearchMaster.getAttribute('placeholder');
        //================local custom search doesn't support custom search ================
        //if (!NA.common.getElementID('CustomSearch')) {
        //    var parentC = NA.common.doc.querySelector('ul.dropdown-menu.search');
        //    lastLi = NA.common.doc.createElement('li'),
		//	lastLi_a = NA.common.doc.createElement('a');
        //    lastLi_a.setAttribute('id', 'custSearch');
        //    lastLi_a.textContent = 'CustomSearch';
        //    lastLi.appendChild(lastLi_a);
        //    parentC.appendChild(lastLi);
        //}

        //=================add Dynamic Styles=============================
        NA.common.loadStyles("../../../static/app/content/jquery-ui.min.css", "jqueryUI");
        NA.common.loadStyles("../../../static/app/content/ui.jqgrid.css", "UIJqueryGrid");
        NA.common.loadStyles("../../../static/app/content/font-awesome.min.css", "CSSLoader");
        NA.common.loadStyles("../../../static/app/content/bootstrap-dialog.css", "BootstrapDialog");
        var doc = doc || window.document;
        var DivSearch = doc.querySelector('ul.dropdown-menu.search');//return list Element
    	(function (elm) {
    		//=========custom local data filtering====================
    		//http://www.ok-soft-gmbh.com/jqGrid/SimpleLocalGridFiltered.htm
    		//$("#search").click(function () {
    		//	var searchFiler = $("#filter").val(), f;

    		//	if (searchFiler.length === 0) {
    		//		grid[0].p.search = false;
    		//		$.extend(grid[0].p.postData, { filters: "" });
    		//	}
    		//	f = { groupOp: "OR", rules: [] };
    		//	f.rules.push({ field: "name", op: "cn", data: searchFiler });
    		//	f.rules.push({ field: "note", op: "cn", data: searchFiler });
    		//	grid[0].p.search = true;
    		//	$.extend(grid[0].p.postData, { filters: JSON.stringify(f) });
    		//	grid.trigger("reloadGrid", [{ page: 1, current: true }]);
    		//});
            var listElem = elm.children;
            var datePlaceHolder = 'yyyy-mm-dd or mm/dd/yyyy';
            var numPlaceHolder = 'enter numeric type';
            Array.prototype.forEach.call(listElem, function (item) {//buat jadi foreach mesti convert dulu ke array
                NA.NAEvent.addHandler(item, 'click', function (event) {

                    //==========local data doesn't support custom filter====================
                    //if (item.firstChild.id === 'custSearch') {
                    //    //=========='show dialog search'==================
                    //    //NA.common.dialog.createSearchDialog(event)
                    //    //txtSearchMaster.setAttribute('disabled', true);
                    //    //txtSearchMaster.setAttribute('placeholder', '');
                    //    //btnSearchMaster.setAttribute('disabled', true)
                     
                    //}
                    //else {
                      
                    //}
                    txtSearchMaster.removeAttribute('disabled');
                    btnSearchMaster.removeAttribute('disabled');
                    var textSearch = NA.common.getElementID('bySearch');
                    textSearch.firstChild.nodeValue = item.textContent;
                    var elSearch = item.firstChild;
                    switch (elSearch.dataset.tipe) {
                        case "varchar":
                        case "nchar":
                        case "char":
                        case "nvarchar": {
                            txtSearchMaster.setAttribute('placeholder', defPlaceHolder);
                            break;
                        }
                        case "int":
                        case "integer":
                        case "decimal":
                        case "floatt":
                        case "bigint": {
                            txtSearchMaster.setAttribute('placeholder', numPlaceHolder);
                            break;
                        }
                        case "datetime": {
                            txtSearchMaster.setAttribute('placeholder', datePlaceHolder);
                            break;
                        }
                    }
                    event.preventDefault();
                    //event.stopImmediatePropagation();
                });
            });

            NA.NAEvent.addHandler(txtSearchMaster, 'blur', function (e) {
                //get textcontent IDbySearch
                //looping dropdown li a textContent
                var SearchByText = NA.common.getElementID('bySearch').textContent;
                var elSearch = null;
                Array.prototype.forEach.call(listElem, function (item) {
                    if (item.firstChild.text == SearchByText) {
                        elSearch = item.firstChild;
                        return;
                    }
                });
                if (!elSearch) { elSearch = listElem[0].firstChild; }
                switch (elSearch.dataset.tipe) {
                    case "varchar":
                    case "nchar":
                    case "char":
                    case "nvarchar": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== defPlaceHolder) {
                                this.setAttribute('placeholder', defPlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                    case "int":
                    case "integer":
                    case "decimal":
                    case "floatt":
                    case "bigint": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== numPlaceHolder) {
                                this.setAttribute('placeholder', numPlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                    case "datetime": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== datePlaceHolder) {
                                this.setAttribute('placeholder', datePlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                }
            });
            NA.NAEvent.addHandler(txtSearchMaster, 'focus', function (e) {
                if (this.value === '') {
                    if (this.getAttribute('placeholder') !== '') {
                        this.setAttribute('placeholder', '');
                    }
                }
            });
        })(DivSearch);
    })();
</script>


<!--SETUP Jquery grid-->
<!-- The jQuery library is a prerequisite for all jqSuite products -->
<script>window.jQuery || NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/jquery\-1\.11\.1\.js\"\>\<\/script\>');</script>

<!-- This is the Javascript file of jqGrid -->
<script src="../../../static/app/scripts/jquery.jqGrid.min.js"></script>
<!--<script src="../../../static/app/scripts/jquery.jqgrid.src.js"></script>-->
<!-- This is the localization file of the grid controlling messages, labels, etc. -->
<!-- We support more than 40 localizations -->
<script src="../../../static/app/scripts/grid.locale-en.js"></script>
<!----------------------------Load Jquery UI. JS file-------------------------------->
<script src="../../../static/app/scripts/jquery-ui.js"></script>
<script type="text/javascript">if (typeof $.fn.modal == 'undefined') { NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/bootstrap\.js\"\>\<\/script\>'); }</script>
<script src="../../../static/app/scripts/bootstrap-dialog.js"></script>
<script src="../../../static/app/scripts/material.spinner.min.js"></script>
{% endblock %}

{% block content-0 %}
<style type="text/css">
    div#content-0 {
        overflow: hidden;
    }
    table.ui-pg-table.navtable.ui-common-table {
        border-collapse: separate;
        border-spacing: 5px;
    }
	.ui-jqgrid .ui-pg-button span{
		float:unset;
		display:inline-block;
	}

.product_tabel td, .product_tabel th{border:solid 1px green;padding:2px;}
    div#gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail, div#gview_jqGrid_NA_F_Goods_Receive_Batch_Detail, div#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager, div.ui-jqgrid-titlebar {
        border-radius: 0px;
    }
	    div#gbox_jqGrid_NA_F_Goods_Receive, div#gview_jqGrid_NA_F_Goods_Receive, div.ui-jqgrid-titlebar {
        border-radius: 0px;
    }
    td#jqGrid_NA_F_Goods_Receive_Pager_Batch_Detail_left {
        width: inherit
    }
        td#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager_left td.ui-pg-button ui-corner-all {
            width: auto;
            padding: 2px;
        }

		    div#gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail, div#gview_jqGrid_NA_F_Goods_Receive_Batch_Detail, div#jqGrid_NA_F_Goods_Receive_Batch_Detail, div.ui-jqgrid-titlebar {
        border-radius: 0px;
    }

    td#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager_left {
        width: inherit
    }

    .not-editable-cell {
        cursor: not-allowed;
        background-color: #eeeeee;
    }

    .row_RBD {
        margin-top: 0;
        padding: 0 5px;
    }

    .clickable {
        cursor: pointer;
    }

    .panel-heading span {
        margin-top: -20px;
        font-size: 15px;
    }
    .container-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) !important;
    }
	.panel{
		margin-bottom:10px;
	}
	.panel-body{
		padding:5px;
	}
	/*ui-jqgrid .ui-jqgrid-bdiv{
		overflow-y:scroll;
	}*/
</style>
<div class="container" id="mainContainer_Detail">
    <div class="row row_RBD">
        <div class="col-md-6">
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="text-center" id="errorRefNo">
                        <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> Oops:
                        <small>Page not found - <b>404 error</b></small>
                    </h3>
                    <h3 class="panel-title">Choose Reference Number</h3>
                    <span class="pull-right clickable"><i class="glyphicon glyphicon-chevron-up"></i></span>
                </div>
                <div id ="pnlBody" class="panel-body">
                    <div class="NA-Entry-div-row">
                        <div class="input-group" style="display:inline-flex;width:75%;">
                            <input name="refno" class="NA-Form-Control" style="width:400px;display:inline-block;margin-right:5px;" tabindex="0" placeholder="Ref number" data-value="Please enter ref number"
                                   tittle="Enter Reference number to show data to edit to" data-toggle="tooltip" data-title="Enter Reference number to show data to edit to" maxlength="50" required="" id="id_refno" type="text">
                            <span class="input-group-btn" style="display:inline-flex;height: 28px;padding-bottom:0;justify-content:flex-end">
                                <button class="btn btn-success" type="button" id="FE_Ref_No" style="padding:4px 8px;height: 28px;"><i class="glyphicon glyphicon-search"></i></button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
	<div id="divTable" class="row row_RBD" style="overflow:auto">
    <table id="jqGrid_NA_F_Goods_Receive" style="overflow:auto"></table>
    <!--<div id="jqGrid_NA_F_Goods_Receive_Pager" style="overflow:auto"></div>-->
	</div>
	<div id="divTableDetail" class="row row_RBD" style="border-top:1px solid #0b9910">
	<table id="jqGrid_NA_F_Goods_Receive_Batch_Detail" style="overflow:auto"></table>
    <div id="jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager" style="overflow:auto"></div>
	</div>
	{% csrf_token %}
	<!--<input type="hidden" id="initializeForm" value="" />-->
</div>
{% endblock %}

{%block DialogEntry %}
<script type="text/javascript">
	(function () {
		$('.panel-heading span.clickable').click(function (event) {
			var $this = $(this);
			if (!$this.hasClass('panel-collapsed')) {
				$this.parents('.panel').find('.panel-body').slideUp();
				$this.addClass('panel-collapsed');
				$this.find('i').removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
			} else {
				$this.parents('.panel').find('.panel-body').slideDown();
				$this.removeClass('panel-collapsed');
				$this.find('i').removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
			}
		});

		//#region ==============Ajaxsetup====================
		$.ajaxSetup({
			cache: false,
			error: function (xhr, status, error) {
				try {
					var messageErr = xhr.responseText;
					var contentype = xhr.getResponseHeader('Content-Type')
					if (contentype === 'application/json') {
						messageErr = $.parseJSON(xhr.responseText);
					}
					var message = xhr.responseText;
					if (messageErr) {
						message = messageErr.message;
					}
					if (message) {
						ShowAlert('An error occurred: ' + error + '\n' + xhr.status + ": " + message);
					}

				} catch (e) {
					ShowAlert('An error occurred: ' + error + '\n' + xhr.status + ": " + e.message);
				}
				window.document.body.style.cursor = 'defautl'; return false;
			},
			timeout: 2000000, // Timeout// nanti kalau sudah selesai system timeout ini harus di rubah, jadi maximal 20 detik
			type: 'GET',
			crossDomain: false, // obviates need for sameOrigin test                              
		});
		//#endregion END AJAX SetuP===========================

		//#region=================Variable Object ===============================
		var win = win || window, gridHeader = $("#jqGrid_NA_F_Goods_Receive"),
        gridTbl = $("#jqGrid_NA_F_Goods_Receive_Batch_Detail"), gridPager = $('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager'),
        txtSearchMaster = NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
        btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default'),
        csrftoken = function () { return NA.CookieUtil.get('csrftoken'); },
        //TypeApps = [],
        //settings btn sesuai user access
        //anggap saja sekarang admin
		btnAdd = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(1)'),
		btnOpen = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(2)'),
		btnEdit = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(3)'),
        btnSave = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(4)'),
        btnDelete = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(5)'),
        btnExport = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(6)'),
        btnPrint = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(7)'),
        btnHelp = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(8)'),

        containerMenu = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav'),//inistialisasi menu 
		originalData = {}, txtRefno = NA.common.getElementID('id_refno'), 
	    filterToolbar = NA.common.qs('div#bs-example-navbar-collapse-1 > div.col-sm-8.col-md-4:nth-child(2)'),
		errorRefNo = NA.common.getElementID('errorRefNo'), NAAjax = NA.common.AJAX;
		var btnFindRefno = NA.common.getElementID('FE_Ref_No');
		btnFindRefno.dataset.directEventTarget = "FromClick";
		//win.gridSelection = function () {
		//	var xSelection = 'header';
		//	return {
		//		getSelection: function () { return this.xSelection; },
		//		setSelection: function (NSelection) { this.xSelection = NSelection; }
		//	}
		//};
		//var gridSelect = win.gridSelection();
		errorRefNo.style.display = 'none', listBrands = [], listTypeApp = [];
		NA.common.doc.title = 'Entry Data Goods Receive Detail';
		//NA.common.loadStyles("../../../static/app/content/Dialog.css", "DialogEntryStyle");//Load Style buat dialog sebelum di pakai
		NA.common.loadStyles("../../../static/app/content/NA_commonEntry.css", "CommonEntry");//Load Style buat form sebelum di pakai
		//#endregion====================End Variable Object untuk============================
		win.onunload = function () {

			var frmSearch = NA.common.doc.querySelector('form.navbar-form');
			frmSearch.reset();
			txtSearchMaster.value = '';
			if (typeof txtSearchMaster.onkeydown == "function") {
				NA.NAEvent.removeHandler(txtSearchMaster, 'keydown', handlerSearchInput)
			}
			if (typeof btnSearchMaster.onclick == "function") {
				NA.NAEvent.removeHandler(btnSearchMaster, 'click', handlerSearchInput);
			}
		};

		function getGridCellValue(thegrid, CeltoGet) {
			var reccount = thegrid.jqGrid('getGridParam', 'reccount');
			var rowId, rowData, colData;
			if (reccount > 0) {
				rowId = thegrid.jqGrid('getGridParam', 'selrow');
				if (rowId) {
					rowData = thegrid.getRowData(rowId);
					colData = rowData[CeltoGet];
				}
			}
			return colData;
		};
		function XhrError(xhr) {
			try {
				var messageErr = xhr.responseText;
				var contentype = xhr.getResponseHeader('Content-Type')
				if (contentype === 'application/json') {
					messageErr = JSON.parse(xhr.responseText);
				}
				var message = xhr.responseText;
				if (messageErr) {
					message = messageErr.message;
					if (message.indexOf('!DOCTYPE html') > 0) {
						//error bawaan dari python django
						//redirect to error web
						//untuk sekarang tampilkan saja error codenya saja
						ShowAlert('Unknown Server error occurred: ' + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
						document.body.style.cursor = 'default';
						return false;
					}
					else if (xhr.status >= 500) {
						ShowAlert('Unknown Server error occurred: ' + '\n' + message + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
						document.body.style.cursor = 'default';
						return false;
					}
					else if (message) {
						ShowAlert('An error occurred: ' + message);
					}
					else {
						ShowAlert('An error occurred: ' + messageErr);
					}
				}
				else if (message) {
					ShowAlert('An error occurred: ' + message);
				}
				document.body.style.cursor = 'default';
			} catch (e) {
				ShowAlert('An error occurred: ' + e + '\n' + e.message);
				document.body.style.cursor = 'default';
			}
			return false;
		};
		function fetcBrands(elem) {
			var oriData = JSON.parse(originalData);

			var idAppFKGoods = oriData['header'][0]['idapp_fk_goods'];
			NAAjax.GET("getBrandForDetailEntry/?" + win.encodeURIComponent("fk_goods") + "=" + win.encodeURIComponent(idAppFKGoods) + "&term=",
                                                            'application/json',//overrideMimeType returned by the server
                                                            function (e) { window.document.body.style.cursor = 'wait'; },
                                                            null,//nggak usah di isi bila tidak perlu
                                                            function (e) {//function executed after data has been returned by server(XHR.onload)
                                                            	var data = JSON.parse(this.responseText);
                                                            	var OlistBrands = listBrands.slice();
                                                            	if (data) {
                                                            		//simpen di list
                                                            		Array.prototype.forEach.call(data, function (item) {
                                                            			if (OlistBrands.indexOf(item.value) < 0) {
                                                            				listBrands.push(item.value);
                                                            			}
                                                            		});
                                                            		$(elem).autocomplete({
                                                            			//source: "getBrandForDetailEntry/?fk_goods=" + win.encodeURIComponent(idAppFKGoods),
                                                            			source: (function (lst) {
                                                            				var retvals = [];
                                                            				for (var i = 0; i < lst.length; i++) {
                                                            					retvals.push({ id: lst[i], label: lst[i], value: lst[i] });
                                                            				}
                                                            				return retvals;
                                                            			})(listBrands),
                                                            			minLength: 1,
                                                            			delay: 0,
                                                            		});
                                                            	}
                                                            }, null, function (e) {//function untuk ajax error
                                                            	throw new Error(this.responseText + '\nStatus code :' + this.statusText);
                                                            }, function (e) { window.document.body.style.cursor = 'default'; },//function ajax complete
                                                            null//(parameter tambahan)nggak usah di isi bila tidak perlu(bila mau di isi isi dengan object javascript {key:value}
                                                            );

		};
		function fetchTypeApps(elem) {
			var oriData = JSON.parse(originalData);
			var idAppFKGoods = oriData['header'][0]['idapp_fk_goods'];
			//bikin ajax
			NAAjax.GET("getTypeApps/?" + win.encodeURIComponent("fk_goods") + "=" + win.encodeURIComponent(idAppFKGoods) + "&term=",
                                                            'application/json',//overrideMimeType returned by the server
                                                            function (e) { window.document.body.style.cursor = 'wait'; },
                                                            null,//nggak usah di isi bila tidak perlu
                                                            function (e) {//function executed after data has been returned by server(XHR.onload)
                                                            	var data = JSON.parse(this.responseText);
                                                            	var OListype = listTypeApp.slice();
                                                            	if (data) {
                                                            		//simpen di listType
                                                            		Array.prototype.forEach.call(data, function (item) {
                                                            			if (OListype.indexOf(item.value) < 0) {
                                                            				listTypeApp.push(item.value);
                                                            			}
                                                            		});
                                                            		$(elem).autocomplete({
                                                            			//source: "getTypeApps/?fk_goods=" + win.encodeURIComponent(idAppFKGoods),
                                                            			source: (function (lst) {
                                                            				var retvals = [];
                                                            				for (var i = 0; i < lst.length; i++) {
                                                            					retvals.push({ label: lst[i], value: lst[i] });
                                                            				}
                                                            				return retvals;
                                                            			})(listTypeApp),
                                                            			minLength: 1,
                                                            			delay: 0,
                                                            		});
                                                            	}
                                                            }, null, function (e) {//function untuk ajax error
                                                            	throw new Error(this.responseText + '\nStatus code :' + this.statusText);
                                                            }, function (e) { window.document.body.style.cursor = 'default'; },//function ajax complete
                                                            null//(parameter tambahan)nggak usah di isi bila tidak perlu(bila mau di isi isi dengan object javascript {key:value}
                                                            );

		};
		function showConfirmation(message, title, callbackYess, calBackNO) {
			BootstrapDialog.confirm({
				title: title || NA.common.message.titleInfo,
				message: message,
				type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
				size: BootstrapDialog.SIZE_SMALL,
				animate: false,
				cssClass: 'login-dialog',
				closeByBackdrop: false,
				closeByKeyboard: false,
				closable: false, // <-- Default value is false
				draggable: true, // <-- Default value is false
				btnCancelLabel: 'NO.', // <-- Default value is 'Cancel',
				btnOKLabel: 'Yes.', // <-- Default value is 'OK',
				btnOKClass: 'btn-success', // <-- If you didn't specify it, dialog type will be used,
				callback: function (result) {
					// result will be true if button was click, while it will be false if users close the dialog directly.
					if (result) {
						if (callbackYess) {
							setTimeout(callbackYess(), 500);
						}
						return true;
					}
					else {
						if (calBackNO) {
							setTimeout(calBackNO(), 500);
						}
					}
				},
				onshown: function (dialogRef) {
					var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
					divHeader.style.backgroundColor = 'green';
					NA.common.doc.querySelector('div.bootstrap-dialog-footer-buttons button.btn.btn-success').focus();
				}
			});
		};
		function ShowAlert(message, title, callbackFunc, calbackOnHide) {
			return BootstrapDialog.alert({
				title: title || NA.common.message.titleInfo,
				message: message,
				//size: (function ()
				//{
				//	return (message.length > 200) ? BootstrapDialog.SIZE_NORMAL : BootstrapDialog.SIZE_SMALL
				//})
				size: BootstrapDialog.SIZE_SMALL,
				//animate:false,
				cssClass: 'login-dialog',
				closeByBackdrop: false,
				closeByKeyboard: false,
				type: BootstrapDialog.TYPE_INFO, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
				closable: false, // <-- Default value is false
				draggable: true, // <-- Default value is false
				buttonLabel: 'OK', // <-- Default value is 'OK',
				callback: function (result) {
					// result will be true if button was click, while it will be false if users close the dialog directly.
					if (result) {
						if (callbackFunc) {
							setTimeout(callbackFunc(), 1000);
						}
						return true;
					}
				},
				onshown: function (dialogRef) {
					var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
					divHeader.style.backgroundColor = 'green';
				},
				onhidden: function (dialogRef) {
					if (calbackOnHide) {
						setTimeout(calbackOnHide(), 1000);
					}
				}
			});
		};
		function BindGridHeader(gridData) {
			//if (NA.common.getElementID('jqGrid_NA_F_Goods_Receive')) {
			//	//gridHeader.remove();
			//gridHeader.jqGrid('GridDestroy');
			//	//gridHeader.jqGrid("GridUnload");
			//}
			var AllowEdit = false, AllowDelete = false;
			AllowEdit = NA.Privilege.Permissions.Allow_Edit;
			var grdHeaderID = NA.common.getElementID('gbox_jqGrid_NA_F_Goods_Receive');
			if (grdHeaderID) {
				grdHeaderID.parentNode.removeChild(grdHeaderID);
			}
			if (!NA.common.getElementID('jqGrid_NA_F_Goods_Receive')) {
				var ngridHeader = NA.common.doc.createElement('table');
				ngridHeader.id = 'jqGrid_NA_F_Goods_Receive';
				var divTable = NA.common.getElementID('divTable');
				divTable.appendChild(ngridHeader);
			}
			gridHeader = $("#jqGrid_NA_F_Goods_Receive");
			var widthTable = win.getComputedStyle(NA.common.getElementID('pnlBody')).width;
			//gridTbl.css({ 'overflow': 'auto', 'width': widthTable });
			gridHeader.jqGrid({
				data: gridData,
				loadonce: true,
				datatype: "local",
				//idapp, idpp_fk_goods, goods_desc,economiclife, datereceived, supliername, employee_received, employee_pr, totalpurchase, totalreceived
				colNames: ['idapp', 'idapp_fk_goods', 'refno', 'fk_goods', 'Goods Name', 'economiclife', 'Date Received', 'fk_supplier', 'Suplier Name', 'idapp_fk_receivedby', 'fk_receivedby',
						'Received By', 'idapp_fk_p_r_by','fk_p_r_by','Purchase Request By', 'Total Purchase', 'Total Receieved','descriptions'],
				colModel: [
					{ 'name': 'idapp', hidden: true,key:true },
					{ 'name': 'idapp_fk_goods', hidden: true },
					{ 'name': 'refno', hidden: true },
					{ 'name':'fk_goods',hidden:true},
					{ 'name': 'goods_desc', width: 130, align: 'left', editable: false, sortable: false, autoResizing: { minColWidth: 130 }, },
					{ 'name':'economiclife',hidden: true},
					{
						'name': 'datereceived', width: 110, align: 'center',
						formatter: "date", formatoptions: {
							srcformat: 'Y-m-d',
							newformat: "d F Y",
						},
						autoResizing: { minColWidth: 110 }
					},
					{ 'name': 'fk_supplier', hidden: true },
					{ 'name': 'suppliername', width: 180, editable: false, sortable: false, autoResizing: { minColWidth: 120 }, },
					{ 'name': 'idapp_fk_receivedby', hidden: true },
					{ 'name': 'fk_receivedby', hidden: true },
					{ 'name': 'employee_received', width: 160, editable: false, sortable: false, autoResizing: { minColWidth: 120 }, },
					{ 'name': 'idapp_fk_p_r_by', hidden: true },
					{ 'name': 'fk_p_r_by', hidden: true },

					{ 'name': 'employee_pr', width: 160, editable: false, sortable: false, autoResizing: { minColWidth: 120 }, },
					{
						name: 'totalpurchase', width: 100, editable: false, sortable: false, autoResizing: { minColWidth: 120 }, align: 'right',
					},
                    {
                    	name: 'totalreceived',
                    	width: 100,
                    	sortable: false,
                    	align: 'right',
                    	editable: AllowEdit,
                    	editrules: { required: false },
                    	autoResizing: { minColWidth: 100, },
                    	edittype: 'text',
                    	editoptions: {
                    		placeholder: function () {
                    			if ($(this).val() === '') { return 'enter total received'; }
                    		}, 
                    		autocomplete: 'off',
                    		class: (function () {
                    			if (!AllowEdit) { return 'not-editable-cell'; }
                    			return 'NA-Form-Control';
                    		})(),
                    		dataEvents:[{
                    			type: 'keydown',
                    			fn: function (e) {
                    				var rowID = gridTbl.jqGrid('getGridParam', 'selrow');
                    				var rowHeaderData = gridHeader.jqGrid('getLocalRow', '1');
                    				var ototalReceived = rowHeaderData.totalreceived;
                    				if (e.keyCode === 13 || e.keyCode === 9) {// Enter key || tab:
                    					//check apakah sudah ada row yang di rubah di detail grid
                    					var oriData = JSON.parse(originalData);
                    					var  detailData = gridTbl.jqGrid('getGridParam', 'data');
                    					var hasChangedDetail = NA.common.detectInputChanges(detailData, oriData['detail']);
                    					if (hasChangedDetail) {
                    						ShowAlert('Please save changes before', 'Data has changed !');
                    						return false;
                    					}
                    					//check apakah grid sedang di buka dan ada rowsnya
                    					var reccount = gridTbl.jqGrid('getGridParam', 'reccount') || 0;          					
                    					var totalReceived = $(e.target).val();
                    					var totalPurchase = rowHeaderData.totalpurchase || 0;
                    					var regex = /[0-9]/;
                    					if (!regex.test(totalReceived)) {
                    						NA.NAEvent.preventDefault(e);
                    						ShowAlert('total received can not be less or zero');
                    						return false;
                    					}
                    					if (totalReceived <= 0) { gridHeader.jqGrid('restoreRow', rowID); $(e.target).val(ototalReceived); ShowAlert('total received can not be less or zero'); return false; }
                    					if (totalReceived > totalPurchase) { gridHeader.jqGrid('restoreRow', rowID); $(e.target).val(ototalReceived); ShowAlert('total received can not be more than total purchase'); return false; }
                    					if (reccount > parseInt(totalReceived)) {
                    						//prevent Default
                    						NA.NAEvent.preventDefault(e);
                    						ShowAlert('total item in goods receive detail will be more than total received', NA.common.message.titleError);
                    						gridHeader.jqGrid('restoreRow', rowID);
                    						return false;
                    					}
                    					rowHeaderData.totalreceived = totalReceived;
                    					if (reccount < totalReceived) {
                    						var countAdd = totalReceived - reccount;
                    						for (var i = 0; i < countAdd; i++) {
                    							reccount += 1;
                    							//'idapp', 'fk_appp', 'no', 'BrandName', 'Price/Unit', 'Type', 'Serial Number', 'warranty', 'End of Warranty', 'CreatedBy', 'CreatedDate', 'ModifiedBy', 'ModifiedDate'
                    							var rowData = [{ 'idapp': '', 'fkapp': '', 'no': reccount, 'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false, 'isnew': '1', 'isdeleted': '0','isdirty':'0' }];
                    							gridTbl.jqGrid('addRowData', 'no', rowData, "last");
                    							gridTbl.jqGrid("saveRow", reccount.toString(), {
                    								url: 'clientArray',
                    								restoreAfterError: true,
                    							});
                    						};
                    					}
                    					var oriData = JSON.parse(originalData);
                    					var initFrm = NA.common.getElementID('initFrm');
                    					initFrm.value = JSON.stringify({ 'header': oriData['header'], 'detail': gridTbl.jqGrid('getGridParam', 'data') });
                    					originalData = initFrm.value;
                    					//clear selection
                    					gridHeader.jqGrid('resetSelection');
                    				}
                    				else if (e.keyCode === 27) {//escape
                    					//cancell
                    					gridHeader.jqGrid('restoreRow', rowID); $(e.target).val(ototalReceived)
                    					gridHeader.jqGrid('resetSelection');
                    				}
                    			}
                    		}]
                    	},
                    },
					{'name':'descriptions',hidden:true}
				],
				//cellEdit: (win.status === 'Add'),
				pgbuttons: false,     // disable page control like next, back button
				pgtext: null,         // disable pager text like 'Page 0 of 10'
				viewrecords: true,    // disable current view record text like 'View 1-10 of 100'
				height: '35px',
				rowNum: 1,
				resizeStop: function () {
					var newWidth = this.grid.newWidth, maxIterations = 3, i;
					for (i = 0; i < maxIterations; i++) {
						// resize without shrinking
						$(this).jqGrid("setGridWidth", newWidth + i, false);
						if (this.grid.bDiv.offsetHeight <= this.grid.bDiv.clientHeight) {
							break;
						}
					}
				},
				ondblClickRow: function (rowId, iRow, iCol, e) {

					//check gridtbl
					if (NA.common.getElementID('gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail')) {
						//check recourd count
						var recCount = gridTbl.jqGrid('getGridParam', 'reccount');
						if (recCount > 0) {
							//check data
							var detailData = gridTbl.jqGrid('getGridParam', 'data');
							var oriData = JSON.parse(originalData);
							if (NA.common.detectInputChanges(detailData, oriData['detail'])) {
								var rows = gridTbl.getDataIDs();
								for (var i = 0; i < recCount; i++) {
									var row = gridTbl.jqGrid('getLocalRow', rows[i]);
									var rowID = rows[i];
									if (row['isdeleted'] === '1') {
										gridHeader.jqGrid('restoreRow', rowID); return false;
									}
								}
							}
						}
					}
					//The index of the row (iRow) you can get using rowIndex property of the DOM object which represent ther row <tr>. So you need just get the DOM of the row. If the rowId don't contain any meta-characters you can do just the following

					//var iRow = $('#' + rowId)[0].rowIndex;

					//For the more common case you can use jqID function which escapes the meta-characters if needed:

					//	var iRow = $('#' + $.jgrid.jqID(rowId))[0].rowIndex;
					if (($(gridHeader.jqGrid("getInd", rowId, true)).attr("editable") === "0") || ($(gridHeader.jqGrid("getInd", rowId, true)).attr("editable") === undefined)) {
						if (AllowEdit) {
							gridHeader.jqGrid('editRow', rowId, {
								keys: true,
								url: 'clientArray',
								onerrorfunc: function (rowId) {
									gridHeader.jqGrid('restoreRow', rowId);
									ShowAlert('Please enter required data'); win.document.body.style.cursor = 'default';
									return false;
								},
								restoreAfterError: true,
							});
						}
					}
					//$(e.target).focus();

				},
				cellEdit: false,
				forceFit: true,
				width: 'inherit',
				toolbar: false,
				scrollrows: false,
				hidegrid: true,
				autoResizing: { compact: true, resetWidthOrg: true },
				autoResizable: true,
				//sortname: null,
				//sortorder: null,
				iconSet: "fontAwesome",
				caption: "Header goods Receive",
				shrinkToFit: false,
				viewPagerButtons: false,
			});

			//set width jangan inherit
			var elContent = NA.common.qs('div.content'), widthContent = elContent.clientWidth;
			$("div#gbox_jqGrid_NA_F_Goods_Receive, div#gview_jqGrid_NA_F_Goods_Receive, div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv").css({
				'width': widthContent + 'px'
			});
			$('div.row').css({'margin-right': '-40px','margin-left': '-19px'});
		};
		Array.prototype.sortBy = function (p) {
			return this.slice(0).sort(function (a, b) {
				return (a[p] > b[p]) ? 1 : (a[p] < b[p]) ? -1 : 0;
			});
		}

		//#region ===================Example / Usage==========================

		//objs = [{ age: 44, name: 'vinay' }, { age: 24, name: 'deepak' }, { age: 74, name: 'suresh' }];

		//objs.sortBy('age');
		// Returns
		// [{"age":24,"name":"deepak"},{"age":44,"name":"vinay"},{"age":74,"name":"suresh"}]

		//objs.sortBy('name');
		// Returns
		// [{"age":24,"name":"deepak"},{"age":74,"name":"suresh"},{"age":44,"name":"vinay"}]
		//#endregion ================Example / Usage=====================
		function HasChangedData() {
			//originalData = { 'header': gridHeader.jqGrid('getGridParam', 'data'), 'detail': gridTbl.jqGrid('getGridParam', 'data') };
			//check header
			var headerData = gridHeader.jqGrid('getGridParam', 'data');
			var detailData = gridTbl.jqGrid('getGridParam', 'data');
			//var JSONDetail = JSON.stringify(detailData);
			//var ParseDetail = JSON.parse(JSONDetail);
			var oriData = JSON.parse(originalData);
			//copy array object
			//var copyOri = oriData['detail'].slice(0), copyDetail = ParseDetail.slice(0);
			//sort copy array 
			//remove field yang readonly
			//// idapp, fkapp, 'createdby', 'createddate', 'modifiedby', 'modifieddate', 'HasRef'
			//for (var i = 0; i < copyOri.length; i++) {
			//	delete copyOri[i]['idapp'];
			//	delete copyOri[i]['fkapp'];
			//	delete copyOri[i]['createdby'];
			//	delete copyOri[i]['createddate'];
			//	delete copyOri[i]['modifiedby'];
			//	delete copyOri[i]['modifieddate'];
			//	delete copyOri[i]['HasRef'];

			//};
			//for (var i = 0; i < copyDetail.length; i++) {
			//	delete copyDetail[i]['idapp'];
			//	delete copyDetail[i]['fkapp'];
			//	delete copyDetail[i]['createdby'];
			//	delete copyDetail[i]['createddate'];
			//	delete copyDetail[i]['modifiedby'];
			//	delete copyDetail[i]['modifieddate'];
			//	delete copyDetail[i]['HasRef'];
			//};

			//copyOri.sortBy('no'); copyDetail.sortBy('no');


			//if (NA.common.detectInputChanges(headerData, oriData['header'])) { return true; }
			//else if (NA.common.detectInputChanges(copyDetail, copyOri)) { return true; }
			//if (JSON.stringify(copyDetail).replace(/["]+/g, '') != JSON.stringify(copyOri).replace(/["]+/g, '')) {return true;  }
			for (var i = 0; i < detailData.length; i++) {
				if (detailData[i]['isdirty'] == '1') {
					return true;
				}
			};
			if (headerData[0]['totalreceived'] != oriData['header'][0]['totalreceived']) { return true; }
			return false;
		};
		function isDataChanged(LastSelectRows) {//lastSelectRow di ambil dari jqGrid.getRowdata,formatdate = dd/dd/yy
			try {
				// Allows tricky logic for dirty data, e.g. one may trim spaces etc.
				var oriData = JSON.parse(originalData);
				var rows = oriData['detail'];// di ambil dari geteGridParam(data) --> getLocalRow format date yy-mm-dd
				//find rows with thesame ID
				var LastidNo = LastSelectRows[0]['no'];
				if (LastidNo) {
					for (var i = 0; i < rows.length; i++) {
						if (rows[i]['no'] == LastidNo) {
							//check everycolumns
							//'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '
							if (rows[i]['brandname'] != LastSelectRows[0]['brandname']) { return true; }
							else if (parseFloat(rows[i]['priceperunit']) != parseFloat(LastSelectRows[0]['priceperunit'])) { return true; }
							else if (rows[i]['typeapp'] != LastSelectRows[0]['typeapp']) { return true; }
							else if (rows[i]['serialnumber'] != LastSelectRows[0]['serialnumber']) { return true; }
							else if (parseFloat(rows[i]['warranty']) != parseFloat(LastSelectRows[0]['warranty'])) { return true; }
							var d1 = $.datepicker.parseDate('yy-mm-dd', rows[i]['endofwarranty'].substr(0, 10));
							var d2 = $.datepicker.parseDate('dd/mm/yy', LastSelectRows[0]['endofwarranty']);
							if (d1.getTime() !== d2.getTime()) { return true;}
						}
					}
				}
				return false;
			} catch (e) {
				return true;//karena pasti udah di rubah
			}			
		};

		function GetServerFormatDate(parsedDate) {//dd/mm/yy
			var d = new Date(parsedDate),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

			if (month.length < 2) month = '0' + month;
			if (day.length < 2) day = '0' + day;

			return [year, month, day].join('-');
		};
		function formatDate(theDate) {
			var date = new Date(theDate),
              year = date.getFullYear(),
              month = (date.getMonth() + 1).toString(),
              formatedMonth = (month.length === 1) ? ("0" + month) : month,
              day = date.getDate().toString(),
              formatedDay = (day.length === 1) ? ("0" + day) : day;
			//hour = date.getHours().toString(),
			//formatedHour = (hour.length === 1) ? ("0" + hour) : hour,
			//minute = date.getMinutes().toString(),
			//formatedMinute = (minute.length === 1) ? ("0" + minute) : minute,
			//second = date.getSeconds().toString(),
			//formatedSecond = (second.length === 1) ? ("0" + second) : second;
			return formatedDay + "/" + formatedMonth + "/" + year //+ " " + formatedHour + ':' + formatedMinute + ':' + formatedSecond;
		};
		function ValidateGridDetail(gridTbl) {
			var rows = gridTbl.getDataIDs();
			//columns = ['idapp', 'fkapp', 'no', 'brandname', 'priceperunit', 'typeapp', 'serialnumber', 'warranty', 'endofwarranty', 'createdby', 'createddate', 'modifiedby', 'modifieddate', 'hasref']

			//jika rownumbers:true, multiselect:true or subGrid:true ,jquery ada tambahan 3 column pertama rn,cb,subgrid
			//columnname harus di cek apakah ada di  gridTbl[0].p.colModel
			var columnNames = gridTbl.jqGrid('getGridParam', 'colNames');
			//check existing serialnumber
			var seriaNumbers = [];
			for (i = 0; i < rows.length; i++) {
				var row = gridTbl.jqGrid('getLocalRow', rows[i]);
				var rowID = rows[i];
				var brandname = row['brandname'], typeapp = row['typeapp'], serialnumber = row['serialnumber'],
					priceperunit = row['priceperunit'], warranty = row['warranty'], endofwarranty = row['endofwarranty'];
				//var edited = "0";
				//var ind = gridTbl.getInd(rowID, true);
				//if (ind != false) {
				//	edited = $(ind).attr("editable");
				//}
				//if (edited === "1") {
				//	ShowAlert('Please save data(press tab key) or cancel(press escape key)\nOn the row you adit before Validating', NA.common.message.titleInfo);
				//	return false;
				//}

				//check brandname harus ada
				//type sama serialnumber harus ada
				var hasData = (brandname != '') || (typeapp != '') || (serialnumber.length > 3) || (parseFloat(priceperunit) > 0) || (parseFloat(warranty) > 0) || (endofwarranty != '')
				if (!hasData) { continue; }
				if (brandname.length < 1) {
					ShowAlert('Please enter brand name', NA.common.message.titleInfo,calbackOnHide = function () {
						gridTbl.editRow(rowID, true); //function edit row adalah dispatch event dari row clicked
						$('tr#' + rowID + '>td[aria-describedby*="' + brandname + '"]').focus();
					}); return false;
				}				
				if (typeapp === '' || typeapp.length <= 1) {
					ShowAlert('Please enter type', NA.common.message.titleInfo, calbackOnHide = function () {
						gridTbl.editRow(rowID, true);
						$('tr#' + rowID + '>td[aria-describedby*="' + typeapp + '"]').focus();
					});
					return false;
				}
				if (serialnumber === '' || serialnumber.length <= 3) {
					ShowAlert('Please enter serialnumber', NA.common.message.titleInfo, calbackOnHide = function () {
						gridTbl.editRow(rowID, true);
						$('tr#' + rowID + '>td[aria-describedby*="' + serialnumber + '"]').focus();
					});
					return false;
				}
				serialnumber = serialnumber.toString().toUpperCase();
				if (seriaNumbers.indexOf(serialnumber) > -1) {
					ShowAlert('you enter double serial number'); win.document.body.style.cursor = 'default'
					return false;
				}
				seriaNumbers.push(serialnumber);
				if (typeof priceperunit == 'undefined') {
					priceperunit = 0
				}
				else if (priceperunit.toString() === '') {
					priceperunit = 0
				}
				else if (parseFloat(priceperunit) <= 0) {
					priceperunit = 0
				}
				if (typeof warranty == 'undefined') {
					warranty = 0
				}
				else if (warranty.toString() === '') {
					warranty = 0
				}
				else if (Math.round(warranty) <= 0) {
					warranty = 0
				}

				var hasRef = row.HasRef.valueOf() == true || row.HasRef.valueOf() == 1 || row.HasRef.valueOf() === "true" || row.HasRef.valueOf() === "True" || row.HasRef === "True" || row.HasRef === "true";
				
				if (typeof endofwarranty == 'undefined') {
					endofwarranty = null;
				}
				else if (endofwarranty.toString() === '') {
					endofwarranty = null;
				}
				if (!endofwarranty) {
					ShowAlert('please enter end of warranty'); win.document.body.style.cursor = 'default'
					gridTbl.editRow(rowID, true);
					$('tr#' + rowID + '>td[aria-describedby*="' + endofwarranty + '"]').focus();
					return false;
				}
				if (!hasRef) {
					//gridTbl.jgrid('cellEdit', true);
					gridTbl.jqGrid('setCell', rowID, 'brandname', brandname.toString().toUpperCase());
					// now change the internal local data
					gridTbl.jqGrid('getLocalRow', rowID).brandname = brandname.toString().toUpperCase();
					//SET UPPER CASE FOR All Data
					gridTbl.jqGrid('setCell', rowID, 'typeapp', typeapp.toString().toUpperCase());
					// now change the internal local data
					gridTbl.jqGrid('getLocalRow', rowID).typeapp = typeapp.toString().toUpperCase();

					gridTbl.jqGrid('setCell', rowID, 'serialnumber', serialnumber.toString().toUpperCase());
					// now change the internal local data
					gridTbl.jqGrid('getLocalRow', rowID).serialnumber = serialnumber.toString().toUpperCase();
					gridTbl.jqGrid('setCell', rowID, 'priceperunit', priceperunit);
					// now change the internal local data
					gridTbl.jqGrid('getLocalRow', rowID).priceperunit = priceperunit;
					gridTbl.jqGrid('setCell', rowID, 'warranty', warranty);
					// now change the internal local data
					gridTbl.jqGrid('getLocalRow', rowID).warranty = warranty;

				}
				//  row.colname1; row.colname2;
			}
			////method getRowData
			//var rowData = gridTbl.getRowData(rowId);
			////method for getAllrows In Jquery grid
			//var allRowsInGrid = $('#list4').jqGrid('getGridParam', 'data');
			win.document.body.style.cursor = 'default';
			return true;
		};
		function BindGrid(page,gridData,totalReceiveid) {
			try {

				var AllowEdit = false, AllowDelete = false;
				AllowEdit = NA.Privilege.Permissions.Allow_Edit;
				AllowDelete = NA.Privilege.Permissions.Allow_Delete;
				//get privilege apakah allow edit/insert
				var gridHeaderData = gridHeader.jqGrid('getGridParam', 'data');
				var totalReceived = gridHeaderData[0]['totalreceived'] || 0;
				var idAppFKGoods = gridHeaderData[0]['idapp_fk_goods'];
				var lastsel
				//var widthTable = win.getComputedStyle(NA.common.getElementID('gview_jqGrid_NA_F_Goods_Receive')).width;

				//var viewportSize = NA.common.dialog.getViewportSize();
				//containerDialog.style.maxHeight = viewportSize[1].toString() + 'px';
				//containerDialog.style.overflowY = 'auto';
				//containerDialog.style.overflowX = 'hidden';
				//containerDialog.style.top = '0';
				var NValEndOfWarranty = null;
				//recreate table
				//jqGrid_NA_F_Goods_Receive_Pager_Batch_Detail_Pager
				//if (NA.common.getElementID('jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager')) {
				//	gridPager.remove();
				//	//gridTbl.jqGrid('GridUnload');
				//}
				//if (NA.common.getElementID('jqGrid_NA_F_Goods_Receive_Batch_Detail')) {
				//	gridTbl.remove();
				//}
				//gridTbl.jqGrid('GridDestroy');
				var divTable = NA.common.getElementID('divTableDetail');
				var grdID = NA.common.getElementID('gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail');
				if (grdID) {
					grdID.parentNode.removeChild(grdID);
				}
				if (!NA.common.getElementID('jqGrid_NA_F_Goods_Receive_Batch_Detail')) {
					var ngridTbl = NA.common.doc.createElement('table');
					ngridTbl.id = 'jqGrid_NA_F_Goods_Receive_Batch_Detail';
					divTable.appendChild(ngridTbl);
				}
				if (!NA.common.getElementID('jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager')) {
					var ngridPager = NA.common.doc.createElement('div');
					ngridPager.id = 'jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager';
					divTable.appendChild(ngridPager);
				}
				gridTbl = $("#jqGrid_NA_F_Goods_Receive_Batch_Detail"); gridPager = $('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager');
				gridTbl.jqGrid({
					data: gridData,
					processing: true,
					loadonce: true,
					//cellsubmit: 'clientArray',
					editurl: 'clientArray',
					datatype: "local",//column idapp, fkapp.no,'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false,'isnew','isdirty'
					colNames: ['idapp', 'fkapp', 'NO', 'BrandName', 'Price/Unit', 'Type', 'Serial Number', 'warranty', 'End of Warranty', 'CreatedBy', 'CreatedDate', 'ModifiedBy', 'ModifiedDate', 'HasRef', 'isnew','isdeleted','isdirty'],
					colModel: [
						{ name: 'idapp', hidden: true },
						{ name: 'fkapp', hidden: true },
						{ name: 'no', key: true, width: 40, align: 'right', sortable: true, sorttype: "number",editable: false, },

						//#region========================BRAND NAME ================================================================
						{

							name: 'brandname', width: 200, align: 'left', sortable: true,
							editable: AllowEdit,
							editrules: { required: false },
							autoResizing: { minColWidth: 140, },
							edittype: 'text',
							editoptions: {
								dataInit: function (elem) {
									fetcBrands.call(this, elem, "brandname");
								}, placeholder: function () {
									if ($(this).val() === '') { return 'Choose if exists'; }

								}, title: 'Avoid mised-typing brand name !', class: 'NA-Form-Control',
								autocomplete: 'off',
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								dataEvents: [{
									type: 'keydown',//https://css-tricks.com/snippets/javascript/javascript-keycodes/
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return; }
										var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
										var rowData = gridTbl.jqGrid('getLocalRow', rowId);
										var hasRef = rowData.HasRef.valueOf === true || rowData.HasRef.valueOf == 1 || rowData.HasRef.valueOf === 'true' || rowData.HasRef.valueOf === "True";
										if (hasRef) {
											NA.NAEvent.preventDefault(e); return false;
										}
										if (e.keyCode === 9) {  // tab
											var value = $(e.target).val();
											if (value == '') {
												ShowAlert('Please enter brandname'); return;
											}
											if (listBrands.indexOf(value) <= -1) {
												listBrands.push(value);
											}
										}
									}
								}
								]
							},
						},
						//#endregion========================END BRAND NAME ================================================================

						//#region========================Price Per Unit ================================================================
						{
							name: 'priceperunit', width: 120, sortable: true, align: 'right',
							editable: AllowEdit,
							edittype: 'text',
							template: 'number',
							sorttype: "number",
							sortable: true,
							editrules: {
								required: false,
								integer: false,
							},
							autoResizing: { minColWidth: 140, },
							editoptions: {
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								autocomplete: 'off',
								patern: '^[0-9]+([\.,][0-9]+)?$',
								step: 'any',
								tittle: 'Please enter valid value',
								placeholder: function () {
									if ($(this).val() <= 0 || $(this).val() === '' || $(this).val() <= 0) { return NA.common.FormatNumber(0, 2, '.'); }
								},
								dataEvents: [{
									type: 'keydown',
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return false; }
										var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
										var rowData = gridTbl.jqGrid('getLocalRow', rowId);
										var hasRef = rowData.HasRef.valueOf === true || rowData.HasRef.valueOf == 1 || rowData.HasRef.valueOf === "true" || rowData.HasRef.valueOf === "True";
										if (hasRef) {
											NA.NAEvent.preventDefault(e); return;
										}
										if (NA.common.numberInput(e)) {
											if (e.keyCode === 9) {  // tab
												value = $(e.target).val();
												if (isNaN(value)) {
													ShowAlert('Please enter number', NA.common.message.titleInfo,calbackOnHide = function () {
														$(e.target).focus(); $(e.target).select();
													});
													return false;
												}
												if (!value.match(/^\d+(.|,)\d+$/)) {
													ShowAlert('can not enter negatif number', NA.common.message.titleInfo, calbackOnHide = function () {
														$(e.target).focus(); $(e.target).select();
													});
													return false;
												}
											}
										}
									}
								}]
							},
							defaultValue: '',
							formatter: 'number',
							formatoptions: { decimalSeparator: ",", thousandsSeparator: ".", reformatAfterEdit: true },
						},
						//#endregion========================END Price Per Unit ================================================================

						//#region========================typeapp================================================================
						{
							name: 'typeapp', width: 120, align: 'left',
							editable: AllowEdit,
							edittype: 'text',
							editrules: { required: false },
							editoptions: {
								dataInit: function (elem) {
									fetchTypeApps.call(this, elem, "typeapp");
								},
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								autocomplete: 'off',
								placeholder: function () {
									if ($(this).val() === '') { return 'type of brand'; }
								},
								dataEvents: [{
									type: 'keydown',
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return false; }
										var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
										var rowData = gridTbl.jqGrid('getLocalRow', rowId);
										var hasRef = rowData.HasRef.valueOf === true || rowData.HasRef.valueOf == 1 || rowData.HasRef.valueOf === "true" || rowData.HasRef.valueOf === "True";
										if (hasRef) {
											NA.NAEvent.preventDefault(e); return;
										}
										if (e.keyCode === 9) {  //tab
											var value = $(e.target).val();
											if (value == '') {
												ShowAlert('Please enter type of goods'); return;
											}
											if (listTypeApp.indexOf(value) <= -1) {
												listTypeApp.push(value);
											}
										}
									}
								}]
							},
							autoResizing: { minColWidth: 80, },
						},
						//#endregion========================END typeapp ================================================================

						//#region======================== serialnumber ================================================================
						{
							name: 'serialnumber', width: 200, align: 'left',
							editable: AllowEdit,
							edittype: 'text',
							editrules: { required: false, },
							editoptions: {
								defaultValue: 'N/A',
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								autocomplete: 'off',
								placeholder: function () {
									if ($(this).val() === '') { return 'serial number/Service tag'; }
								},
								dataEvents: [{
									type: 'keydown',
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return false; }
										if (e.keyCode === 9) {  //tab										
											var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
											var rowData = gridTbl.jqGrid('getLocalRow', rowId);
											var value = $(e.target).val();
											if (value === '') {
												ShowAlert('Please enter serial number'); return;
											}
											//gridTbl.jqGrid('getLocalRow', rowId).endofwarranty
											NAAjax.POST('HasExistSN/', JSON.stringify({ 'SN': value }), 'application/x-www-form-urlencoded', 'application/json',
											function () { win.document.body.style.cursor = 'wait' }, null,//Before send
											function () { //onload
												if (this.status === 200) {
													var result = JSON.parse(this.responseText);
													if (result.message) {
														ShowAlert('Serial Number has existed', NA.common.message.existsData,calbackOnHide = function () {
															gridTbl.setSelection(rowId, false);
															win.document.body.style.cursor = 'default';
														}); throw Error('');
													}
												}
											}, null,
											function () {//onerror
												win.document.body.style.cursor = 'default'; XhrError(NAAjax.XHR); throw Error('');
											}, function () { win.document.body.style.cursor = 'default'; });
											//check doubel data serial number
											var seriaNumbers = [];
											var rows = gridTbl.getDataIDs();
											for (i = 0; i < rows.length; i++) {
												var row = gridTbl.jqGrid('getLocalRow', rows[i]);
												var serialNumber = row['serialnumber'];
												if (serialNumber === '') { continue; }
												serialNumber = serialNumber.toString().toUpperCase();
												if (seriaNumbers.indexOf(serialNumber) > -1) {
													ShowAlert('you have entered double serial number');
													//restoreCell
													gridTbl.jqGrid('restoreCell', i, 9, true);
													win.document.body.style.cursor = 'default'
													return false;
												}
												seriaNumbers.push(serialNumber);
											}
										}
									}
								}
								]
							},
							autoResizing: { minColWidth: 100, },
						},
						//#endregion======================== END serialnumber ================================================================

						//#region======================== warranty ================================================================
						{
							name: 'warranty', width: 100, align: 'left',
							editable: AllowEdit,
							edittype: 'text',
							template: 'number',
							editrules: { required: (function () { return NA.Privilege.IsAdmin; })(), integer: false, required: false },
							autoResizing: { minColWidth: 100, },
							editoptions: {
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								patern: '^[0-9]+([\.,][0-9]+)?$',
								step: 'any', tittle: 'Year warranty',
								placeholder: function () {
									if ($(this).val() <= 0 || $(this).val() === '') { return NA.common.FormatNumber(0, 2, '.'); }
								},
								dataEvents: [{
									type: 'keydown',
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return false; }
										if (e.keyCode === 9) {// tab
											var dtReceived = gridHeaderData[0]['datereceived'];
											var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
											var rowData = gridTbl.jqGrid('getLocalRow', rowId);
											var hasRef = rowData.HasRef.valueOf === true || rowData.HasRef.valueOf == 1 || rowData.HasRef.valueOf === "true" || rowData.HasRef.valueOf === "True";
											if (hasRef) {
												NA.NAEvent.preventDefault(e); return;
											}
											if (!NA.common.numberInput(e)) {
												ShowAlert('Please enter number', NA.common.message.titleInfo,calbackOnHide =  function () {
													$(e.target).focus(); $(e.target).select();
												});
												return false;
											}
											value = $(e.target).val();
											if (isNaN(value)) {
												ShowAlert('Please enter number', NA.common.message.titleInfo, calbackOnHide = function () {
													$(e.target).focus(); $(e.target).select();
												});
												return false;
											}
											var modVal = (value % 1).toFixed(2);//modulus value decimal number
											var intVal = Math.round(value) - Math.round(modVal);

											//var dtReceived = gridHeaderData[0]['datereceived'];
											if (dtReceived === '') {
												ShowAlert('Please enter date received first', NA.common.message.titleInfo);
												return false;
											}
											FDate = $.datepicker.parseDate("yy-mm-dd", dtReceived.substr(0, 10))
											//var NmodVal = parseFloat(modVal) * 12;
											//var NM = dtReceived.getMonth();
											//NM = parseInt(NM) + parseInt(NmodVal) + (intVal * 12);
											NewVal = (intVal * 365) + (parseFloat(modVal) * 365);
											var NDate = new Date(FDate.getFullYear(), FDate.getMonth(), FDate.getDate() + NewVal);
											NValEndOfWarranty = NDate;
											var dtStr = formatDate(NDate)
											var $tr = $(e.target).closest("tr.jqgrow");
											rowId = $tr.attr("id");
											//var iCol = getColumnSrcIndexByName(gridTbl, 'warranty');
											var $td = $tr.find(">td:nth-child(9)");
											//and to change the value of the cell you can use
											$td.find("input").val(dtStr);
											//gridTbl.jqGrid("editCell", $('#' + rowId)[0].rowIndex, 7, true);
											//gridTbl.jqGrid('getRowData', rowId, 'endofwarranty', dtStr);
											//gridTbl.jqGrid('setCell', rowId, 'endofwarranty', dtStr);
											// now change the internal local data
											rowData = gridTbl.jqGrid('getRowData', rowId)
											rowData.endofwarranty = GetServerFormatDate(NDate);
											//gridTbl.jqGrid('setRowData', rowId, rowData);
											//1_endofwarranty
											//$("#" + $.jgrid.jqID(gridTbl) + '_' + 'endofwarranty').val(dtStr);
											return true;
										}
									}
								}]
							},
							defaultValue: '',
							formatter: 'number',
							formatoptions: { decimalSeparator: ",", thousandsSeparator: ".", reformatAfterEdit: true },
						},
						//#endregion======================== END warranty ================================================================

						//#region======================== endofwarranty ================================================================
						{
							name: 'endofwarranty', width: 120, align: 'left', 'index': 'endofwarranty', sortable: true,
							editable: AllowEdit,
							//datefmt: 'd/m/Y',
							sorttype:'date',
							editoptions: {
								class: (function () {
									if (!AllowEdit) { return 'not-editable-cell'; }
									return 'NA-Form-Control';
								})(),
								dataInit: function (elem, options) {
									var dtReceived = gridHeaderData[0]['datereceived'], MaxMonth = 60;
									if (dtReceived === '') {
										ShowAlert('Please enter date received first', NA.common.message.titleInfo,calbackOnHide = function () {
											NA.common.getElementID('id_datereceived').focus();
											$(elem).val('');
											return false;
										});
									}
									var economiclife = gridHeaderData['economiclife'];
									if (economiclife !== '') {
										maxMonth = parseInt(economiclife) * 12;
									}
									$(elem).datepicker({
										dateFormat: 'dd/mm/yy',
										autoSize: true,
										changeYear: true,
										changeMonth: true,
										beforeShowDay: $.datepicker.noWeekends,
										minDate: (function (g, dtrec) {
											var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
											var EndOfWarranty = gridTbl.jqGrid('getLocalRow', rowId).endofwarranty;
											return new Date(EndOfWarranty);
											//get date datereceived
										})(win, dtReceived),
										maxDate: NA.common.addMonths(dtReceived, maxMonth),
									});
								},
								dataEvents: [{
									type: 'keydown',
									fn: function (e) {
										if (!AllowEdit) { NA.NAEvent.preventDefault(e); return false; }
										if (e.keyCode === 9) {
											if (!$.datepicker.parseDate('dd/mm/yy', $(e.target).val())) {
												ShowAlert('Please enter date with format dd/mm/yyyy', NA.common.message.titleInfo,calbackOnHide = function () {
													$(e.target).focus(); $(e.target).Select();
												});
												NA.NAEvent.preventDefault(e); return false;
											}
											var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
											var currentRowId = $('#' + rowId)[0].rowIndex
											var nextRow = parseInt(currentRowId) + 1;

											$('#' + currentRowId + '_endofwarranty').blur();

											gridTbl.jqGrid("saveRow", rowId, {
												url: 'clientArray',
												restoreAfterError: true,
											});
											//var jqGrid('getGridParam', 'selarrrow');

											var curRow = gridTbl.jqGrid('getLocalRow', rowId);
											var curRows = []; curRows.push(curRow);
											if (isDataChanged(curRows)) {
												gridTbl.jqGrid('getLocalRow', rowId).isdirty = '1';
											}
											gridTbl.jqGrid('editRow', nextRow, {
												keys: false,
												url: 'clientArray',
												//oneditfunc: function (rowId) {
												//    ShowAlert('edit');
												//},
												onerrorfunc: function (rowId) {
													ShowAlert('Please enter required data'); win.document.body.style.cursor = 'default';
													return false;
												},
												restoreAfterError: true,
											});
											$('#' + nextRow + '_brandname').select();
										}
									}
								}]
							},
							editrules: {
								date: true,
								required: false
							},
							formatter: "date", formatoptions: {
								srcformat: 'Y-m-d',
								newformat: "d/m/Y",
								//reformatAfterEdit: (win.status === 'Edit'),
								reformatAfterEdit: true
							},/*  */
						},
						//#endregion======================== END endofwarranty ================================================================

						//#region===================== other fields==========================
						{
							name: 'createdby', width: 100, align: 'left',
							hidden: //(function () {
								//return (win.status === 'Open')
							//})()
							true,
							editable: false,
							cellEdit: false,
							autoResizing: { minColWidth: 100, },
							editoptions: {
								defaultValue: (function () { return NA.Privilege.UserName; })(),
								class: 'NA-Form-Control',
							},
						},
						{
							name: 'createddate', width: 100, align: 'left',
							hidden: //(function () {
								//return (win.status === 'Open')
							//})()
							true,
							editable: false,
							cellEdit: false,
							autoResizing: { minColWidth: 100, },
							editoptions: {
								class: 'NA-Form-Control',
							},
							formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' }
						},
						{
							name: 'modifiedby',
							hidden: //(function () {
								//return ((win.status === 'Open' || win.status === 'Edit') && (NA.Privilege.IsAdmin === true))
				//		    })()
							true,
							editable: false,
							cellEdit: false,
							autoResizing: { minColWidth: 100, },
							editoptions: {
								defaultValue: (function () { return NA.Privilege.UserName; })(),
								class: 'NA-Form-Control',
							},
						},
						{
							name: 'modifieddate', width: 100, align: 'left',
							hidden: //(function () {
							   // return ((win.status === 'Open' || win.status === 'Edit') && (NA.Privilege.IsAdmin === true))
							//})(),
							true,
							editable: false,
							cellEdit: false,
							autoResizing: { minColWidth: 100, },
							editoptions: {
								class: 'NA-Form-Control',
							},
							formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' }
						},
						{
							name: 'HasRef', hidden: true
						},
						{ name: 'isnew', hidden: true },
						{ name: 'isdeleted', hidden: true },
						{ name: 'isdirty',hidden:true}
						//#endregion======================================================
					],
					//cellEdit: (win.status === 'Add'),
					pgbuttons: false,     // disable page control like next, back button
					pgtext: null,         // disable pager text like 'Page 0 of 10'
					viewrecords: true,    // disable current view record text like 'View 1-10 of 100'
					height: (function () {
						var eLogHeight = win.getComputedStyle(NA.common.getElementID('EventLogs')).height, mcontainerDetHeight = win.getComputedStyle(NA.common.qs('div.row.row_RBD')).height;
						return (parseFloat(eLogHeight.replace('px', '')) - parseFloat(mcontainerDetHeight.replace('px', '')) - 115).toString() + 'px';
					})(),
					rowNum: (function () {
						var elTotalReceived = gridHeaderData[0]['totalreceived'];
						return parseInt(elTotalReceived);
					})(),
					resizeStop: function () {
						var newWidth = this.grid.newWidth, maxIterations = 3, i;
						for (i = 0; i < maxIterations; i++) {
							// resize without shrinking
							$(this).jqGrid("setGridWidth", newWidth + i, false);
							if (this.grid.bDiv.offsetHeight <= this.grid.bDiv.clientHeight) {
								break;
							}
						}
					},
					beforeSelectRow: function (id) {
						if (!AllowEdit) {
							return false;
						}
						var savedRowInfos = gridTbl.jqGrid("getGridParam", "savedRow"),
						editingRowId = savedRowInfos == null || savedRowInfos.length < 1 ?
							null : savedRowInfos[0].id;

						if (editingRowId != null && editingRowId !== id) {
							if (isDataChanged(savedRowInfos)) {
								gridTbl.jqGrid("getLocalRow", editingRowId).isdirty = '1';
								gridTbl.jqGrid("saveRow", editingRowId, {
									url: 'clientArray',
									restoreAfterError: true,
									//'extraparam': { IsDirty: "True" }
								});
							}
						}
						return true; // allow selection
					},
					onSelectRow: function (id) {
						//http://www.ok-soft-gmbh.com/jqGrid/NonEditableCellsDynamic.htm
						if (AllowEdit) {
							if (id && id !== lastsel) {
								if (typeof lastsel != 'undefined') {
									//if (isDataChanged(LastRowData)) {
									//	//savedulu datanya
									//	gridTbl.jqGrid("saveRow", lastsel, {
									//		url: 'clientArray',
									//		restoreAfterError: true
									//	});
									//	gridTbl.jqGrid('getLocalRow', lastsel).isdirty = '1';
									//} else {
									//	gridTbl.jqGrid('restoreRow', lastsel);
									//}
									gridTbl.jqGrid('restoreRow', lastsel);
									//check data original
									var LastRowData = gridTbl.jqGrid('getRowData', lastsel);
									var detailData = gridTbl.jqGrid('getGridParam', 'data'),
									 NewRowData = gridTbl.jqGrid('getLocalRow', id);
									var hasRef = NewRowData.HasRef;
									if (hasRef == true ||  hasRef == 'True' || hasRef == 'true' || hasRef == "1") { return false; }
									if (parseInt(lastsel) <= parseInt(id)) {
										for (var i = 0; i < detailData.length; i++) {
											if (detailData[i].no == NewRowData.no) {
												//test
												if (NewRowData.brandname == detailData[i].brandname && (NewRowData.warranty == detailData[i].warranty || parseFloat(NewRowData.warranty) <= 0) && NewRowData.typeapp == detailData[i].typeapp) {
													//data di anggap kosong isi defaultvalue
													//            //isi default newRow
													//            //' 'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false,'isnew'
													//NewRowData = gridTbl.jqGrid('getLocalRow', id);
													if (typeof LastRowData != 'undefined' && LastRowData) {
														if ((LastRowData.brandname != detailData[i].brandname) && (LastRowData.warranty != detailData[i].warranty || parseFloat(LastRowData.warranty) > 0) && (LastRowData.typeapp != detailData[i].typeapp)) {

															NewRowData.brandname = LastRowData.brandname;
															NewRowData.typeapp = LastRowData.typeapp;
															NewRowData.warranty = LastRowData.warranty;
															NewRowData.priceperunit = LastRowData.priceperunit;
															var FDate = $.datepicker.parseDate('dd/mm/yy', LastRowData.endofwarranty);
															var dtStr = formatDate(FDate)

															//var $tr = $(e.target).closest("tr.jqgrow");
															//rowId = $tr.attr("id");

															////The $tr represents the jQuery wrapper of the DOM of <tr>. So to get the <td> cell for 'paidHour' you can use

															//var iCol = getColumnSrcIndexByName(gridTbl, 'warranty');
															//var $td = $tr.find(">td:nth-child(" + (iCol + 2) + ")");

															////and to change the value of the cell you can use

															//$td.find("input").val(dtStr);

															NewRowData.endofwarranty = LastRowData.endofwarranty;
															NewRowData.isdirty = '1';
															gridTbl.jqGrid('setRowData', id, NewRowData);
															gridTbl.jqGrid("saveRow", id, {
																url: 'clientArray',
																restoreAfterError: true
															});
															//push listtypeapps
															if (listTypeApp.indexOf(NewRowData.typeapp) < 0) {
																listTypeApp.push(NewRowData.typeapp);
															}
															if (listBrands.indexOf(NewRowData.brandname) < 0) {
																listBrands.push(NewRowData.brandname);
															}
														}
													}
													break;
												}
											}
										}
									}
								}
								var hasRef = gridTbl.jqGrid('getLocalRow', id).HasRef;
								if (hasRef == true || hasRef == 'True' || hasRef == 'true' || hasRef == "1") { return false; }
								gridTbl.jqGrid('editRow', id, {
									keys: true,
									url: 'clientArray',
									aftersavefunc: function (curRowid, response) {
										//var $tr = $('tr#' + curRowid);
										//var iCol = getColumnSrcIndexByName(gridTbl, 'warranty');
										//var $tdWar = $tr.find(">td:nth-child(" + (iCol + 1) + ")");
										var LastRowData = gridTbl.jqGrid('getLocalRow', curRowid);
										var warranty = LastRowData.warranty;
										if (warranty) {
											if (!isNaN(warranty)) {
												if (parseFloat(warranty) > 0) {
													//isi column endofwarranty
													var dtReceived = gridHeaderData[0]['datereceived'];
													var modVal = (warranty % 1).toFixed(2);//modulus value decimal number
													var intVal = Math.round(warranty) - Math.round(modVal);
													var FDate = $.datepicker.parseDate("yy-mm-dd", dtReceived.substr(0, 10))
													var NewVal = (intVal * 365) + (parseFloat(modVal) * 365);
													var NDate = new Date(FDate.getFullYear(), FDate.getMonth(), FDate.getDate() + NewVal);
													//$('#' + curRowid + '_endofwarranty').val(dtStr);
													LastRowData.endofwarranty = NDate;
													gridTbl.jqGrid('setRowData', curRowid, LastRowData)													
													gridTbl.jqGrid("saveRow", curRowid, {
														url: 'clientArray',
														restoreAfterError: true,
													});
													LastRowData.isdirty = '1';
													if (listTypeApp.indexOf(LastRowData.typeapp) < 0) {
														listTypeApp.push(LastRowData.typeapp);
													}
													if (listBrands.indexOf(LastRowData.brandname) < 0) {
														listBrands.push(LastRowData.brandname);
													}
													return true;
												}
											}
										}
									},
									onerrorfunc: function (rowId) {
										ShowAlert('Please enter required data'); win.document.body.style.cursor = 'default';
										return false;
									},
									restoreAfterError: true,
								});
								lastsel = id;
							}
							else {
								if (typeof lastsel != 'undefined') {
									gridTbl.jqGrid('restoreRow', lastsel);
								}
							}
						}
					},
					ondblClickRow: function (rowid, iRow, iCol, e) {

						//The index of the row (iRow) you can get using rowIndex property of the DOM object which represent ther row <tr>. So you need just get the DOM of the row. If the rowId don't contain any meta-characters you can do just the following

						//var iRow = $('#' + rowId)[0].rowIndex;

						//For the more common case you can use jqID function which escapes the meta-characters if needed:

						//	var iRow = $('#' + $.jgrid.jqID(rowId))[0].rowIndex;
						var hasRef = gridTbl.jqGrid('getLocalRow', rowid).HasRef; if (hasRef == true || hasRef == 'True' || hasRef == 'true' || hasRef == "1") { return false; }
						if ($(gridTbl.jqGrid("getInd", rowid, true)).attr("editable") === "0" || $(gridTbl.jqGrid("getInd", rowid, true)).attr("editable") === undefined) {
							if (AllowEdit) {

								gridTbl.jqGrid('editRow', rowid, {
									keys: true,
									url: 'clientArray',
									aftersavefunc: function (curRowid, response) {
										//var $tr = $('tr#' + curRowid);
										//var iCol = getColumnSrcIndexByName(gridTbl, 'warranty');
										//var $tdWar = $tr.find(">td:nth-child(" + (iCol + 1) + ")");
										var dtReceived = gridHeaderData[0]['datereceived'];
										var LastRowData = gridTbl.jqGrid('getLocalRow', curRowid);
										var warranty = LastRowData.warranty;
										if (warranty) {
											if (!isNaN(warranty)) {
												if (parseFloat(warranty) > 0) {
													//isi column endofwarranty														
													var modVal = (warranty % 1).toFixed(2);//modulus value decimal number
													var intVal = Math.round(warranty) - Math.round(modVal);
													var FDate = $.datepicker.parseDate('yy-mm-dd', dtReceived.substr(0, 10));
													var NewVal = (intVal * 365) + (parseFloat(modVal) * 365);
													var NDate = new Date(FDate.getFullYear(), FDate.getMonth(), FDate.getDate() + NewVal);
													LastRowData.endofwarranty = NDate;
													LastRowData.isdirty = '1';
													gridTbl.jqGrid('setRowData', curRowid, LastRowData);
													gridTbl.jqGrid("saveRow", curRowid, {
														url: 'clientArray',
														restoreAfterError: true,
													});
													if (listTypeApp.indexOf(LastRowData.typeapp) < 0) {
														listTypeApp.push(LastRowData.typeapp);
													}
													if (listBrands.indexOf(LastRowData.brandname) < 0) {
														listBrands.push(LastRowData.brandname);
													}
													return true;
												}
											}
										}
									},
									onerrorfunc: function (rowId) {
										ShowAlert('Please enter required data'); win.document.body.style.cursor = 'default';
										return false;
									},
									restoreAfterError: true,
								});
							}
						}
						//$(e.target).focus();
					},
					//inlineNavOptions: {
					//	save: true,
					//	savetext: "Save",
					//	cancel: false,
					//	restoreAfterSelect: false
					//},
					gridview: true,
					//singleSelectClickMode: "",
					//cmTemplate: { autoResizable: true, editable: true },
					autoResizing: { compact: true, resetWidthOrg: true },
					autoResizable: true,
					sortname: "no",
					sortorder: "asc",
					multiSort: true,
					iconSet: "fontAwesome",
					scrollrows: true,
					caption: "Detail goods Receive",
					width: 'inherit',
					shrinkToFit: false,
					restoreAfterSelect: true,
					rowList: [],        // disable page size dropdown
					pgbuttons: false,     // disable page control like next, back button
					pgtext: null,         // disable pager text like 'Page 0 of 10'
					viewrecords: false,    // disable current view record text like 'View 1-10 of 100' 
					viewPagerButtons: false,
					pager: "#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager"
				});
				//if (!NA.common.getElementID('#jqGrid_NA_F_Goods_Receive_Pager_Batch_Detail_Pager')) {

				//}
				gridTbl.navGrid('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager', {
					edit: false, add: false, del: false, search: false, refresh: false,
				}).navButtonAdd('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager', {
					caption: "  Reset ||  ", buttonicon: 'fa-undo', onClickButton: function () {
						var recCount = gridTbl.jqGrid('getGridParam', 'reccount');
						if (recCount > 0) {
							if (HasChangedData()) {
								showConfirmation(NA.common.message.clearData, NA.common.message.confirmInfo, function () {
									var oriData = JSON.parse(originalData), detail = oriData['detail'];
									gridTbl.jqGrid('clearGridData', false);
									gridTbl.jqGrid('setGridParam', {
										processing: true,
										loadonce: true,
										datatype: 'local',
										data: detail,
										page: 1
									});
									var trs = gridTbl.getDataIDs();
									for (var i = 0; i < trs.length; i++) {
										gridTbl.jqGrid('saveRow', i + 1, trs[i]);
									};
								}, null);
							}
							gridTbl.trigger("reloadGrid", [{ page: 1 }]);//.jqGrid('resetSelection');
							//gridTbl.trigger("reloadGrid",[{ page: 1 }]);
							//set original data
							var initFrm = NA.common.getElementID('initFrm');
							initFrm.value = JSON.stringify({ 'header': oriData['header'], 'detail': gridTbl.jqGrid('getGridParam', 'data') });
							originalData = initFrm.value;
						}
					},
					position: "last"
				}).navButtonAdd('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager', {
					caption: "  Validate", buttonicon: "fa-retweet", onClickButton: function (e) {
						return ValidateGridDetail(gridTbl);
					}, position: "last"
				});
				//navButtonAdd('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager', {
				//	caption: "  Add", buttonicon: "fa-plus", onClickButton: function (e) {

				//		//add row data position in last row
				//		var recCount = gridTbl.jqGrid('getGridParam', 'reccount');
				//		if (totalReceived <= 0) { return false; }
				//		if (recCount >= parseInt(totalReceived)) {
				//			ShowAlert('Can not enter extra data over than total received', NA.common.message.titleInfo);
				//			return false;
				//		}
				//		var rowData = [{ 'idapp': '', 'fkapp': '', 'no': recCount + 1, 'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false, 'isnew': '1', 'isdeleted': '0','isdirty':'0' }]
				//		gridTbl.jqGrid('addRowData', 'no', rowData, 'last');
				//		gridTbl.jqGrid('saveRow', (recCount + 1).toString(), {
				//			url: 'clientArray',
				//			restoreAfterError: true,
				//		});
				//		var last_rowid = NA.common.doc.querySelector('#jqGrid_NA_F_Goods_Receive_Batch_Detail tbody:first-child tr.jqglastrow').getAttribute('id');
				//		gridTbl.setSelection(last_rowid, false);
				//		gridTbl.jqGrid('editCell', recCount + 1, 3, true);
				//		return true;

				//	}, position: "last"
				//});
					//.navButtonAdd('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager', {
				//	caption: "  Delete", buttonicon: "fa-window-close", onClickButton: function (e) {
					
				//	}, position: "last"
				//});
				var elDivF = NA.common.doc.querySelector('div#pg_jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager table.ui-pg-table.navtable.ui-common-table tr td:nth-child(1) div.ui-pg-div>span');
				elDivF.removeAttribute('class');
				elDivF.setAttribute('class', 'fa');
				elDivF.classList.add('fa-undo');

				var elDivS = NA.common.doc.querySelector('div#pg_jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager table.ui-pg-table.navtable.ui-common-table tr td:nth-child(2) div.ui-pg-div>span');
				elDivS.removeAttribute('class');
				elDivS.setAttribute('class', 'fa');
				elDivS.classList.add('fa-retweet');

				//var elDivAdd = NA.common.doc.querySelector('div#pg_jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager table.ui-pg-table.navtable.ui-common-table tr td:nth-child(3) div.ui-pg-div>span');
				//elDivAdd.removeAttribute('class');
				//elDivAdd.setAttribute('class', 'fa');
				//elDivAdd.classList.add('fa-plus');

				//var elDivDell = NA.common.doc.querySelector('div#pg_jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager table.ui-pg-table.navtable.ui-common-table tr td:nth-child(4) div.ui-pg-div>span');
				//elDivDell.removeAttribute('class');
				//elDivDell.setAttribute('class', 'fa');
				//elDivDell.classList.add('fa-window-close');
				//set button pagerStyle td tengahnya jadi 300px;
				var $midTd = $('#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager_center');
				if ($midTd) {
					$midTd.css('width', '300px');
				}
				if (AllowEdit) {
					var top_rowid = NA.common.doc.querySelector('#jqGrid_NA_F_Goods_Receive_Batch_Detail tbody:first-child tr.jqgfirstrow').getAttribute('id');
					gridTbl.setSelection(top_rowid, false);
					gridTbl.jqGrid('editCell', 1, 3, true);
				}
				if (AllowDelete) {
					//assign delete key event
					gridTbl.on("keyup", "tr", function (e) {
						//var rowId = parseInt($(this).attr("id")); 
						var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
						if (e.keyCode == 46) {//tombol delete
							if ($(gridTbl.jqGrid("getInd", rowId, true)).attr("editable") === "0" || ($(gridTbl.jqGrid("getInd", rowId, true)).attr("editable") === undefined)) {
								var hasRef = gridTbl.jqGrid('getLocalRow', rowId).HasRef;
								if (hasRef == true ||  hasRef == 'True' || hasRef == 'true' || hasRef == "1") {
									ShowAlert(NA.common.message.canNotDelete, NA.common.message.titleInfo); return false;
								}
								showConfirmation(NA.common.message.confirmDelete, NA.common.message.confirmInfo, function () {
									win.document.body.style.cursor = 'wait';
									var idapp = getGridCellValue(gridTbl, 'idapp');  //deleteDetail
									//gridTbl.delRowData(rowId);
									//if (win.status === 'Edit') {
									//	NAAjax.POST('deleteDetail/', JSON.stringify({ 'idapp': idapp }), 'application/x-www-form-urlencoded', 'application/json',
									//   null, function () { }, function () {
									//   	//rubah totalreceived -1;
									//   	if (this.status == 200) {
									//   		var textStatus = JSON.parse(this.responseText);
									//   		originalData = { 'header': gridHeader.jqGrid('getGridParam', 'data'), 'detail': gridTbl.jqGrid('getGridParam', 'data') };
									//   	} else {
									//   		XhrError(NAAjax.XHR);
									//   	}
									//   }, null, function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; throw new Error(''); });
									//}
									var valTrec = gridHeaderData[0]['totalreceived'];
									valTrec = valTrec - 1;
									valTrec = (valTrec < 0) ? 0 : valTrec;
									//delete di localrow
									gridHeader.jqGrid('setCell', rowId, 'totalreceived', valTrec.toString());
									var rowHeaderData = gridHeader.jqGrid('getLocalRow', '1');
									rowHeaderData.totalreceived = valTrec
									gridTbl.jqGrid('getLocalRow', rowId).isdeleted = '1';
									gridTbl.jqGrid('getLocalRow', rowId).isdirty = '1';
									gridTbl.jqGrid('saveRow', rowId,  {
										url: 'clientArray',
										restoreAfterError: true,
									});
									$("#" + rowId, gridTbl).hide();
									if (valTrec <= 0) {
									    filterToolbar.classList.add('disabled');
									} else { filterToolbar.classList.remove('disabled'); }
									win.document.body.style.cursor = 'default';
								});
							}
							win.document.body.style.cursor = 'default';
							return false;
						}
					});
				}

				var reccount = gridTbl.jqGrid('getGridParam', 'reccount');
				var leftRows = totalReceived - reccount;                    //if total received > recourd count
				//add new row data
				if (leftRows) {
					//createDummyRowData(totalReceived - reccount);
					for (var i = (totalReceived -leftRows)+1; i < totalReceived+1; i++) {
						var rowData = [{ 'idapp': '', 'fkapp': '', 'no': i, 'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false, 'isnew': '1','isdeleted':'0','isdirty':'0' }]
						//dataRows.push(rowData);
						gridTbl.jqGrid('addRowData', 'no', rowData, 'last');
						gridTbl.jqGrid("saveRow", i.toString(), {
							url: 'clientArray',
							restoreAfterError: true,
						});
					}
				}
				gridTbl.css({ 'overflow': 'auto' });

				hasGridDetail = true;

			} catch (e) {
				if (e.message !== '') {
					ShowAlert(e.message);
					console.log(e);
				}
				document.body.style.cursor = 'default';
			};
			var elContent = NA.common.qs('div.content'), widthContent = elContent.clientWidth;
			$("div#jqGrid_NA_F_Goods_Receive_Batch_Detail_Pager,div#gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail, div#gview_jqGrid_NA_F_Goods_Receive_Batch_Detail, div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv").css({
				'width': widthContent + 'px'
			})
			$('div#gview_jqGrid_NA_F_Goods_Receive_Batch_Detail>div.ui-jqgrid-bdiv').css({ 'overflow-y': 'auto' });
		};
		
		function createDummyRowData(intLength) {
			//check datarows di jqgrid
			var DummyData = [];
			for (var i = 0; i < intLength; i++) {
				//'idapp', 'fk_appp', 'no', 'BrandName', 'Price/Unit', 'Type', 'Serial Number', 'warranty', 'End of Warranty', 'CreatedBy', 'CreatedDate', 'ModifiedBy', 'ModifiedDate',isnew
				var rowData = { 'idapp': '', 'fkapp': '', 'no': i + 1, 'brandname': '', 'priceperunit': '', 'typeapp': '', 'serialnumber': '', 'warranty': '', 'endofwarranty': '', 'createdby': '', 'createddate': new Date(), 'modifiedby': '', 'modifieddate': '', 'HasRef': false, 'isnew': '1','isdeleted':'0','isdirty':'0' }
				DummyData.push(rowData);
			};
			return DummyData;
		};
		function showLoading() {
			var container_loading = $('<div class="container-spinner"></div>');
			//$('.login-box').addClass('blur');
			container_loading.spinner({
				color: 'forestgreen',
				strokeWidth: 4,
				radius: 20
			})
			$('div#pnlBody').css({'position':'relative'});
			$('div#pnlBody').append(container_loading);
			container_loading.css({ 'left': '80%','top':'50%','position':'absolute' })
		};
		function closeLoading() {
			$('div.container-spinner').fadeOut(500);
		};
		
		NA.NAEvent.addHandler(txtRefno, 'keydown', function (e) {
			if (e.keyCode == 13) {
				btnFindRefno.click();
			}
		});
		//https://codereview.stackexchange.com/questions/26561/showing-jquery-ui-tooltip-on-focus-of-text-box
		$('#id_refno').tooltip({
			placement: 'top auto',
			trigger: 'manual',
			delay: { "show":300, "hide": 500 },
			//animation:true
		});

		//$("#id_refno").tooltip({
		//	position: {
		//		my: "center bottom",
		//		at: "center top-10",
		//		collision: "none"
		//	},
		//		//placement: 'top auto',
		//		//trigger: 'manual'
		//});
		NA.NAEvent.addHandler(txtRefno, 'input', function () { $('#id_refno').tooltip('hide'); });

		function ShowData() {
			var url = 'getData/?refno=' + win.encodeURIComponent(txtRefno.value)
			NAAjax.GET(url,
				'application/json',
				function () { win.document.body.style.cursor = 'wait', showLoading(); },
				null,
				function (e) {
					//get total received
					try {
						var data = JSON.parse(this.responseText);
						if (data) {
						    if (this.status >= 500) {
						        closeLoading(); setTimeout(function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; }, 500); throw new Error('');
						    }
						    var dataRowHeader = [];
						    //'idapp', 'idapp_fk_goods', 'refno', 'fk_goods', 'Goods Name', 'economiclife', 'Date Received', 'fk_supplier', 'Suplier Name', 'idapp_fk_receivedby', 'fk_receivedby',
						    //'Received By', 'idapp_fk_p_r_by','fk_p_r_by','Purchase Request By', 'Total Purchase', 'Total Receieved','descriptions'
						    dataRowHeader.push({
						        'idapp': data['idapp'], 'idapp_fk_goods': data['idapp_fk_goods'], 'refno': data['refno'], 'fk_goods': data['fk_goods'], 'goods_desc': data['goods_desc'],
						        'economiclife': data['economiclife'], 'datereceived': data['datereceived'], 'fk_supplier': data['fk_supplier'], 'suppliername': data['suppliername'],
						        'idapp_fk_receivedby': data['idapp_fk_receivedby'], 'fk_receivedby': data['fk_receivedby'], 'employee_received': data['employee_received'],
						        'idapp_fk_p_r_by': data['idapp_fk_p_r_by'], 'fk_p_r_by': data['fk_p_r_by'],
						        'employee_pr': data['employee_pr'], 'totalpurchase': data['totalpurchase'], 'totalreceived': data['totalreceived'], 'descriptions': data['descriptions']
						    });
						    BindGridHeader(dataRowHeader);
						    //bind grid
						    var dataDetail = JSON.parse(data['dataForGridDetail']);
						    var totalReceived = parseInt(data['totalreceived']);
						    BindGrid(1, dataDetail, totalReceived);

						    //set original data
						    var initFrm = NA.common.getElementID('initFrm');
						    if (!initFrm) {
						        initFrm = NA.common.doc.createElement('input');
						        initFrm.type = 'hidden';
						        initFrm.id = 'initFrm';
						    }
						    initFrm.value = JSON.stringify({ 'header': gridHeader.jqGrid('getGridParam', 'data'), 'detail': gridTbl.jqGrid('getGridParam', 'data') });
						    originalData = initFrm.value;
						    NA.common.getElementID('mainContainer_Detail').appendChild(initFrm);
						    //check filter

						    var allowSave = (NA.Privilege.Permissions.Allow_Add || NA.Privilege.Permissions.Allow_Delete === true || NA.Privilege.Permissions.Allow_Edit === true);
						    if (allowSave) {
						        btnSave.classList.remove('disabled');
						    }
						    else {
						        btnSave.classList.add('disabled');
						    }
						    var allowDelete = NA.Privilege.Permissions.Allow_Delete;
						    if (allowDelete) {
						        btnDelete.classList.remove('disabled');
						    }
						    else {
						        btnDelete.classList.add('disabled');
						    }
						    //check data
						   
						    if (dataDetail.length <= 0) {
						        btnExport.classList.add('disabled');
						        btnPrint.classList.add('disabled');
						        filterToolbar.classList.add('disabled');
						    }
						    else {
						        btnExport.classList.remove('disabled');
						        btnPrint.classList.remove('disabled');
						        var filterValue = txtSearchMaster.value.trim();
						        if (filterValue.length > 0) {
						            btnSearchMaster.click();
						        }
						        filterToolbar.classList.remove('disablaled');

						    }
						}
						else {
						    closeLoading(); setTimeout(function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; }, 500);
						}
					} catch (e) {
						if (e.message !== '') { ShowAlert(e.message); }
						closeLoading(); win.document.body.style.cursor = 'default';
					}

				}, null, function (e) {//function untuk ajax error
					closeLoading(); throw new Error(this.responseText + '\nStatus code :' + this.statusText);
				}, function (e) {
					closeLoading(); win.document.body.style.cursor = 'default';
					var recCount = gridHeader.jqGrid('getGridParam', 'reccount');

					if (recCount > 0) {
						var trs = gridHeader.getDataIDs();
						var $elmTReceived = $('tr#' + trs[0] + '>td[aria-describedby*="totalreceived"]');
						$elmTReceived.tooltip({
							placement: 'top auto',
							trigger: 'manual',
							delay: { "show": 2000, "hide": 500 },
							//animation:true
						});
						var totalReceived = $('tr#' + trs[0] + '>td[aria-describedby*="totalreceived"]').data('original-title');
						//$elmTReceived. data-title="Enter Reference number to show data to edit to"
						$elmTReceived.data('title', 'double click here to edit and type and press enter key');
						$elmTReceived.data('toggle', 'tooltip');
						var totalPurchase = $('tr#' + trs[0] + '>td[aria-describedby*="totalpurchase"]')[0].title;
						if (parseFloat(totalPurchase) > parseFloat(totalReceived)) {
							//tooltip requiere = 'data-togle' attribute and title
							//disabled element must be set with tab index = 0
							gridHeader.jqGrid('setCell', trs[0], 'totalreceived', '', { tabindex: '0' });
							setTimeout(function () { $elmTReceived.tooltip('show'); }, 5000);
							
						}
					}
				},//function ajax complete
			null//(parameter tambahan)nggak usah di isi bila tidak perlu(bila mau di isi isi dengan object javascript {key:value}
			);
		};

		NA.NAEvent.addHandler(btnFindRefno, 'click', function (e) {
			var hasValue = $('#id_refno').val();
			if (!hasValue) {
				$('#id_refno').tooltip('show');
				return false;
			}
			//cek original

			var initFrm = NA.common.getElementID('initFrm');
			var changedData = false;
			if (initFrm) {
				//get griddata
				if (!NA.common.isObjectEmpty(originalData) || originalData != {}) {
					//var oriData = JSON.parse(originalData);
					if (HasChangedData()) {
						changedData = true;
					}
				}
			}

			if (changedData) {
				if (e.target.dataset.directEventTarget == 'FromCallBack') {//detect if event directly from mousclick/enter keyboard
					ShowData();
				}
				else {
					showConfirmation(NA.common.message.refreshData, NA.common.message.titleInfo,
						function () { ShowData(); });
				}

			}
			else { ShowData(); }
			e.target.dataset.directEventTarget = 'FromClick';//kembalikan ke posisi default
		});

		function handlerSearchInput(event) {
			event = NA.NAEvent.getEvent(event);
			if (event.keyCode === 13 || event.target == btnSearchMaster) {
			    NA.NAEvent.preventDefault(event);
			    SearchBy = NA.common.doc.querySelector('li.dropdown>a#bySearch').textContent.trim();
			    var elSearch = null;
			    var valueKey = txtSearchMaster.value.trim(), f;
			    if (SearchBy.trim() == 'By') {
			        elSearch = listElem[0].firstChild;
			    }
			    else {
			        var listElem = NA.common.doc.querySelector('ul.dropdown-menu.search').children;//return list Element
			        var textToSearch = NA.common.getElementID('bySearch').firstChild.nodeValue;
			        Array.prototype.forEach.call(listElem, function (item) {//buat jadi foreach mesti convert dulu ke array                   
			            if (item.firstChild.textContent === textToSearch) {
			                elSearch = item.firstChild;
			                return;
			            }
			        });
			    }
			    if (!elSearch) { elSearch = listElem[0].firstChild; }
			    if (valueKey.length === 0) {
			        gridTbl[0].p.search = false;
			        $.extend(gridTbl[0].p.postData, { filters: "" });
			    }
			    else {
			        f = { groupOp: '', rules: [] };
			        f.rules.push({ field: elSearch.dataset.column, op: 'cn', data: valueKey });
			        gridTbl[0].p.search = true;
			        $.extend(gridTbl[0].p.postData, { filters: JSON.stringify(f) });
			    }
			    gridTbl.trigger("reloadGrid", [{ page: 1, current: true }]);
			    NA.NAEvent.stopPropagation(event);
			}
			window.document.body.style.cursor = '';
		};
		//function submitSearch(event) {
		//	window.document.body.style.cursor = 'wait';
		//	if (event)
		//		NA.NAEvent.preventDefault(event);
		//	var elementOption = null, columnKey = '', valueKey = '',
        //    elCriteria = null,f = ''//NA.common.doc.querySelector('td.columns select.selectopts.NA-Form-Control option:checked');
        //    valCriteria = 'cn',//elCriteria.nodeValue;
        //    elDataType = '';//elementOption.dataset.dataType;
		//	//criteria = 'like'
		//	//get  ajax with querystring search
		//	//valueKey : valueKey,
		//	//columnKey :columnKey,
		//	//dataType : dataType,
		//	//criteria : criteria,
        //    if (event.target.getAttribute('id') === 'fbox_jqGrid_search' || event.target.getAttribute('id') === 'jqg1' || event.target.parentNode.id === 'fbox_jqGrid_search') {//fbox_jqGrid_search == button search,jqg1 = txtSearch nya
		//		elementOption = NA.common.doc.querySelector('td.columns select.NA-Form-Control option:checked');
		//		columnKey = elementOption.getAttribute('name'), valueKey = NA.common.getElementID('jqg1').value;
		//		elCriteria = NA.common.doc.querySelector('td.operators select.selectopts.NA-Form-Control option:checked');
		//		valCriteria = elCriteria.value;
		//		elDataType = elementOption.dataset.tipe;
		//		switch (valCriteria) {
		//			case "eq": { break; }
		//			case "ne": { break; }
		//			case "bw": { break; }
		//			case "ew": { break; }
		//			case "cn": { break; }
		//			case "in": { break; }
		//			case "ni": { break; }
		//			case "gt": {
		//				var expr = /char/;  // no quotes here
		//				if (expr.test(elDataType)) {
		//					ShowAlert(NA.common.message.unsupportedCriteria, NA.common.message.titleInfo + "(expr for only numeric or date data)");
		//					win.document.body.style.cursor = 'default';
		//					return false;
		//				}
		//				break;
		//			}
		//			case "le": {
		//				var expr = /char/;  // no quotes here
		//				if (expr.test(elDataType)) {
		//					ShowAlert(NA.common.message.unsupportedCriteria, "expr for only numeric or date data");
		//					win.document.body.style.cursor = 'default'; return false;
		//				}
		//				break;
		//			}
		//			case "leq": {
		//				var expr = /char/;  // no quotes here
		//				if (expr.test(elDataType)) {
		//					ShowAlert(NA.common.message.unsupportedCriteria, "expr for only numeric or date data");
		//					win.document.body.style.cursor = 'default'; return false;
		//				}
		//				break;
		//			}
		//			case "gtq": {
		//				var expr = /char/;  // no quotes here
		//				if (expr.test(elDataType)) {
		//					ShowAlert(NA.common.message.unsupportedCriteria, "expr for only numeric or date data");
		//					win.document.body.style.cursor = 'default'; return false;
		//				}
		//				break;
		//			}
		//			case "blg": {
		//				var expr = /char/;  // no quotes here
		//				if (expr.test(elDataType)) {
		//					ShowAlert(NA.common.message.unsupportedCriteria, NA.common.message.titleInfo + "expr for only numeric or date data");
		//					win.document.body.style.cursor = 'default'; return false;
		//				}
		//				break;
		//			}
		//		};
		//	}
		//	else if (event.target == txtSearchMaster || event.target == btnSearchMaster) {
		//		SearchBy = NA.common.doc.querySelector('li.dropdown>a#bySearch').textContent.trim();
		//		valueKey = txtSearchMaster.value.trim();
		//			var elSearch = null;
		//			var listElem = NA.common.doc.querySelector('ul.dropdown-menu.search').children;//return list Element
		//			var textToSearch = NA.common.getElementID('bySearch').firstChild.nodeValue;
		//			if (textToSearch === "CustomSearch") {
		//				ShowAlert("please define column to search"); win.document.body.style.cursor = "default"; return false;
		//			}
		//			Array.prototype.forEach.call(listElem, function (item) {//buat jadi foreach mesti convert dulu ke array                   
		//			    if (item.firstChild.textContent === textToSearch) {
		//			        elSearch = item.firstChild;
		//			        return;
		//			    }
		//			});

		//			if (!elSearch) { elSearch = listElem[0].firstChild; columnKey = elSearch.textContent.toLowerCase(); }
		//			else {
		//				columnKey = elSearch.dataset.column
		//				elDataType = elSearch.dataset.tipe;
        //                //==============jqgrid tidak bisa membedakan datatype semua filter typenya string =============
		//				//switch (elDataType) {
		//				//    case "bigint":
		//				//    case "integer":
		//				//    case "int":
		//				//        {   valueKey = parseInt(valueKey);}
		//				//	case "money":
		//				//	case "float":
		//				//    case "decimal":
		//				//        { valueKey = parseFloat(valueKey);}
		//				//	case "boolean":
		//				//	case "datetime": {
		//				//		if (valueKey.toString().indexOf(',') > -1) {
		//				//			valCriteria = 'in'
		//				//		} else {
		//				//			valCriteria = 'eq';
		//				//		}
		//				//		break;
		//				//	}
		//				//};
		//			}

		//	}
		//	if (valueKey.length === 0) {
		//		gridTbl[0].p.search = false;
		//		$.extend(gridTbl[0].p.postData, { filters: "" });
		//	}
		//	else {
		//		f = { groupOp: '', rules: [] };
		//		//f.rules.push({ field: "name", op: "cn", data: valueKey });
		//		f.rules.push({ field: columnKey, op: valCriteria, data: valueKey });
		//		gridTbl[0].p.search = true;
		//		gridTbl[0].p.searchrules = { integer: true };
		//		$.extend(gridTbl[0].p.postData, { filters: JSON.stringify(f) });
		//	}
		//	gridTbl.trigger("reloadGrid", [{ page: 1, current: true }]);
		//	//SearchData.setValue(valueKey);
		//	//SearchData.setColumnName(columnKey);
		//	//SearchData.setDataType(elDataType)
		//	//SearchData.setCriteria(criteria);
		//	//win.document.body.style.cursor = 'wait';
		//	//LoadData(1);
		//	//win.document.body.style.cursor = 'default';
		//	//grid.setGridParam.trigger("reloadGrid",[{page:1}]);//karena searching harus di set ke page 1
		//};

		//function untuk Reset
		//function submitReset(event) {
		//	window.document.body.style.cursor = 'wait';

		//	gridTbl[0].p.search = false;
		//	$.extend(gridTbl[0].p.postData, { filters: "" });
		//	//var f;
		//	//f = { groupOp: 'OR', rules: [] };
		//	//f.rules.push({ field: "name", op: "cn", data: searchFiler });
		//	//f.rules.push({ field: elSearch, op: 'cn', data: '' });
		//	//gridTbl[0].p.search = true;
		//	//$.extend(gridTbl[0].p.postData, { filters: JSON.stringify(f) });
		//	gridTbl.trigger("reloadGrid", [{ page: 1, current: true }]);
		//	win.document.body.style.cursor = 'default';
		//};
		//window.showDialogCustomSearch = function (event) {
		//	$('div.containerDialog').load("customFilter", function (responseTxt, statusTxt, xhr) {
		//		if (statusTxt == "success") {
		//			$(this).html(responseTxt);
		//			var dialog = NA.common.doc.querySelector('div.containerDialog');
		//			NA.common.getElementID('searchmodfbox').style.display = 'block';
		//			var btnClose = NA.common.doc.querySelector('div#searchhdfbo a.ui-jqdialog-titlebar-close.ui-corner-all'),
        //            txtSearchCustom = NA.common.getElementID('jqg1');
		//			NA.NAEvent.addHandler(btnClose, 'click', function (event) {
		//				closeDialog();
		//			});
		//			var btnFind = NA.common.getElementID('fbox_jqGrid_search');
		//			NA.NAEvent.addHandler(btnFind, 'click', function (event) {
		//				submitSearch(event);
		//				if (event) {
		//					NA.NAEvent.stopPropagation(event);
		//				}
		//			});
		//			var btnReset = NA.common.getElementID('fbox_jqGrid_reset');
		//			NA.NAEvent.addHandler(btnReset, 'click', function (event) {
		//				submitReset(event);
		//				if (event) {
		//					NA.NAEvent.stopPropagation(event);
		//				}
		//			});
		//			NA.NAEvent.addHandler(txtSearchCustom, 'keydown', function (event) {
		//				event = NA.NAEvent.getEvent(event);
		//				if (event.keyCode === 13) {
		//					submitSearch(event);
		//				}
		//				if (event) {
		//					NA.NAEvent.stopPropagation(event);
		//				}
		//			});
		//		}
		//	});
		//};
	
		//=======================handler txt & button Search master keyboard event and click================================        
		NA.NAEvent.addHandler(txtSearchMaster, 'keydown', handlerSearchInput);
		NA.NAEvent.addHandler(btnSearchMaster, 'click', handlerSearchInput);

		NA.Privilege.read_privilege('n_a_goods_receive');
		
		NA.NAEvent.addHandler(btnSave, 'click', function () {
			var allowSave = (NA.Privilege.Permissions.Allow_Add || NA.Privilege.Permissions.Allow_Delete === true || NA.Privilege.Permissions.Allow_Edit === true);
			if (!allowSave) { NA.NAEvent.preventDefault(e); }
			if (HasChangedData()) {
				var oriData = JSON.parse(originalData);
				var headerData = gridHeader.jqGrid('getGridParam', 'data'), detailData = gridTbl.jqGrid('getGridParam', 'data');
				var hasChangedHeader = headerData[0]['totalreceived'] != oriData['header'][0]['totalreceived'];
				var hasChangedDetail =false;
				for (var i = 0; i < detailData.length; i++) {
					if (detailData[i]['isdirty'] == '1') {
						hasChangedDetail = true;
					}
				};
				var validData = ValidateGridDetail(gridTbl);
				if (!validData) { return false; }
				//save data to server
				NAAjax.POST('saveData/', JSON.stringify(
					{ 'headerData': headerData, 'hasChangedHeader': hasChangedHeader, 'dataForGridDetail': detailData, 'hasChangedDetail': hasChangedDetail }),
					'application/x-www-form-urlencoded', 'application/json',
					function () { win.document.body.style.cursor = 'wait'; },
					null,
					function () {
						if (this.status >= 400) {
							closeLoading(); setTimeout(function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; }, 500); throw new Error('');
						}
						else if (this.status == 200) {
							var data = JSON.parse(this.responseText);
							var message = data.message;
							if (message === '__success') {
								//reset status deleted dan isnew
								//var rows = gridTbl.getDataIDs();
								//for (i = 0; i < rows.length; i++) {
								//	var row = gridTbl.jqGrid('getLocalRow', rows[i]);
								//	var brandname = row['brandname'], typeapp = row['typeapp'], serialnumber = row['serialnumber'],
								//		priceperunit = row['priceperunit'], warranty = row['warranty'], endofwarranty = row['endofwarranty'];
								//	var hasData = (brandname != '') || (typeapp != '') || (serialnumber.length > 3) || (parseFloat(priceperunit) > 0) || (parseFloat(warranty) > 0) || (endofwarranty != '')

								//	if (!hasData) { row.isnew = '1'; }
								//	else { row.isnew = '0'; }
								//	row.isdeleted = '0';
								//	row.isdirty = '0';
								//	gridTbl.jqGrid('saveRow', rows[i], {
								//		url: 'clientArray',
								//		restoreAfterError: true,
								//	});
								//}
								//gridHeader.jqGrid('resetSelection');
								//gridTbl.jqGrid('resetSelection');
								////set original data			
								//var initFrm = NA.common.getElementID('initFrm');
								//initFrm.value = JSON.stringify({ 'header': gridHeader.jqGrid('getGridParam', 'data'), 'detail': gridTbl.jqGrid('getGridParam', 'data') });
								//originalData = initFrm.value;
								//ShowAlert(NA.common.message.savingSucces, NA.common.message.titleInfo);
								btnFindRefno.dataset.directEventTarget = "FromCallBack";
								btnFindRefno.click();
							} else {
								XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default';
							}
						}
						else {
							XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default';
						}
					},
					null, function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; },
					function () { win.document.body.style.cursor = 'default'; });
			}
		});

		NA.NAEvent.addHandler(btnDelete, 'click', function () {
			if (!NA.Privilege.Permissions.Allow_Delete) {
				NA.NAEvent.preventDefault(e); return;
			}
			//check rowselect di grid detail
			//var selRowIds = gridHeader.jqGrid("getGridParam", "selarrrow");
			//if ($.inArray(rowId, selRowIds) >= 0) {
			//}
			var rowDetailID = gridTbl.jqGrid('getGridParam', 'selrow'),
				rowHeaderID = gridHeader.jqGrid('getGridParam', 'selrow');
			if (!rowDetailID && !rowHeaderID) {
				return false;
			}
			//var recCount = gridTbl.jqGrid('getGridParam', 'reccount');
			var rowCount = $('#jqGrid_NA_F_Goods_Receive_Batch_Detail tr.jqgrow.ui-row-ltr.ui-widget-content:visible').length;
			if (rowCount <= 0) {
				//check gridHeader
				var rowHeaderID = gridHeader.jqGrid('getGridParam', 'selrow');
				if (!rowHeaderID) {
					return false;
				}
				showConfirmation(NA.common.message.confirmDelete + '\nData will be deleted on database', NA.common.message.confirmInfo, function () {
					//delete header data di database
					var idapp = rowHeaderID.idapp;
					NAAjax.POST('Delete/', JSON.stringify({ 'idapp': idapp }), 'application/x-www-form-urlencoded', 'application/json',
							null,
							function () { win.document.body.style.cursor = 'wait'; },
							function () {
								if (this.status >= 400) {
									closeLoading(); setTimeout(function () { XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default'; }, 500); throw new Error('');
								}
								else if (this.status == 200) {
									var data = JSON.parse(this.responseText);
									var message = data.message;
									if (message === '__success') {
										//remove gridheader
										var grdHeaderID = NA.common.getElementID('gbox_jqGrid_NA_F_Goods_Receive');
										if (grdHeaderID) {
											grdHeaderID.parentNode.removeChild(grdHeaderID);
										}
										//remove grid detail
										var grdID = NA.common.getElementID('gbox_jqGrid_NA_F_Goods_Receive_Batch_Detail');
										if (grdID) {
											grdID.parentNode.removeChild(grdID);
										}
										//matikan tombol save
										btnSave.classList.add('disabled');
										btnDelete.classList.add('disabled');
										btnExport.classList.add('disabled');
										btnPrint.classList.add('disabled');
										filterToolbar.classList.add('disabled');
										var initFrm = NA.common.getElementID('initFrm');
										initFrm.value = JSON.stringify({});
										originalData = initFrm.value;
										win.document.body.style.cursor = 'default';
									} else {
										XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default';
									}
								}
								else {
									XhrError(NAAjax.XHR); win.document.body.style.cursor = 'default';
								}
							});
				});
				return false;
			}
			if (rowDetailID) {
				var gridHeaderData = gridHeader.jqGrid('getGridParam', 'data');
				var hasRef = gridTbl.jqGrid('getLocalRow', rowDetailID).HasRef;
				if (hasRef == 'True' || hasRef == 'true' || hasRef == '1') {
					ShowAlert(NA.common.message.canNotDelete, NA.common.message.titleInfo); return false;
				}
				rowHeaderID = gridHeader.getDataIDs()[0];
				showConfirmation(NA.common.message.confirmDelete, NA.common.message.confirmInfo, function () {
					var valTrec = gridHeaderData[0]['totalreceived'];
					valTrec = valTrec - 1;
					valTrec = (valTrec < 0) ? 0 : valTrec;
					//delete di localrow
					gridHeader.jqGrid('setCell', rowHeaderID, 'totalreceived', valTrec.toString());
					//gridHeader.jqGrid('setCell',
					var rowHeaderData = gridHeader.jqGrid('getLocalRow', '1');
					rowHeaderData.totalreceived = valTrec
					gridTbl.jqGrid('getLocalRow', rowDetailID).isdeleted = '1';
					gridTbl.jqGrid('getLocalRow', rowDetailID).isdirty = '1';
					gridTbl.jqGrid('saveRow', rowDetailID, {
						url: 'clientArray',
						restoreAfterError: true,
					});
					if (valTrec <= 0) {
					    filterToolbar.classList.add('disabled');
					} else { filterToolbar.classList.remove('disabled'); }
					$("#" + rowDetailID, gridTbl).hide();
				});
			}
		});
		win.onbeforeunload = function (e) {
			if (HasChangedData()) {
				return NA.common.message.dataHasChanged;
			}
			else {
				var rowId = gridTbl.jqGrid('getGridParam', 'selrow');
				if (rowId) {
					gridTbl.jqGrid("saveRow", rowId, {
						url: 'clientArray',
						restoreAfterError: true,
						//'extraparam': { IsDirty: "True" }
					});
					var curRow = gridTbl.jqGrid('getRowData', rowId), curRows = []; curRows.push(curRow);
					if (isDataChanged(curRows)) {

						return NA.common.message.dataHasChanged;
					}
				}
				//check selected rows
				//if selected saved currentRows
				//check if Datachanged
			}
		};
	})();

</script>
<script type="text/javascript">
	$(document).ready(function () {
		var btnAdd = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(1)'),
			btnOpen = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(2)'),
			btnEdit = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(3)'),
			btnSave = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(4)'),
			btnDelete = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(5)'),
			btnExport = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(6)'),
			btnPrint = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(7)');
		//disabledkan seluruh contgrol

		btnAdd.classList.add('disabled');
		btnOpen.classList.add('disabled');
		btnEdit.classList.add('disabled');
		btnSave.classList.add('disabled');
		btnDelete.classList.add('disabled');
		btnExport.classList.add('disabled');
		btnPrint.classList.add('disabled');
	});
</script>
{% endblock %}

