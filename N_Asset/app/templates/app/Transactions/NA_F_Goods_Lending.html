{% extends "../../app/layout.html" %}
{% block SearchData %}
{% for itemCombo in populateColumn %}
<li><a href="#" data-tipe="{{itemCombo.dataType}}" data-column="{{itemCombo.columnName}}">{{itemCombo.label}}</a></li>
{% endfor %}

{% endblock %}

{% block javascriptAndUI %}
<!--================================Load Script Modules NA ===========================================-->
<script type="text/javascript" src="../../../static/app/scripts/NAJS.js"></script>
<!--=======================================================================================================-->
<script type="text/javascript">
    
	(function(){ 
	    var txtSearchMaster = NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
	    btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default');
	    var defPlaceHolder = txtSearchMaster.getAttribute('placeholder');
	    if (!NA.common.getElementID('CustomSearch')) {
	        var parentC = NA.common.doc.querySelector('ul.dropdown-menu.search');
	        lastLi = NA.common.doc.createElement('li'),
			lastLi_a = NA.common.doc.createElement('a');
	        lastLi_a.setAttribute('id', 'custSearch');
	        lastLi_a.textContent = 'CustomSearch';
	        lastLi.appendChild(lastLi_a);
	        parentC.appendChild(lastLi);
	    }
	   
//=================add Dynamic Styles=============================
        NA.common.loadStyles("../../../static/app/content/jquery-ui.min.css","jqueryUI");
        NA.common.loadStyles("../../../static/app/content/ui.jqgrid.css","UIJqueryGrid");   
        var doc = doc||window.document;
        var DivSearch = doc.querySelector('ul.dropdown-menu.search');//return list Element
        (function(elm){
            var listElem = elm.children;
             var datePlaceHolder = 'yyyy-mm-dd or mm/dd/yyyy';
             var numPlaceHolder = 'enter numeric type';
             var boolPlaceHolder = 'true/false/1/0';
            Array.prototype.forEach.call(listElem,function(item){//buat jadi foreach mesti convert dulu ke array
                NA.NAEvent.addHandler(item, 'click', function (event) {
                    event.preventDefault();
                    if (item.firstChild.id === 'custSearch') {
                        //=========='show dialog search'==================
                        //NA.common.dialog.createSearchDialog(event)
                        txtSearchMaster.setAttribute('disabled', true);
                        txtSearchMaster.setAttribute('placeholder', '');
                        btnSearchMaster.setAttribute('disabled', true)
                    }
                    else {
                        txtSearchMaster.removeAttribute('disabled');
                        btnSearchMaster.removeAttribute('disabled');
                        var textSearch = NA.common.getElementID('bySearch');
                        textSearch.firstChild.nodeValue = item.textContent;
                        var elSearch = item.firstChild;
                        switch (elSearch.dataset.tipe) {
                            case "varchar":
                            case "nchar":
                            case "char":
                            case "nvarchar": {
                                txtSearchMaster.setAttribute('placeholder', defPlaceHolder);
                                break;
                            }
                            case "boolean": {
                                txtSearchMaster.setAttribute('placeholder', boolPlaceHolder);
                                break;
                            }
                            case "int":
                            case "integer":
                            case "decimal":
                            case "floatt":
                            case "bigint": {
                                txtSearchMaster.setAttribute('placeholder', numPlaceHolder);
                                break;
                            }
                            case "datetime": {
                                txtSearchMaster.setAttribute('placeholder', datePlaceHolder);
                                break;
                            }
                        }
                    }
                    //event.stopImmediatePropagation();
                });
            });
       
            NA.NAEvent.addHandler(txtSearchMaster, 'blur', function (e) {
                //get textcontent IDbySearch
                //looping dropdown li a textContent
                var SearchByText = NA.common.getElementID('bySearch').textContent;
                var elSearch = null;
                Array.prototype.forEach.call(listElem, function (item) {
                    if (item.firstChild.text == SearchByText) {
                        elSearch = item.firstChild;
                        return;
                    }                        
                });
                switch (elSearch.dataset.tipe) {
                    case "varchar":
                    case "nchar":
                    case "char":
                    case "nvarchar": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== defPlaceHolder) {
                                this.setAttribute('placeholder', defPlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                    case "boolean": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== boolPlaceHolder) {
                                this.setAttribute('placeholder', boolPlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                    case "int":
                    case "integer":
                    case "decimal":
                    case "floatt":
                    case "bigint": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== numPlaceHolder) {
                                this.setAttribute('placeholder', numPlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                    case "datetime": {
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') !== datePlaceHolder) {
                                this.setAttribute('placeholder', datePlaceHolder);
                            }
                        }
                        e.stopImmediatePropagation();
                        break;
                    }
                }
            });
            NA.NAEvent.addHandler(txtSearchMaster, 'focus', function (e) {
                if (this.value === '') {
                    if (this.getAttribute('placeholder') !== '') {
                        this.setAttribute('placeholder', '');
                    }
                }
            });            
        })(DivSearch);
    })();   
</script>

<!--SETUP Jquery grid-->
<!-- The jQuery library is a prerequisite for all jqSuite products -->
<script>window.jQuery || NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/jquery\-1\.11\.1\.js\"\>\<\/script\>');</script>

<!-- This is the Javascript file of jqGrid -->
<script src="../../../static/app/scripts/jquery.jqGrid.min.js"></script>

<!-- This is the localization file of the grid controlling messages, labels, etc. -->
<!-- We support more than 40 localizations -->
<script src="../../../static/app/scripts/grid.locale-en.js"></script>
<!----------------------------Load Jquery UI. JS file-------------------------------->
<script src="../../../static/app/scripts/jquery-ui.js"></script>
<script type="text/javascript">if (typeof $.fn.modal == 'undefined') { NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/bootstrap\.js\"\>\<\/script\>'); }</script>
<script src="../../../static/app/scripts/bootstrap-dialog.js"></script>
{% endblock %}

{%block content-0 %}
<table id="jqGrid_NA_F_Goods_Lending"></table>
<div id="jqGrid_NA_F_Goods_Lending_Pager"></div>

{%endblock%}

<script type="text/javascript">
       
    (function () {
        //=================================AJAX Setup pake jquery===========================-->
        $.ajaxSetup({
            cache: false,
            error: function (xhr, status, error) {
                try {
                    var messageErr = xhr.responseText;
                    var contentype = xhr.getResponseHeader('Content-Type')
                    if (contentype === 'application/json') {
                        messageErr = $.parseJSON(xhr.responseText);
                    }
                    var message = xhr.responseText;
                    if (messageErr) {
                        message = messageErr.message;
                    }
                    if (message) {
                        ShowAlert('An error occurred: ' + error + '\n' + xhr.status + ": " + message);
                    }

                } catch (e) {
                    ShowAlert('An error occurred: ' + error + '\n' + xhr.status + ": " + e.message);
                }
                window.document.body.style.cursor = 'defautl'; return false;
            },
            timeout: 2000000, // Timeout// nanti kalau sudah selesai system timeout ini harus di rubah, jadi maximal 20 detik
            type: 'GET',
            crossDomain: false, // obviates need for sameOrigin test                              
        });

        //===================================END AJAX SetuP===========================--> 

        //========================Variable Object untuk ===============================
        var win = win || window,
        grid = $("#jqGrid_NA_F_Goods_Receive"),
        txtSearchMaster = NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
        btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default'),
        csrftoken = function () { return NA.CookieUtil.get('csrftoken'); },
        //TypeApps = [],
        //settings btn sesuai user access
        //anggap saja sekarang admin
        btnSave = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(4)'),
        btnDelete = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(5)'),
        btnExport = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(6)'),
        btnPrint = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(7)'),
        btnHelp = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(8)'),
        containerMenu = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav'),//inistialisasi menu 
        originalData = {};

        // ===============Remove event kalau ada yang masih menempel di textbox/btnSearch master=================
        win.onunload = function () {
            var frmSearch = NA.common.doc.querySelector('form.navbar-form');
            frmSearch.reset();
            txtSearchMaster.value = '';
            if (typeof txtSearchMaster.onkeydown == "function") {
                NA.NAEvent.removeHandler(txtSearchMaster, 'keydown', handlerSearchInput)
            }
            if (typeof btnSearchMaster.onclick == "function") {
                NA.NAEvent.removeHandler(btnSearchMaster, 'click', handlerSearchInput);
            }
        };
        // ===============End Remove event kalau ada yang masih menempel di textbox/btnSearch master=================

        //Load Data grid
        function LoadData(page) {
            var url = 'NA_Goods_Receive_Search/?' + win.encodeURIComponent('columnName') + '=' + win.encodeURIComponent(NA.common.SearchData.getColumnKey()) +
                   '&' + win.encodeURIComponent('valueKey') + '=' + win.encodeURIComponent(NA.common.SearchData.getValueKey()) +
                   '&' + win.encodeURIComponent('dataType') + '=' + win.encodeURIComponent(NA.common.SearchData.getDataType()) +
                   '&' + win.encodeURIComponent('criteria') + '=' + win.encodeURIComponent(NA.common.SearchData.getCriteria());
            if (arguments.length > 0) {
                grid.setGridParam({ url: url }).trigger("reloadGrid", [{ page: page, }]);
            }
            else {
                //column idapp,no,goods,goodstype,serialnumber,lentby,sentby,lentdate,interests,responsibleby,refgoodsfrom,isnew,status,descriptions,createdby,createddate
                try {
                    var oriStatus = "L";
                    grid.jqGrid({
                        url: url,
                        mtype: "GET",
                        datatype: "json",
                        colNames: ['idapp', 'NO', 'Goods Name', 'Type', 'Serial Number', 'Lent By', 'Sent By','Lent Date', 'Interests', 'Responsible By', 'Ref Goods From', 'IsNew', 'Status', 'Descriptions', 'Created Date', 'Created By'],
                        colModel: [
                            { name: 'idapp', key: true, hidden: true, align: 'left' },
                            { name: 'NO', width: 40, align: 'right', sortable: false, editable: false, },
							{ name: 'goods', width: 100, index: 'goods', align: 'left', sortable: true, editable: false, },
                            { name: 'goodstype', index: 'goodstype', width: 80, sortable: true, editable: false, align: 'left', },
                            { name: 'serialnumber', index: 'serialnumber', sortable: true, editable: false, align: 'left', },
                            { name: 'lentby', index: 'lentby', width: 100, sortable: true, editable: false, align: 'left', },
                            //formatter : 'date', formatoptions: { srcformat : 'Y-m-d H:i:s', newformat :'ShortDate'}},
                            { name: 'sentby', index: 'sentby', width: 100, sortable: true, editable: false, align: 'left', },
                            { name: 'lentdate', index: 'lentdate', sortable: true, width: 110, formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' } },
                            { name: 'interests', index: 'interests', width: 140, sortable: true, editable: false, align: 'left', },
                            {
                                name: 'responsibleby', index: 'responsibleby', width: 100, sortable: true, align: 'right',
                            },
                            {
                                name: 'refgoodsfrom', index: 'refgoodsfrom', width: 130, sortable: true, align: 'right',
                            },
                            { name: 'isnew', index: 'isnew', sortable: true, width: 50, align: 'center', editable: false, formatter: 'checkbox', formatoptions: { disabled: false } },
                            {
                                name: 'status', index: 'status', width: 90, sortable: true, editable: true, align: 'left',
                                edittype: 'select', formatter: 'select', editoptions: {
                                    value: {'L':'Lent','R':'Return'},
                                    dataEvents:[
                                        {
                                            type:'change',
                                            fn:function(e){
                                                var NewVal = $(this).val(),url = 'UpdateStatus/';
                                                var tr = $(e.target).closest('tr');
                                                var idapp = tr[0].id;
                                                url = NA.common.addURLParam(url,'idapp',idapp);
                                                url = NA.common.addURLParam(url,'newVal',NewVal);
                                                //set data 
                                                $.post(url, function(data, status,xhr){
                                                    if(parseInt(status) != 200){
                                                        if(parseInt(status) >= 500){
                                                            //reset value
                                                            grid.jqGrid('setColProp', 'status', { editoptions: { value: {'L':'Lent','R':'Return'}} });
                                                            XhrError(xhr); win.document.body.style.cursor = 'default';
                                                        }
                                                        else {
                                                            grid.jqGrid('setColProp', 'status', { editoptions: { value: { 'L': 'Lent', 'R': 'Return' } } });
                                                            XhrError(xhr); win.document.body.style.cursor = 'default';
                                                        }
                                                    }
                                                },'json');
                                            },
                                        },]
                                },
                            },
							{ name: 'descriptions', index: 'descriptions', width: 140, sortable: true, editable: false, align: 'left', },
                            { name: 'createddate', index: 'createddate', sortable: true, width: 110, formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' } },
                            { name: 'createdby', index: 'createdby', sortable: true, width: 110, editable: false, },
                        ],
                        ondblClickRow: function (rowId) {
                            var btnOpen = NA.common.doc.querySelector('ul.nav.navbar-nav>li:nth-child(2)>button');
                            if (btnOpen) {
                                btnOpen.click();
                            }
                        },
                        beforeSelectRow: function (rowid, e) {
                            var $self = $(this),
                                iCol = $.jgrid.getCellIndex($(e.target).closest("td")[0]),
                            cm = $self.jqGrid("getGridParam", "colModel");
                            if (cm[iCol].name === "status") {
                                oriStatus =  $(e.target).val();
                            }
                        },
                        gridComplete: function () {
                            document.body.style.cursor = 'default';
                        },
                        loadError: function (xhr, st, err) {
                            win.document.body.style.cursor = 'default'; XhrError(xhr);
                        },
                        cellEdit: false,
                        height: $('div.fltlft').height() - ($('div.fltlft').height() * 0.173),
                        rowNum: 300,
                        rowList: [20, 50, 100, 200, 300, 500],
                        sortname: "idapp",
                        sortorder: "desc",
                        multiSort: true,
                        shrinkToFit: false,
                        iconSet: "fontAwesome",
                        forceFit: true,
                        toolbar: true,
                        scrollrows: true,
                        hidegrid: true,
                        caption: "Transactions ---Goods Lending",
                        pager: "#jqGrid_NA_F_Goods_Lending_Pager"
                    });
                    grid.navGrid("#jqGrid_NA_F_Goods_Lending_Pager", {
                        search: false, // show search button on the toolbar
                        add: false,
                        edit: false,
                        del: false,
                        refresh: true
                    });

                } catch (e) {
                    ShowAlert(e.message);
                    console.log(e);
                    document.body.style.cursor = 'default';
                };
            }
        }
        //==========================GROUP Function Declaration================================
        function getGridCellValue(thegrid, CeltoGet) {
            var reccount = thegrid.jqGrid('getGridParam', 'reccount');
            var rowId, rowData, colData;
            if (reccount > 0) {
                rowId = thegrid.jqGrid('getGridParam', 'selrow');
                if (rowId) {
                    rowData = thegrid.getRowData(rowId);
                    colData = rowData[CeltoGet];
                }
            }
            return colData;
        };
        //csrf token untuk form
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        };
        function XhrError(xhr) {
            try {
                var messageErr = xhr.responseText;
                var contentype = xhr.getResponseHeader('Content-Type')
                if (contentype === 'application/json') {
                    messageErr = JSON.parse(xhr.responseText);
                }
                var message = xhr.responseText;
                if (messageErr) {
                    message = messageErr.message;
                    if (message.indexOf('!DOCTYPE html') > 0) {
                        //error bawaan dari python django
                        //redirect to error web
                        //untuk sekarang tampilkan saja error codenya saja
                        ShowAlert('Unknown Server error occurred: ' + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
                        document.body.style.cursor = 'default';
                        return false;
                    }
                    else if (xhr.status >= 500) {
                        ShowAlert('Unknown Server error occurred: ' + '\n' + message + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
                        document.body.style.cursor = 'default';
                        return false;
                    }
                    else if (message) {
                        ShowAlert('An error occurred: ' + message);
                    }
                    else {
                        ShowAlert('An error occurred: ' + messageErr);
                    }
                }
                else if (message) {
                    ShowAlert('An error occurred: ' + message);
                }
                document.body.style.cursor = 'default';
            } catch (e) {
                ShowAlert('An error occurred: ' + e + '\n' + e.message);
                document.body.style.cursor = 'default';
            }
            return false;
        };
        //==========================End GROUP Function Declaration ============================
    });
</script>
