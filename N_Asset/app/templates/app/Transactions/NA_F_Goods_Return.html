{% extends 'app/layout.html' %}

{% block SearchData %}
<li><a href="#" data-tipe="varchar" data-column="goodsname">Goods name</a></li>
<li><a href="#" data-tipe="varchar" data-column="itemcode">Item code</a></li>
<li><a href="#" data-tipe="varchar" data-column="brandname">Brand name</a></li>
<li><a href="#" data-tipe="varchar" data-column="serialnumber">Serial number</a></li>
<li><a href="#" data-tipe="varchar" data-column="fromemployee">Return By</a></li>
<li><a href="#" data-tipe="varchar" data-column="usedemployee">Used By</a></li>
<li><a href="#" data-tipe="varchar" data-column="datereturn">Date Return</a></li>
<li><a href="#" data-tipe="varchar" data-column="conditions">Conditions</a></li>
<li><a href="#" data-tipe="varchar" data-column="minusDesc">Minus</a></li>
<li><a id="custSearch" href="#">Custom Search</a></li>
<!--<li class="divider"></li>-->
{% endblock %}

{% block javascriptAndUI %}
{% load static %}

<script type="text/javascript" src="../../../static/app/scripts/NAJS.js"></script>
<script type="text/javascript">

    (function(){
        var txtSearchMaster =  NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
            btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default');
        var defPlaceHolder = txtSearchMaster.getAttribute('placeholder');
        window.onunload = function(){
            if (typeof txtSearchMaster.onclick == "function") {
                NA.NAEvent.removeHandler(txtSearchMaster,'keydown',handlerSearchInput)
            }
            if (typeof btnSearchMaster.onclick == "function") {
                NA.NAEvent.removeHandler(btnSearchMaster,'click',handlerSearchInput);
            }
        };
//=================add Dynamic Styles=============================
        NA.common.loadStyles("../../../static/app/content/jquery-ui.min.css","jqueryUI");
        NA.common.loadStyles("../../../static/app/content/ui.jqgrid.css","UIJqueryGrid");
        var doc = doc||window.document;
        var DivSearch = doc.querySelector('ul.dropdown-menu.search');//return list Element
        (function(elm){
            var listElem = elm.children;
            var datePlaceHolder = 'yyyy-mm-dd or mm/dd/yyyy';
            var numPlaceHolder = 'enter numeric type';
            var boolPlaceHolder = 'true/false/1/0';
            Array.prototype.forEach.call(listElem,function(item){//buat jadi foreach mesti convert dulu ke array
                if(item.firstChild.nodeValue != 'CustomSearch'){
                    NA.NAEvent.addHandler(item,'click',function(event){
                        event.preventDefault();
                        if(item.firstChild.id === 'custSearch'){
                            //=========='show dialog search'==================
                            NA.common.dialog.createSearchDialog(event);
                            txtSearchMaster.setAttribute('disabled', true);
                            txtSearchMaster.setAttribute('placeholder', '');
                            txtSearchMaster.value = '';
                            btnSearchMaster.setAttribute('disabled', true)
                        }
                        else {
              						txtSearchMaster.removeAttribute('disabled');
              						btnSearchMaster.removeAttribute('disabled');
              						var textSearch = NA.common.getElementID('bySearch');
              						textSearch.firstChild.nodeValue = item.textContent;
              						var elSearch = item.firstChild;
              						switch (elSearch.dataset.tipe) {
              							case "varchar":
              							case "nchar":
              							case "char":
              							case "nvarchar": {
              								txtSearchMaster.setAttribute('placeholder', defPlaceHolder);
              								break;
              							}
              							case "boolean": {
              								txtSearchMaster.setAttribute('placeholder', boolPlaceHolder);
              								break;
              							}
              							case "int":
              							case "integer":
              							case "decimal":
              							case "floatt":
              							case "bigint": {
              								txtSearchMaster.setAttribute('placeholder', numPlaceHolder);
              								break;
              							}
              							case "datetime": {
              								txtSearchMaster.setAttribute('placeholder', datePlaceHolder);
              								break;
              							}
              						}
              					}
                    });
                }
            });
        })(DivSearch);
    })();
</script>
<script src="{% static 'app/scripts/jquery-1.11.0.min.js' %}" id="jq_uery"></script>
<script type="text/javascript" src="{% static 'app/scripts/grid.locale-en.js' %}"></script>
<script src="{% static 'app/scripts/jquery.jqGrid.min.js' %}"></script>
<script src="{% static 'app/scripts/jquery-ui.js' %}"></script>
<script type="text/javascript">if (typeof $.fn.modal == 'undefined') { NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/bootstrap\.js\"\>\<\/script\>'); }</script>
<script src="../../../static/app/scripts/bootstrap-dialog.js"></script>
<style>
div#content-0 {
    overflow:hidden;
}
div#gbox_NA_Goods_Return_grid,div#gview_NA_Goods_Return_grid,div#NA_Goods_Return_pager,div.ui-jqgrid-titlebar{
    border-radius: 0px
}
</style>
{% endblock %}

{% block content-0 %}
<table id="NA_Goods_Return_grid" style="overflow:auto"></table>
<div id="NA_Goods_Return_pager" class="scroll" style="text-align:center;"></div>
{% endblock %}

{% block DialogEntry %}
<script>
    function get_csrf(){
        csrf_token = '{{csrf_token}}'
        return csrf_token
    }
</script>
<script type="text/javascript">
    var win = win || window;
    var status = win.status || window.status;
    var goods_return_grid = $("#NA_Goods_Return_grid");
    var txtSearchMaster = txtSearchMaster || NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
        btnSearchMaster = btnSearchMaster || NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default'),
        qs = NA.common.qs,
        qsAll = NA.common.qsAll;
    $(document).ready(function () {
    	var NA_Ajax = NA.common.AJAX;
    	function XhrError(xhr) {
    		try {
    			var messageErr = xhr.responseText;
    			var contentype = xhr.getResponseHeader('Content-Type')
    			if (contentype === 'application/json') {
    				messageErr = JSON.parse(xhr.responseText);
    			}
    			var message = xhr.responseText;
    			if (messageErr) {
    				if (message.indexOf('\!DOCTYPE html') > 0) {
    					//error bawaan dari python django
    					//redirect to error web
    					//untuk sekarang tampilkan saja error codenya saja
    					dialogAlert('Unknown Server error occurred: ' + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
    					document.body.style.cursor = 'default';
    					return false;
    				}
    				else if (xhr.status >= 400) {
    					dialogAlert('Unknown Server error occurred: ' + '\n' + message + '\nstatus = ' + xhr.status.toString() + '\nPlease tell system administrator');
    					document.body.style.cursor = 'default';
    					return false;
    				}
    				else if (messageErr.message) {
    					dialogAlert('An error occurred: ' + messageErr.message);
    				}
    				else {
    					dialogAlert('An error occurred: ' + messageErr);
    				}
    			}
    			else if (message) {
    				dialogAlert('An error occurred: ' + message);
    			}
    			document.body.style.cursor = 'default';
    		} catch (e) {
    			dialogAlert('An error occurred: ' + e + '\n' + e.message);
    			document.body.style.cursor = 'default';
    		}
    		return false;
    	};
        function LoadData(page) {
            var url = 'getData/?' + win.encodeURIComponent('columnName') + '=' + win.encodeURIComponent(NA.common.SearchData.getColumnKey()) +
                          '&' + win.encodeURIComponent('valueKey') + '=' + win.encodeURIComponent(NA.common.SearchData.getValueKey()) +
                          '&' + win.encodeURIComponent('dataType') + '=' + win.encodeURIComponent(NA.common.SearchData.getDataType()) +
                          '&' + win.encodeURIComponent('criteria') + '=' + win.encodeURIComponent(NA.common.SearchData.getCriteria());
            if (arguments.length > 0) {
                goods_return_grid.setGridParam({ url: url }).trigger("reloadGrid", [{ page: page, }]);
            } else {
                goods_return_grid.jqGrid({
                    url: url,
                    datatype: 'json',
                    mtype: 'GET',
					//idapp,goods,serialnumber,fromemployee,usedemployee,datereturn,conditions,minus,iscompleted,fk_goods_lend,descriptions,createddate,createdby
                    colNames: ['idapp', 'No', 'Goods','Serial Number', 'Returned By', 'Used By', 'Date Return', 'conditions', 'Minus', 'Completed', 'Accepted','Descriptions', 'Createddate', 'Createdby'],
                    colModel: [
                        {
                        	name: 'idapp', index: 'idapp', width: 65, search: false, editable: false, hidden: true, key: true, editoptions: {
                        		dataInit: function (element) {
                        			jq(element).attr("readonly", "readonly");
                        		}
                        	}
                        },
                        { name: 'no', index: 'no', width: 45, align: 'center' },
                        { name: 'goods', index: 'goodsname', width: 150, editable: true, search: false, sortable: true },
                        { name: 'serialnumber', index: 'serialnumber', width: 150, align: 'left', editable: false, search: false },
						{ name: 'fromemployee', index: 'fromemployee', width: 150, align: 'left', editable: false, search: false },
						{ name: 'usedemployee', index: 'usedemployee', width: 150, align: 'left', editable: false, search: false },
                        {
                            name: 'datereturn', index: 'datereturn', width: 110, align: 'left', formatter: 'date',
                            formatoptions: {
                            	srcformat: 'Y-m-d', newformat: 'd F Y'
                            }
                        },
						{ name: 'conditions', index: 'conditions', width: 150, align: 'left', editable: false, search: false },
						{ name: 'minus', index: 'minus', width: 150, align: 'left', editable: false, search: false },
                        {
                            name: 'iscompleted', index: 'iscompleted', width: 110, editable: true, search: false,
                            formatter: 'checkbox', edittype: 'checkbox', editoptions: {
                            	value: '1:0'
                            },
                            align: 'center'
                        },
                        {name : 'isaccepted',index:'isaccepted', width: 110, editable: true, search: false,
                            formatter: 'checkbox', edittype: 'checkbox', editoptions: {
                                value: '1:0'
                            },
                            align: 'center'
                        },
                        { name: 'descriptions', index: 'descriptions', width: 250, editable: true, search: false },
                        {
                            name: 'createddate', index: 'createddate', width: 175, align: 'left', editable: false, search: false,
                            formatter: 'date', formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd F Y H:i:s' }
                        },
                        {
                        	name: 'createdby', index: 'createdby', width: 115, search: false, editable: false, editoptions: {
                        		dataInit: function (element) {
                        			jq(element).attr("readonly", "readonly");
                        		}
                        	}
                        },
                    ],
                    jsonreader: {
                        repeatitems: false,
                        id: 'idapp',
                        root: 'rows'
                    },
                    pager: $('#NA_Goods_Return_pager'),
                    rowList: [20, 50, 100, 200, 300, 500,1000,2000],
                    rowNum: 100,
                    //loadui: 'disable', // Disable Loading Text
                    cellEdit: false,
                    sortname: 'idapp',
                    sortorder: "desc",
                    viewrecords: true,
                    iconSet: "fontAwesome",
                    hidegrid: true,
                    shrinkToFit: false,
                    caption: 'Transaction -- Goods Return',
                    shrinkToFit: false,
                    height: $('div.fltlft').height() - ($('div.fltlft').height() * 0.173),
                    width: 'inherit',
                    ondblClickRow: function (rowId) {
                        var btnOpen = NA.common.doc.querySelector('ul.nav.navbar-nav>li:nth-child(2)>button');
                        if (btnOpen) {
                            btnOpen.click();
                        }
                    }
                });
            }
            goods_return_grid.navGrid("#NA_Goods_Return_pager", {
              search: false, // show search button on the toolbar
              add: false,
              edit: false,
              del: false,
              refresh: true
            });
        };
        var SearchData = NA.common.SearchData;
        SearchData.setDefaultSearchData('goodsname', 'Varchar', 'like');
        LoadData();

        function handlerSearchInput(event) {
            event = NA.NAEvent.getEvent(event);
            if (event.keyCode === 13 || event.target == btnSearchMaster || event.target.parentNode == btnSearchMaster) {
                var SearchBy = NA.common.doc.querySelector('li.dropdown>a#bySearch').textContent.trim();
                //SearchInput = qs('input[name=q]');
                if (SearchBy.trim() == 'By') {
                    NA.common.SearchData.setDefaultSearchData('goodsname', 'Varchar', 'like');
                    //var curPage = parseInt(goods_return_grid.getGridParam('page'));
                    window.document.body.style.cursor = 'wait';
                    if (event.target.value !== '') {
                      NA.common.SearchData.setValue(event.target.value);
                    }
                    LoadData(1);
                }
                else {
                    //submit search
                    submitSearch(event);
                }
                NA.NAEvent.stopPropagation(event);
            }
            if (event) {
                NA.NAEvent.stopPropagation(event);
            }
            window.document.body.style.cursor = '';
        }
        //=======================handler txt & button Search master keyboard event and click================================
        NA.NAEvent.addHandler(txtSearchMaster, 'keydown', handlerSearchInput);
        NA.NAEvent.addHandler(btnSearchMaster, 'click', handlerSearchInput);

        goods_return_grid.on("keyup", "tr", function (e) {
            var rowId = goods_return_grid.jqGrid('getGridParam', 'selrow');
            if (e.keyCode == 46) {
                var btnDelete = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(5)')
                btnDelete.click();
                //return false;
            }
        });
        goods_return_grid.navGrid('#NA_Goods_Return_pager', {
            edit: true,
            add: true,
            del: true,
            search: true,
            refresh: true,
            view: true,
            cloneToTop: false
        });
        NA.common.doc.title = 'Nufarm - Goods Return';
        $("div#gbox_NA_Goods_Return_grid, div#gview_NA_Goods_Return_grid, div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv").css({
            'width':'inherit'
        });


//================================ Search by ==============================//


        //================================= End Search by ======================================//
    function submitSearch(event) {
        window.document.body.style.cursor = 'wait';
        var txtSearchMaster = txtSearchMaster || NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
            elSearch = null;
        if (event)
            NA.NAEvent.preventDefault(event);

        var elementOption = null, columnKey = '', valueKey = '',
        elCriteria = null,//NA.common.doc.querySelector('td.columns select.selectopts.NA-Form-Control option:checked');
        valCriteria = '',//elCriteria.nodeValue;
        elDataType = '';//elementOption.dataset.dataType;
        if (event.target.getAttribute('id') === 'fbox_jqGrid_search' || event.target.getAttribute('id') === 'jqg1') {//fbox_jqGrid_search == button search,jqg1 = txtSearch nya
            elementOption = NA.common.doc.querySelector('td.columns select.NA-Form-Control option:checked');
            columnKey = elementOption.getAttribute('name'), valueKey = NA.common.getElementID('jqg1').value;
            elCriteria = NA.common.doc.querySelector('td.operators select.selectopts.NA-Form-Control option:checked');
            criteria = elCriteria.value;
            switch (criteria) {
                case "eq": { valCriteria = 'equal'; break; }
                case "ne": { valCriteria = 'notequal'; break; }
                case "bw": { valCriteria = 'beginwith'; break; }
                case "ew": { valCriteria = "endwith"; break; }
                case "cn": { valCriteria = "like"; break; }
                case "in": { valCriteria = "in"; break; }
                case "ni": { valCriteria = "notin"; break; }
                case "gt": { valCriteria = "greater"; break; }
                case "le": { valCriteria = "less"; break; }
                case "leq": { valCriteria = "lessorequal"; break; }
                case "gtq": { valCriteria = "greaterorequal"; break; }
                case "bw": { valCriteria = "between"; break; }
            };
            elDataType = elementOption.dataset.tipe;
        }
        else if (event.target == txtSearchMaster || event.target == btnSearchMaster || event.target.parentElement == btnSearchMaster) {
            var txtSearchMaster = txtSearchMaster || NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
            elSearch = null;
            valueKey = txtSearchMaster.value.trim();
            var listElem = NA.common.doc.querySelector('ul.dropdown-menu.search').children;//return list Element
            var textToSearch = NA.common.getElementID('bySearch').firstChild.nodeValue;
            Array.prototype.forEach.call(listElem, function (item) {//buat jadi foreach mesti convert dulu ke array
                if (item.firstChild.textContent === textToSearch) {
                    elSearch = item.firstChild;
                }
            });
            columnKey = elSearch.dataset.column
            elDataType = elSearch.dataset.tipe;
            valCriteria = 'like'
            if (!elSearch.dataset.column) {
                switch (elDataType) {
                    case "bigint":
                    case "integer":
                    case "money":
                    case "float":
                    case "decimal":
                    case "boolean":
                    case "datetime": {
                        if (valueKey.toString().indexOf(',') > -1) {
                            criteria = 'in'
                        }
                        criteria = 'equal';
                        break;
                    }
                };
            }
        }

        NA.common.SearchData.setValue(valueKey);
        NA.common.SearchData.setColumnName(columnKey);
        NA.common.SearchData.setDataType(elDataType)
        NA.common.SearchData.setCriteria(valCriteria);
        window.document.body.style.cursor = 'wait';
        LoadData(1);
        document.body.style.cursor = 'default';
        //goods_return_grid.jqGrid('setGridParam').trigger("reloadGrid", [{ page: 1 }]);//karena searching harus di set ke page 1
    };

        //function untuk Reset
    function submitReset(event) {
        //reload jqueryGrid
        //check apakah target dari btn reset
        if (event) {
            var target = NA.NAEvent.getTarget(event);
        }
        NA.common.SearchData.setDefaultSearchData('goodsname', 'varchar', 'like');
        NA.common.SearchData.setValue('');
        LoadData(1);
        window.document.body.style.cursor = 'default';
    };
        //========================Function Untuk memanggil Custom Search========================
    window.showDialogCustomSearch = function (event) {
        $('div.containerDialog').load("customFilter/", function (responseTxt, statusTxt, xhr) {
            if (statusTxt == "success") {
                //$(this).html(responseTxt);
                var dialog = NA.common.doc.querySelector('div.containerDialog');
                NA.common.getElementID('searchmodfbox').style.display = 'block';
                var btnClose = NA.common.doc.querySelector('div#searchhdfbo a.ui-jqdialog-titlebar-close.ui-corner-all'),
                txtSearchCustom = NA.common.getElementID('jqg1');
                var searchColDialog = NA.common.qs('td.columns select.NA-Form-Control');
                //perbaiki columns width search textnya
                searchColDialog.style.width = '130px';
                NA.NAEvent.addHandler(btnClose, 'click', function (event) {
                    NA.common.dialog.closeDialog(dialog);
                });
                var btnFind = NA.common.getElementID('fbox_jqGrid_search');
                NA.NAEvent.addHandler(btnFind, 'click', function (event) {
                    submitSearch(event);
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
                var btnReset = NA.common.getElementID('fbox_jqGrid_reset');
                NA.NAEvent.addHandler(btnReset, 'click', function (event) {
                    submitReset(event);
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
                NA.NAEvent.addHandler(txtSearchCustom, 'keydown', function (event) {
                    event = NA.NAEvent.getEvent(event);
                    if (event.keyCode === 13) {
                        submitSearch(event);
                    }
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
            }
        });
    };

    var containerMenu = qs('ul.nav.navbar-nav');
    NA.common.loadStyles("../../../static/app/content/Dialog.css", "DialogEntryStyle");
    NA.common.loadStyles("../../../static/app/content/NA_commonEntry.css","CommonEntry");

    NA.common.dialog.initDialog(containerMenu,'Nufarm Entry Goods Return - Transaction');

    var elementMenus = [];
    var menus = NA.common.doc.querySelectorAll('div.sidebar ul.list-sidebar.bg-defoult li ul li a');
    Array.prototype.forEach.call(menus, function (item) {
        if (item.textContent.indexOf("Email Data") > -1) {
            elementMenus.push(item);
        }
    });
    NA.common.dialog.initDialog(null,'Nufarm Send Email - Master Data',elementMenus);

    function getGridId() {
        return $(goods_return_grid).jqGrid('getGridParam', 'selrow')
    }

    function getGridValue (grid,jqgId, column) {
        var col = grid.jqGrid('getCell', jqgId, column);
        return col
    }
    function getValues_Form() {
        var data = {
            fk_goods: qs('input#id_fk_goods').value.trim(),
            itemcode: qs('input#id_itemcode').value.trim(),
			typeApp:qs('input#id_typeApp').value.trim(),
            goods: qs('input#id_goods').value.trim(),
            idapp_fk_goods_outwards: qs('input#id_idapp_fk_goods_outwards').value.trim(),
			idapp_fk_goods_lend:qs('input#id_idapp_fk_goods_lend').value.trim(),
            serialNumber: qs('input#id_serialNumber').value.trim(),
            minus: qs('input#id_minus').value.trim(),
            idapp_usedemployee: qs('input#id_idapp_usedemployee').value.trim(),
			nik_usedemployee:qs('input#id_nik_usedemployee').value.trim(),
            usedemployee: qs('input#id_usedemployee').value.trim(),
            idapp_fromemployee: qs('input#id_idapp_fromemployee').value.trim(),
            nik_fromemployee: qs('input#id_nik_fromemployee').value.trim(),
			fromemployee:qs('input#id_fromemployee').value.trim(),
            datereturn: qs('input#id_datereturn').value.trim(),
            conditions: qs('select#id_conditions').value.trim(),
            iscompleted:qs('input#id_iscompleted').checked,
            isaccepted:qs('input#id_isaccepted').checked,
            minus: qs('input#id_minus').value.trim(),
            descriptions: qs('textarea#id_descriptions').value.trim()
        };
        return data
    };


    var btnDelete = qs('ul.nav.navbar-nav li:nth-child(5)');
    NA.NAEvent.addHandler(btnDelete, 'click', function (event) {
        var get_idapp = getGridId();
        if (getGridId()) {
            NA.NAEvent.preventDefault(event);
            var rowNum = goods_return_grid.getGridParam('rowNum'),
                allRecords = goods_return_grid.getGridParam('records'),
                totalPages = parseInt((allRecords / rowNum) + 1),
                curPage = goods_return_grid.getGridParam('page'),
                rowId = goods_return_grid.jqGrid('getGridParam', 'selrow'),
                curRecount = goods_return_grid.jqGrid('getGridParam', 'reccount');
            return dialogConfirm(NA.common.message.confirmDelete, NA.common.message.confirmInfo,
                function () {
                    try {
                        //delete data di server
                        //$(selector).post(URL,data,function(data,status,xhr),dataType)-->return data type
                        $.ajax({
                            url: 'delete/',
                            method: 'POST',
                            data: {
                                'csrfmiddlewaretoken': get_csrf(),
                                'idapp': get_idapp,
                            },
                            success: function (data) {
                                if(data.message && data.message === 'success'){
                                  mustReload = true;
                                  if (parseInt(curRecount) === 1) {
                                      if (totalPages > 1) {
                                          curPage--;
                                      }
                                      else {
                                          mustReload = false;
                                          goods_return_grid.delRowData(rowId);
                                      }
                                  }
                                  else if (parseInt(totalPages) === 1) {
                                      mustReload = false;
                                      goods_return_grid.delRowData(rowId);
                                  }
                                  else if (parseInt(curRecount) > 1) {
                                      mustReload = false;
                                      goods_return_grid.delRowData(rowId);
                                  }
                                  if (mustReload) {
                                      goods_return_grid.trigger("reloadGrid", [{ page: curPage }]);
                                  };
                                }
                                else if(data.message === '__hasref_del'){
                                  dialogAlert(NA.common.message.canNotDelete);
                                  return;
                                }
                                else{
                                  dialogAlert((data.message==undefined||data.message=='')?((data==''||data==undefined)?'unknown error':data):data.message);return;
                                }
                            }
                        })
                    } catch (e) {
                        console.log(e);
                        window.document.body.style.cursor = 'default';

                    }
                },
                function () {
                    return false;
                });
        }
        else {
            document.body.style.cursor = 'default';
            return dialogAlert('Please select data you want to delete', NA.common.message.titleInfo, function () {
                return false;
            });
        }
    });
    function GetServerFormatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    };
    status = status || window.status
    function G_ReturnSubmit() {
        var dialog = qs("div.containerDialog");
        function sendData() {
            var valuesForm = getValues_Form()
            var format_date = function (date) {
                return $.datepicker.parseDate('dd/mm/yy', date)
            };
            valuesForm['datereturn'] = GetServerFormatDate(format_date(valuesForm['datereturn']));
            var idapp;
            if (win.status.trim() == 'Edit') {
            	idapp = getGridId()
				console.log(idapp)
            } else {
                idapp = ''
            }
            var snData = NA.common.AssignObject({
                'csrfmiddlewaretoken': get_csrf(),
                'statusForm': win.status,
            }, valuesForm, {'idapp':idapp})
            return snData
        }
        $.ajax({
            url: 'ShowEntry/',
            method: 'POST',
            beforeSend: function (jqXHR) {
                jqXHR.setRequestHeader('X-CSRF-Token', get_csrf())
            },
            data: sendData(),
            success: function (data) {
                var dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
                NA.common.dialog.closeDialog(dialog);
                goods_return_grid.trigger('reloadGrid');
                if (status.trim() == 'Add' || status.trim() == 'Edit') {
                    setTimeout(function () {
                        goods_return_grid.setSelection(data['message'], true)
                    }, 1000);
                }
            }
        });
    };
    function ExecuteHandler(TextElement) {
        var dialog = qs("div.containerDialog");
        var frmEntry = qs('form#gReturn_form');
        var emailForm = qs('form#email_data');
        if (frmEntry) {
            switch (TextElement) {
                case 'OK': {
                    if (!frmEntry.checkValidity()) {
                        //NA.NAEvent.preventDefault(event);
                        var inputbtn = NA.common.getElementID('gReturn_submit');
                        inputbtn.click();
                    }
                    else {
                        G_ReturnSubmit();
                    }
                    break;
                }
                case 'Cancel':
                case 'Close': {
                    //check if data has changed with javascrispt
                    initializeForm = NA.common.getElementID('id_initializeForm');
                    if (status === 'Open' || initializeForm.Value == '') { NA.common.dialog.closeDialog(dialog); return false; }
                    var originalData = JSON.parse(initializeForm.Value);
                    var valuesForm = getValues_Form();
                    if (NA.common.detectInputChanges(originalData, valuesForm)) {
                        return dialogConfirm(NA.common.message.dataHasChanged, NA.common.message.confirmInfo,
                                function () {
                                    if (!frmEntry.checkValidity()) {
                                        //NA.NAEvent.preventDefault(event);
                                        var inputbtn = NA.common.getElementID('gReturn_submit');
                                        inputbtn.click();
                                    } else {
                                        G_ReturnSubmit();
                                    }
                                },
                                function () {
                                    NA.common.dialog.closeDialog(dialog);
                                }
                            );

                    } else {
                        NA.common.dialog.closeDialog(dialog);
                    }
                }
            };
        } else if (emailForm) {
            var emailForm = qs('form#email_data');
            switch (TextElement) {
                case 'Cancel':
                case 'Close': {
                    var initializeEmail = NA.common.getElementID('initializeEmail');
                    var originalData = initializeEmail.Value;
                    var valuesForm = getValues_emailForm();

                    if (NA.common.detectInputChanges(originalData, valuesForm)) {
                        if (confirm('Data has changed, \nAre you sure to Send mail ?')) {
                            if (!emailForm.checkValidity()) {
                                //NA.NAEvent.preventDefault(event);
                                var inputbtn = NA.common.getElementID('emailData_submit');
                                inputbtn.click();
                            } else {
                                qs('div.dialogButtonOKCancel>a.button:nth-child(1)').click()
                            }
                        } else {
                            NA.common.dialog.closeDialog(dialog);
                        }
                    } else {
                        NA.common.dialog.closeDialog(dialog);
                    }
                }

            }
        }

    };
    function restyleBoostrapDialog() {
        var BSDialogContent = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content');
        BSDialogContent.style.cssText = 'width: 500px; height: 350px;';
        var ContentBody = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content>.modal-body');
        ContentBody.style.cssText = 'padding:0px;';
        var contentFooter = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content>.modal-footer');
        contentFooter.style.cssText = 'padding-bottom:0px;padding-top:0px;';
        var mHeader = NA.common.doc.querySelector('div.bootstrap-dialog .modal-header.bootstrap-dialog-draggable');
        mHeader.style.cssText = 'height:30px;padding:0px;';
        var footerButton = NA.common.doc.querySelector('div.bootstrap-dialog-footer-buttons');
        footerButton.style.cssText = 'padding-top:8px;';
    };
    function getGridCellValue(thegrid, CeltoGet) {
        var reccount = thegrid.jqGrid('getGridParam', 'reccount');
        var rowId, rowData, colData;
        if (reccount > 0) {
            rowId = thegrid.jqGrid('getGridParam', 'selrow');
            if (rowId) {
                rowData = thegrid.getRowData(rowId);
                colData = rowData[CeltoGet];
            }
        }
        return colData;
    };
    function dialogConfirm(message, title, callTrue, callFalse) {
        return BootstrapDialog.confirm({
            title: title || NA.common.message.titleInfo,
            message: message,
            type: BootstrapDialog.TYPE_WARNING,
            size: BootstrapDialog.SIZE_SMALL,
            animate: false,
            cssClass: 'login-dialog',
            closeByBackdrop: false,
            closeByKeyboard: false,
            closable: false,
            draggable: true,
            btnCancelLabel: 'NO.',
            btnOKLabel: 'Yes.',
            btnOKClass: 'btn-success',
            callback: function (result) {
                if (result) {
                    if (callTrue) {
                        callTrue();
                    }
                }
                else {
                    if (callFalse) {
                        callFalse();
                    }
                }
            },
            onshown: function (dialogRef) {
                var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
                divHeader.style.backgroundColor = 'green';
                var btnOK = NA.common.doc.querySelector('div.bootstrap-dialog-footer-buttons button.btn.btn-success');
                if (btnOK) {
                	btnOK.focus();
                }
            }
        });
    };

    function dialogAlert(message, title, callback) {
        return BootstrapDialog.alert({
            title: title || NA.common.message.titleInfo,
            message: message,
            size: BootstrapDialog.SIZE_SMALL,
            //animate:false,
            cssClass: 'login-dialog',
            closeByBackdrop: false,
            closeByKeyboard: false,
            type: BootstrapDialog.TYPE_INFO,
            closable: false,
            draggable: true,
            buttonLabel: 'OK',
            callback: function (result) {
                if (result) {
                    if (callback) {
                        callback();
                    }
                    return true;
                }
            },
            onshown: function (dialogRef) {
                var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
                divHeader.style.backgroundColor = 'green';
            }
        });
    };
    function fillEmployeeName(nik) {
    	//var url = win.encodeURIComponent('getEmployee/?nik=' + nik);
    	var url = 'getEmployee/?' + win.encodeURIComponent('nik') + '=' + win.encodeURIComponent(nik);
    	//AAjax.GET('getEmployee/?' + win.encodeURIComponent('nik') + '=' + win.encodeURIComponent(nik)
    	NA_Ajax.GET(url,
					'application/json',//overrideMimeType returned by the server
					function () { window.document.body.style.cursor = 'wait'; },
					null,//nggak usah di isi bila tidak perlu
					function () {//function executed after data has been returned by server(XHR.onload)
						try {
							if (this.status === 200) {
								var data = JSON.parse(this.responseText);
									//set employee_name
									var elFKEmp = NA.common.getElementID('id_nik_fromemployee');
									var elempname = NA.common.getElementID('id_fromemployee');
									var elidapp = NA.common.getElementID('id_idapp_fromemployee');
									if (data) {
										//elFKEmp.value = data['nik'] || '';
										elempname.value = data['employee_name'] || '';
										elidapp.value = data['idapp'] || '';
									}
									else {
										dialogAlert(NA.common.message.canNotFindData, NA.common.message.titleInfo);
										return false;
									}
							}
							else {
								window.document.body.style.cursor = 'default'; XhrError(this); return false;
							}
						} catch (e) {
							window.document.body.style.cursor = 'default'; XhrError(this); return false;
						}
					}, null, function () {//function untuk ajax error
						window.document.body.style.cursor = 'default'; XhrError(this);
					}, function () { window.document.body.style.cursor = 'default'; },//function ajax complete
					null//(parameter tambahan)nggak usah di isi bila tidak perlu(bila mau di isi isi dengan object javascript {key:value}
					);
    };
    window.showDialogEntry = function (event) {//function ini akan di panggil oleh NAJS.common.dialog,setiap menu add/edit/delete,etc di clik
    	//add handler to btnOK untuk mengantisipasi form load gagal
    	var dialog = qs('div.containerDialog');
    	dialog.style.top = '10px';
        var win = window
        var target = NA.NAEvent.getTarget(event);

        try {

            if (target.innerText === 'Email Data') {
                var btn_mailExport = qs('div.dialogButtonRightOther a.btn-link:nth-child(2)'),
                    btn_mailPreview = qs('div.dialogButtonRightOther a.btn-link:nth-child(1)');
                NA.common.NA_setAttr(btn_mailExport, {
                    "style": "cursor: pointer;pointer-events: all;width: auto;margin-right:5px"
                });
                btn_mailExport.textContent = 'Export To PDF';
                NA.common.NA_setAttr(btn_mailPreview, {
                    "style": "cursor: pointer;pointer-events: all;width: auto;"
                });
                btn_mailPreview.textContent = 'Preview PDF';
                var btnToPDF = qs('div.bottomDialogContent a.btn-link:nth-child(1)');
                //====================================== Display Email Data Dialog =========================================
                $('div.maindialogContent').load(url_emailData(), function (response, status, xhr) {
                    if (status == "success") {
                        var jspdf = "../../../static/app/scripts/jspdf.js",
                        sfm = "../../../static/app/scripts/standard_fonts_metrics.js",
                        stz = "../../../static/app/scripts/split_text_to_size.js",
                        jspdf_autoTable = "../../../static/app/scripts/jspdf.plugin.autotable.min.js",
                        jqUI = "../../../static/app/scripts/jquery-ui.min.js",
                        autoComp = "../../../static/app/scripts/autocomplete.js",
                        emailDataJS = "../../../static/app/scripts/NA_EmailData.js",
                        content_0 = qs('div#content-0');
                        if (qs('script#jspdf') == null) {
                            NA.common.loadScript(jspdf, content_0, 'jspdf');
                            NA.common.loadScript(sfm, content_0, 'sfm');
                            NA.common.loadScript(stz, content_0, 'stz');
                            NA.common.loadScript(jspdf_autoTable, content_0, 'jspdf_autoTable');
                            NA.common.loadScript(emailDataJS, content_0, 'emailData_scripts');
                        };
                        var originalData = getValues_emailForm();
                        var initializeEmail = NA.common.getElementID('initializeEmail');
                        initializeEmail.Value = originalData;

                        //=========================================== End Display Email Data Dialog ===========================================
                    }

                });

                //if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; }
                //return false;
            } else if (target.innerText.trim() === 'Add' || target.innerText.trim() === 'Edit' || target.innerText.trim() == 'Open') {
                var dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
                if (target.innerText.trim() == 'Edit' || target.innerText.trim() == 'Open') {
                    var idapp = getGridId();
                    if (typeof idapp == 'undefined' || !idapp || idapp == '') {
                        NA.common.dialog.closeDialog(dialog);
                        var message = 'Please select data you want to Edit';
                        if (goods_return_grid.getGridParam('records') === 0) {
                            message = 'No Data Found at here'
                        };
                        return dialogAlert(message, NA.common.message.titleInfo, function () {
                            return goods_return_grid.trigger('reloadGrid');
                        });
                    }
                };

                $('div.maindialogContent').load("ShowEntry/?" + win.encodeURIComponent('idapp') + '=' + win.encodeURIComponent(getGridId()) + '&' + win.encodeURIComponent('statusForm')
                    + '=' + win.encodeURIComponent(target.innerText.trim()), function (responseTxt, statusTxt, xhr) {//load /tampilkan form entry data(ShowEntry hanya contoh nama form)
                        if (responseTxt == 'Lost' && xhr.status == 500) {
                            NA.common.dialog.closeDialog(dialog);
                            return dialogAlert(NA.common.message.dataHasLost, NA.common.message.titleInfo, function () {
                                return goods_return_grid.trigger("reloadGrid");
                            });
                        };
                        if (statusTxt == "success") {  //jika form sudah di load selanjutnya tinggal inisialisasi semua component dan simpang semua ke dalam variable jika perlua
                            //remove attribute disable untuk button OK dan cancel bila statusnya Add
                            switch (status) {

                                case 'Add':
                                    {
                                        break;
                                    }
                                case 'Edit':
                                    {
                                        setTimeout(function () {
                                            $('div.dialogButtonOKCancel>a.button').removeAttr("disabled");
                                        }, 10)
                                    }
                                case 'Open': {
                                    $('div.dialogButtonEntry>a.button').attr("disabled", true);
                                    break;
                                }
                            };
                            if (status !== 'Open' && status !== '') {//hanya untuk status Add/Edit
                            	var originalData = JSON.stringify(getValues_Form());
                                $('input#id_datereturn').datepicker({
                                	dateFormat: 'dd/mm/yy',
                                	changeMonth: true,
                                	changeYear: true,
                                	dayNamesMin: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri ', 'Sat'],
                                	beforeShowDay: $.datepicker.noWeekends,
                                	maxDate: 1,
                                	showButtonPanel: true,
                                	closeText: "Close",
                                	currentText: 'Now',
                                });

                                //simpan original data di initializeForm

                            	var fk_goods = qs('input#id_fk_goods'),
									typeApp = qs('input#id_typeApp'),
                                    itemcode = qs('input#id_itemcode'),
                                    goods = qs('input#id_goods'),
                                    serialNumber = qs('input#id_serialNumber'),
                                    btn_fkGoods = qs('button#FK_goods'),
									usedemployee = qs('input#id_usedemployee'),
									nik_usedemployee = qs('input#id_nik_usedemployee'),
									idapp_usedemployee = qs('input#id_idapp_usedemployee'),
									idapp_fk_goods_outwards = qs('input#id_idapp_fk_goods_outwards'),
									idapp_fk_goods_lend = qs('input#id_idapp_fk_goods_lend');

                                var btn_fkEmployee = qs('button#FK_fromemployee'),
									nik_fromemployee = qs('input#id_nik_fromemployee'),
									fromemployee = qs('input#id_fromemployee'),
									idapp_fromemployee = qs('input#id_idapp_fromemployee');

                                function searchGoods(event) {
                                    BootstrapDialog.show({
                                        draggable: true,
                                        type: BootstrapDialog.TYPE_SUCCESS,
                                        size: BootstrapDialog.SIZE_NORMAL,
                                        title: 'Search Goods .. .',
                                        message: function (dialogRef) {
                                            var placeHolder = 'Enter goods descriptions to search for .. .';
                                            containerMessage = NA.common.dialog.createFormContainer('fk_goods', placeHolder,
                                            function (e) {//event for blur
                                                if (this.value === '') {
                                                    if (this.getAttribute('placeholder') === '') {
                                                        this.setAttribute('placeholder', placeHolder);
                                                    }
                                                }
                                            },
                                            function (e) {//event for focus
                                                if (this.value === '') {
                                                    if (this.getAttribute('placeholder') === placeHolder) {
                                                        this.setAttribute('placeholder', '');
                                                    }
                                                }
                                            },
                                            function (e) {//even for keydown txtSearch
                                                if (e.keyCode === 13) {
                                                    NA.NAEvent.preventDefault(e);
                                                    win.document.body.style.cursor = 'wait';
                                                    //cari data ke database
                                                    var url = 'SearchGoodsByForm/?' + win.encodeURIComponent('goods_filter') + '=' + win.encodeURIComponent(e.target.value.trim());
                                                    if (gridTbl) {
                                                        jQuery(gridTbl).setGridParam({ url: url, search: true }).trigger("reloadGrid", [{ page: 1, }]);
                                                    }
                                                    win.document.body.style.cursor = 'default';
                                                    NA.NAEvent.stopPropagation(e);
                                                }
                                            }, function (e) {
                                                txtSearch = NA.common.getElementID('txtsearch_fk_goods');
                                                NA.common.triggerKeyboardEvent(txtSearch, 13);
                                            });
                                            var children = containerMessage.childNodes;
                                            var mainContainer = null, txtSearch = null;
                                            for (var i = 0, len = children.length; i < len; i++) {
                                                if (children[i].nodeType == 1 && children[i].className === 'maincontainerForm fk_goods') {
                                                    mainContainer = children[i]; break;
                                                }
                                            };

                                            //loads Data into JqueryGrid
                                            gridTbl = NA.common.doc.createElement('table');
                                            gridTbl.id = 'NA_Goods_Return_FK_Goods';
                                            gridPager = NA.common.doc.createElement('div');
                                            gridPager.id = 'NA_Goods_Return_FK_Goods_Pager';
                                            mainContainer.appendChild(gridTbl);
                                            mainContainer.appendChild(gridPager);
                                            return containerMessage;
                                        },
                                        onshown: function (dialogRef) {
                                            txtSearch = NA.common.getElementID('txtsearch_fk_goods');
                                            var valSearch = '';
                                            if (txtSearch != null) {
                                                valSearch = win.encodeURIComponent(txtSearch.textContent.trim());
                                            }
                                            gridTbl = $('#NA_Goods_Return_FK_Goods');
                                            var urlFKGoods = 'SearchGoodsByForm/?' + win.encodeURIComponent('goods_filter') + '=' + valSearch;
                                            gridTbl.jqGrid({
                                                url: urlFKGoods,
                                                mtype: "GET",
                                                datatype: "json",//column IDapp, NO,    goods   datereceived suppliername FK_ReceivedBy  receivedby FK_P_R_By pr_by totalpurchase totalreceived
                                                colNames: ['idapp', 'NO', 'itemcode', 'goods Description', 'Serial Number', 'Ref Goods From','FK goods','Last Used','Type App'],
                                                colModel: [
                                                    { name: 'idapp', hidden: true, align: 'left' },
                                                    { name: 'no', key: true, width: 35, align: 'right', sortable: false, editable: false, },
                                                    { name: 'itemcode', width: 80, align: 'left', sortable: true, editable: false, },
                                                    { name: 'goods', index: 'goods', width: 210, sortable: true, editable: false, align: 'left' },
                                                    { name: 'serialnumber', index: 'serialnumber', width: 170, sortable: true, editable: false, align: 'left' },
                                                    {
                                                    	name: 'fromgoods', index: 'fromgoods', width: 130, sortable: true, editable: false, align: 'left', formatter: 'select',
                                                    	editoptions: {
                                                    		value: 'GO:Goods Outwards;GL:Goods Lending'
                                                    	}
                                                    },
													{ name: 'fk_goods', index: 'fk_goods', hidden: true },
													{ name: 'employee_name',index:'employee_name',width:150,sortable: true, editable: false, align: 'left',},
													{ name: 'typeApp', index: 'typeApp', hidden: true }
                                                ],
                                                ondblClickRow: function (rowId) {
                                                    //fire button OK
                                                    var btnOK = dialogRef.getButton('btnOKFindGoods');
                                                    btnOK.click();
                                                },
                                                gridComplete: function () {
                                                    document.body.style.cursor = 'default';
                                                },
                                                loadComplete: function () {
                                                    //No Data Found at Here .. All goods data has been generate to Fixed Assets
                                                    if (gridTbl.getGridParam("records") == 0 && gridTbl.getGridParam('search') === false) {
                                                        $('div#gview_jqGrid_NA_F_Goods_Receive_FK_Goods').find('div.ui-jqgrid-bdiv').append('<div style="height: 100%;font-size: 17px;padding: 30px;text-align:center;color:#ccc">' + 'No Data Found at Here ..<br/> All goods data has been generate to Fixed Assets' + '</div>');
                                                        $('input#txtsearch_fk_goods').attr('disabled', true);
                                                        $('input#txtsearch_fk_goods').next().find('button.btn.btn-success').attr('disabled', true);
                                                        dialogRef.getButton('btnOKFindGoods').attr('disabled', true);
                                                    }
                                                },
                                                cellEdit: false,
                                                viewrecords: true,
                                                height: '170px',
                                                rowNum: 500,
                                                rowList: [20, 50, 100, 200, 300, 500],
                                                sortname: "itemcode",
                                                sortorder: "asc",
                                                multiSort: true,
                                                shrinkToFit: false,
                                                iconSet: "fontAwesome",
                                                //forceFit: true,
                                                //toolbar: true,
                                                scrollrows: true,
                                                //hidegrid: true,
                                                //caption: "Transactions ---Find goods",
                                                pager: "#NA_Goods_Return_FK_Goods_Pager"
                                            });
                                            gridTbl.navGrid('#NA_Goods_Return_FK_Goods_Pager', {
                                                search: false, // show search button on the toolbar
                                                add: false,
                                                edit: false,
                                                del: false,
                                                refresh: false
                                            });
                                            //restyleBoostrapDialog();
                                            var elGrid = qsAll('div#gbox_NA_Goods_Return_FK_Goods,div#gview_NA_Goods_Return_FK_Goods,div#gview_NA_Goods_Return_FK_Goods > div.ui-jqgrid-hdiv.ui-state-default.ui-corner-top,div#gview_NA_Goods_Return_FK_Goods > div.ui-jqgrid-bdiv, div#NA_Goods_Return_FK_Goods_Pager')
                                            Array.prototype.forEach.call(elGrid, function (el) {
                                                el.style.width = 'inherit';
                                            });
                                        },
                                        closable: false,
                                        animate: false,
                                        closeByBackdrop: false,
                                        closeByKeyboard: false,
                                        buttons: [{
                                            label: 'Cancel',
                                            icon: 'glyphicon glyphicon-remove',
                                            cssClass: 'btn-success',
                                            action: function (dialogRef) {
                                                dialogRef.close();
                                            },
                                        }, {
                                            label: 'OK',
                                            id: 'btnOKFindGoods',
                                            icon: 'glyphicon glyphicon-ok',
                                            cssClass: 'btn-success',
                                            action: function (dialogRef) {
                                            	var grid_idapp = getGridCellValue(gridTbl, 'idapp'),
													grid_fk_goods = getGridCellValue(gridTbl, 'fk_goods'),
													grid_typeApp = getGridCellValue(gridTbl,'typeApp'),
                                            		grid_fromgoods = getGridCellValue(gridTbl, 'fromgoods');
                                            	NA_Ajax.GET('getGoods/?' + win.encodeURIComponent('idapp') + '=' + grid_idapp + '&'
													+ win.encodeURIComponent('fromgoods') + '=' + win.encodeURIComponent(grid_fromgoods), 'application/json', function (e) {
														window.document.body.style.cursor = 'wait';
													},
                                                            null,
                                                            function (e) {//function executed after data has been returned by server(XHR.onload)
                                                            	var data = JSON.parse(this.responseText);
                                                            	if (data && this.status == 200) {
																	data = data['message'][0]
																	fk_goods.value = grid_fk_goods;
																	typeApp.value = grid_typeApp;
                                                                    itemcode.value = data['itemcode'];
                                                                    goods.value = data['goods'];
                                                                    serialNumber.value = data['serialnumber'];
                                                                    usedemployee.value = data['used_by'];
                                                                    nik_usedemployee.value = data['nik_used_by'];
                                                                    idapp_usedemployee.value = data['idapp_used_by'];
                                                                    nik_fromemployee.value = data['nik_used_by'];
                                                                    fromemployee.value = data['used_by'];
                                                                    idapp_fromemployee.value = data['idapp_used_by'];
                                                                    if (grid_fromgoods == 'GO') {
                                                                    	idapp_fk_goods_outwards.value = grid_idapp;
                                                                    	idapp_fk_goods_lend.value = '';
                                                                    } else if (grid_fromgoods == 'GL') {
                                                                    	idapp_fk_goods_lend.value = grid_idapp;
                                                                    	idapp_fk_goods_outwards.value = '';
                                                                    };
                                                                    dialogRef.close();
                                                                }
                                                            }, null, function (e) {
                                                                throw new Error(this.responseText + '\nStatus code :' + this.statusText);
                                                            }, function (e) { window.document.body.style.cursor = 'default'; },//function ajax complete
                                                            null);
                                            }
                                        }]
                                    });
                                }

                                function searchEmployee(event) {
                                	BootstrapDialog.show({
                                		draggable: true,
                                		type: BootstrapDialog.TYPE_SUCCESS,
                                		size: BootstrapDialog.SIZE_SMALL,
                                		title: 'Search Employee .. .',
                                		message: function (dialogRef) {
                                			var placeHolder = 'Enter employee descriptions to search for .. .';
                                			containerMessage = NA.common.dialog.createFormContainer('fk_employee', placeHolder,
                                            function (e) {//event for blur
                                            	if (this.value === '') {
                                            		if (this.getAttribute('placeholder') === '') {
                                            			this.setAttribute('placeholder', placeHolder);
                                            		}
                                            	}
                                            },
                                            function (e) {//event for focus
                                            	if (this.value === '') {
                                            		if (this.getAttribute('placeholder') === placeHolder) {
                                            			this.setAttribute('placeholder', '');
                                            		}
                                            	}
                                            },
                                            function (e) {//even for keydown txtSearch
                                            	if (e.keyCode === 13) {
                                            		NA.NAEvent.preventDefault(e);
                                            		win.document.body.style.cursor = 'wait';
                                            		//cari data ke database
                                            		var url = '/MasterData/Employee/SearchEmployeeByForm/?' + win.encodeURIComponent('employee_filter') + '=' + win.encodeURIComponent(e.target.value.trim());
                                            		if (gridTbl) {
                                            			$(gridTbl).setGridParam({ url: url, search: true }).trigger("reloadGrid", [{ page: 1, }]);
                                            		}
                                            		win.document.body.style.cursor = 'default';
                                            		NA.NAEvent.stopPropagation(e);
                                            	}
                                            }, function (e) {
                                            	txtSearch = NA.common.getElementID('txtsearch_fk_employee');
                                            	NA.common.triggerKeyboardEvent(txtSearch, 13);
                                            });
                                			var children = containerMessage.childNodes;
                                			var mainContainer = null, txtSearch = null;
                                			for (var i = 0, len = children.length; i < len; i++) {
                                				if (children[i].nodeType == 1 && children[i].className === 'maincontainerForm fk_employee') {
                                					mainContainer = children[i]; break;
                                				}
                                			};

                                			//loads Data into JqueryGrid
                                			gridTbl = NA.common.doc.createElement('table');
                                			gridTbl.id = 'NA_Goods_Return_FK_Employee';
                                			gridPager = NA.common.doc.createElement('div');
                                			gridPager.id = 'NA_Goods_Return_FK_Employee_Pager';
                                			mainContainer.appendChild(gridTbl);
                                			mainContainer.appendChild(gridPager);
                                			return containerMessage;
                                		},
                                		onshown: function (dialogRef) {
                                			txtSearch = NA.common.getElementID('txtsearch_fk_employee');
                                			var valSearch = '';
                                			if (txtSearch != null) {
                                				valSearch = win.encodeURIComponent(txtSearch.textContent.trim());
                                			}
                                			gridTbl = $('#NA_Goods_Return_FK_Employee');
                                			var urlFKGoods = '/MasterData/Employee/SearchEmployeeByForm/?' + win.encodeURIComponent('employee_filter') + '=' + valSearch;
                                			gridTbl.jqGrid({
                                				url: urlFKGoods,
                                				mtype: "GET",
                                				datatype: "json",//column IDapp, NO,    goods   datereceived suppliername FK_ReceivedBy  receivedby FK_P_R_By pr_by totalpurchase totalreceived
                                				colNames: ['idapp', 'NO', 'Nik', 'Employee Name'],
                                				colModel: [
                                                    { name: 'idapp', hidden: true, align: 'left' },
                                                    { name: 'no', width: 40, align: 'right', sortable: false, editable: false, key: true, },
                                                    { name: 'nik', index: 'nik', width: 220, sortable: true, editable: false, align: 'left' },
                                                    { name: 'employee_name', index: 'employee_name', width: 250, align: 'left', sortable: true, editable: false, }
                                				],
                                				ondblClickRow: function (rowId) {
                                					//fire button OK
                                					var btnOK = dialogRef.getButton('btnOKFindEmployee');
                                					btnOK.click();
                                				},
                                				gridComplete: function () {
                                					document.body.style.cursor = 'default';
                                				},
                                				cellEdit: false,
                                				viewrecords: true,
                                				height: '170px',
                                				rowNum: 500,
                                				rowList: [20, 50, 100, 200, 300, 500],
                                				sortname: "employee_name",
                                				sortorder: "asc",
                                				multiSort: true,
                                				shrinkToFit: false,
                                				iconSet: "fontAwesome",
                                				//forceFit: true,
                                				//toolbar: true,
                                				scrollrows: true,
                                				//hidegrid: true,
                                				//caption: "Transactions ---Find goods",
                                				pager: "#NA_Goods_Return_FK_Employee_Pager"
                                			});
                                			gridTbl.navGrid('#NA_Goods_Return_FK_Employee_Pager', {
                                				search: false, // show search button on the toolbar
                                				add: false,
                                				edit: false,
                                				del: false,
                                				refresh: false
                                			});
                                			restyleBoostrapDialog();
                                			var elGrid = qsAll('div#gbox_NA_Goods_Return_FK_Employee,div#gview_NA_Goods_Return_FK_Employee,div#gview_NA_Goods_Return_FK_Employee > div.ui-jqgrid-hdiv.ui-state-default.ui-corner-top,div#gview_NA_Goods_Return_FK_Employee > div.ui-jqgrid-bdiv, div#NA_Goods_Return_FK_Employee_Pager')
                                			Array.prototype.forEach.call(elGrid, function (el) {
                                				el.style.width = 'inherit';
                                			});
                                		},
                                		closable: false,
                                		animate: false,
                                		closeByBackdrop: false,
                                		closeByKeyboard: false,
                                		buttons: [{
                                			label: 'Cancel',
                                			icon: 'glyphicon glyphicon-remove',
                                			cssClass: 'btn-success',
                                			action: function (dialogRef) {
                                				dialogRef.close();
                                			},
                                		}, {
                                			label: 'OK',
                                			id: 'btnOKFindEmployee',
                                			icon: 'glyphicon glyphicon-ok',
                                			cssClass: 'btn-success',
                                			action: function (dialogRef) {
                                				var rowId = gridTbl.jqGrid('getGridParam', 'selrow'),
                                                    rowData = gridTbl.getRowData(rowId),
                                                    target = NA.NAEvent.getTarget(event);
                                				idapp_fromemployee.value = rowId,
												nik_fromemployee.value = rowData['nik'],
												fromemployee.value = rowData['employee_name'];
                                				dialogRef.close();
                                			}
                                		}]
                                	});
                                }

                                NA.NAEvent.addHandler(serialNumber, 'keydown', function (event) {

                                	if (event.keyCode == 13) {
                                		if (!event.target.value) { dialogAlert('Please enter serial number', NA.common.message.titleInfo);  NA.NAEvent.preventDefault(event);return false; }
                                		//searchGoods(event);
                                		var serialNumber = event.target.value;
                                		var url = 'getLastTrans/?' + win.encodeURIComponent('serialnumber') + '=' + serialNumber;
                                		NA_Ajax.GET(url, 'application/json',//overrideMimeType returned by the server
										function () { window.document.body.style.cursor = 'wait'; },
										null,//nggak usah di isi bila tidak perlu
										function () {//function executed after data has been returned by server(XHR.onload)

											if (this.status === 200) {
												var data = JSON.parse(this.responseText);
												if (data) {
													//{'idapp_fk_goods':idapp_fk_goods,'itemcode':itemcode,'goodsname':goodsname,'fk_usedemployee':fk_usedemployee,
													//'usedemployee':usedemployee,'idapp_usedemployee':idapp_usedemployee,'fkoutwards':fkoutwards,'fklending':fklending}
													var message = data.message;
													if (message) {
														fk_goods.value = message.idapp_fk_goods;
														itemcode.value = message.itemcode;
														goods.value = message.goodsname;
														usedemployee.value = message.usedemployee;
														nik_usedemployee.value = message.fk_usedemployee;
														idapp_usedemployee.value = message.idapp_usedemployee;
														nik_fromemployee.value = message.fk_usedemployee;
														fromemployee.value = message.usedemployee;
														idapp_fromemployee.value = message.idapp_usedemployee;
														typeApp.value = message.typeapp;
														idapp_fk_goods_outwards.value = (message.fkoutwards == null || message.fkoutwards == '') ? '' : message.fkoutwards;
														idapp_fk_goods_lend.value = (message.fklending == null || message.fklending == '') ? '' : message.fklending;
													}
												}
											}
											else {
												try {
													var data = JSON.parse(this.responseText);
												} catch (e) {
													window.document.body.style.cursor = 'default'; XhrError(this); return false;
												}
												if (data) {
													if (data.message !== '__empty') {
														window.document.body.style.cursor = 'default'; XhrError(this)
													}
													else {
														window.document.body.style.cursor = 'default'; dialogAlert(NA.common.message.canNotFindData, NA.common.message.titleInfo);
													}
												}
											}
										}, null, function () {//function untuk ajax error
											window.document.body.style.cursor = 'default'; XhrError(this);
										}, function () { window.document.body.style.cursor = 'default'; },//function ajax complete
										null//(parameter tambahan)nggak usah di isi bila tidak perlu(bila mau di isi isi dengan object javascript {key:value}
										)
                                		//usedemployee = qs('input#id_usedemployee'),
                                		//nik_usedemployee = qs('input#id_nik_usedemployee'),
                                		//idapp_usedemployee = qs('input#id_idapp_usedemployee'),
                                		//idapp_fk_goods_outwards = qs('input#id_idapp_fk_goods_outwards'),
                                		//idapp_fk_goods_lend = qs('input#id_idapp_fk_goods_lend');
                                		NA.NAEvent.preventDefault(event);//prevent from submit
                                	}
                                });
                                NA.NAEvent.addHandler(nik_fromemployee, 'keydown', function (event) {

                                	if (event.keyCode === 13) {
                                		if (!event.target.value) { dialogAlert('Please enter serial number', NA.common.message.titleInfo); NA.NAEvent.preventDefault(event); return false; }
                                		try {
                                			fillEmployeeName(event.target.value);
                                		} catch (e) {
                                			if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; } { window.document.body.style.cursor = 'default'; }
                                		}
                                		NA.NAEvent.preventDefault(event);//prevent from submit
                                	}
                                	return false;
                                });
                                NA.NAEvent.addHandler(btn_fkGoods, 'click', function (event) {
                                    searchGoods(event);
                                });

                                NA.NAEvent.addHandler(btn_fkEmployee, 'click', function (event) {
                                	searchEmployee(event);
                                });

                                //NA.NAEvent.addHandler(nik_fromemployee, 'keydown', function (event) {
                                //	if (event.keyCode == 13) {
                                //		searchEmployee(event);
                                //	}
                                //});

                                initializeForm = NA.common.getElementID('id_initializeForm');
                                initializeForm.Value = originalData;
                                //setting Custom Validity
                            }

                        	//================warn user if he/she closed / refresh windows===============

                            win.onbeforeunload = function (e) {
                            	var valuesForm = getValues_Form();
                            	if (NA.common.detectInputChanges(valuesForm, JSON.parse(originalData))) {
                            		return NA.common.message.dataHasChanged;
                            	}
                            }
                        };
                        NA.NAEvent.preventDefault(event);
                        if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; }
                    });
            };
            var dialog = qs("div.containerDialog"),
            btnOkCancel = qsAll('div.dialogButtonOKCancel>a.button'),
            btnClose = qs('button.ui-button.ui-dialog-titlebar-close');
            Array.prototype.forEach.call(btnOkCancel, function (elem) {
                NA.NAEvent.addHandler(elem, 'click', function (event) {
                    var target = NA.NAEvent.getTarget(event);
                    ExecuteHandler(target.innerText.trim());
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
            });
            NA.NAEvent.addHandler(btnClose,'click', function (event) {
                ExecuteHandler('Close');
                if (event) {
                    NA.NAEvent.stopPropagation(event);
                };
            });

        } catch (e) {
            if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; }
            alert(e);
        }
    };
});
</script>

{% endblock %}
