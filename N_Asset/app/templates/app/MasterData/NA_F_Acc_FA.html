{% extends 'app/layout.html' %}

{% block SearchData %}
<li><a href="#" data-tipe="varchar" data-column="goodsname">Goods Name</a></li>
<li><a href="#" data-tipe="varchar" data-column="brandname">Brand Name</a></li>
<li><a href="#" data-tipe="varchar" data-column="itemcode">Item code</a></li>
<li><a href="#" data-tipe="varchar" data-column="serialnumber">Serial Number</a></li>
<li><a href="#" data-tipe="varchar" data-column="year">Year</a></li>
<li><a href="#" data-tipe="varchar" data-column="startdate">Start Date</a></li>
<li><a href="#" data-tipe="varchar" data-column="depr_expense">Depreciation Expense</a></li>
<li><a href="#" data-tipe="varchar" data-column="depr_accumulation">Depreciation Accumulation</a></li>
<li><a href="#" data-tipe="varchar" data-column="bookvalue">Book Value</a></li>
<!--<li class="divider"></li>-->
<li><a id="custSearch" href="#">Custom Search</a></li>
<!--<li class="divider"></li>-->
{% endblock %}

{% block javascriptAndUI %}
{% load static %}

<script type="text/javascript" src="../../../static/app/scripts/NAJS.js"></script>
<script type="text/javascript">

    (function(){
        var txtSearchMaster =  NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
            btnSearchMaster = NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default');
        window.onunload = function(){
            if (typeof txtSearchMaster.onclick == "function") {
                NA.NAEvent.removeHandler(txtSearchMaster,'keydown',handlerSearchInput)
            }
            if (typeof btnSearchMaster.onclick == "function") {
                NA.NAEvent.removeHandler(btnSearchMaster,'click',handlerSearchInput);
            }
        };
//=================add Dynamic Styles=============================
        NA.common.loadStyles("../../../static/app/content/jquery-ui.min.css","jqueryUI");
        NA.common.loadStyles("../../../static/app/content/ui.jqgrid.css","UIJqueryGrid");
        var doc = doc||window.document;
        var DivSearch = doc.querySelector('ul.dropdown-menu.search');//return list Element
        (function(elm){
            var listElem = elm.children;
            Array.prototype.forEach.call(listElem,function(item){//buat jadi foreach mesti convert dulu ke array
                if(item.firstChild.nodeValue != 'CustomSearch'){
                    NA.NAEvent.addHandler(item,'click',function(event){
                        event.preventDefault();
                        if(item.firstChild.id === 'custSearch'){
                            //=========='show dialog search'==================
                            NA.common.dialog.createSearchDialog(event)
                        }
                        NA.common.getElementID('bySearch').firstChild.nodeValue = item.textContent;
                        if (item.textContent.trim() === 'Start Date') {
                            $('input[name="q"]').datepicker({
                                dateFormat: 'yy-mm-dd',
                                changeMonth: true,
                                changeYear: true,
                                dayNamesMin: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri ', 'Sat'],
                            });
                        } else {
                            $('input[name="q"]').datepicker('destroy');
                        }
                    });
                }
            });
        })(DivSearch);
    })();
</script>
<script src="{% static 'app/scripts/jquery-1.11.0.min.js' %}" id="jq_uery"></script>
<script type="text/javascript" src="{% static 'app/scripts/grid.locale-en.js' %}"></script>

<script src="{% static 'app/scripts/jquery.jqGrid.min.js' %}"></script>
<script src="{% static 'app/scripts/jquery-ui.js' %}"></script>
<script type="text/javascript">if (typeof $.fn.modal == 'undefined') { NA.common.doc.write('\<script src\=\"\.\.\/\.\.\/\.\.\/static\/app\/scripts\/bootstrap\.js\"\>\<\/script\>'); }</script>
<script src="../../../static/app/scripts/bootstrap-dialog.js"></script>
<style>
div#content-0 {
    overflow:hidden;
}
div[id*=gbox_NA_Acc_grid],div[id*=gview_NA_Acc_grid],
div[id*=NA_Acc_pager],div.ui-jqgrid-titlebar,
div.ui-jqgrid-hdiv.ui-state-default.ui-corner-top,
div[id*=NA_Acc_grid]{
    border-radius: 0px
}

</style>
{% endblock %}

{% block content-0 %}
<table id="NA_Acc_grid" style="overflow:auto"></table>
<div id="NA_Acc_pager" class="scroll" style="text-align:center;"></div>
{% endblock %}

{% block DialogEntry %}
<script>
    function get_csrf(){
        csrf_token = '{{csrf_token}}'
        return csrf_token
    }
</script>
<script type="text/javascript">
    var win = win || window;
    var status = win.status || window.status;
    var acc_grid = $("#NA_Acc_grid");
    var txtSearchMaster = txtSearchMaster || NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
        btnSearchMaster = btnSearchMaster || NA.common.doc.querySelector('form.navbar-form button[type="submit"].btn.btn-default'),
        qs = NA.common.qs,
        qsAll = NA.common.qsAll;
    $(document).ready(function () {
        
        function LoadData(page) {
            var url_parent = 'getData/?' + win.encodeURIComponent('columnName') + '=' + win.encodeURIComponent(NA.common.SearchData.getColumnKey()) +
                          '&' + win.encodeURIComponent('valueKey') + '=' + win.encodeURIComponent(NA.common.SearchData.getValueKey()) +
                          '&' + win.encodeURIComponent('dataType') + '=' + win.encodeURIComponent(NA.common.SearchData.getDataType()) +
                          '&' + win.encodeURIComponent('criteria') + '=' + win.encodeURIComponent(NA.common.SearchData.getCriteria()) +
                          '&' + win.encodeURIComponent('is_parent') + '=' + win.encodeURIComponent('1');
            if (arguments.length > 0) {
                acc_grid.setGridParam({ url: url_parent }).trigger("reloadGrid", [{ page: page, }]);
            } else {
                acc_grid.jqGrid({
                    url: url_parent,
                    datatype: 'json',
                    mtype: 'GET',
                    colNames: ['idapp', 'No', 'Item code', 'Goods', 'Type of Goods', 'Serial Number', 'Date Acquisition', 'Year', 'Createddate', 'Createdby'],
                    colModel: [
                        { name: 'idapp', index: 'idapp', width: 65, search: false, editable: false, hidden: true, key: true },//
                        { name: 'no', index: 'no', width: 50, align: 'right' },
                        { name: 'itemcode', index: 'itemcode', width: 80, align: 'left' },
                        { name: 'goods', index: 'goods', width: 170, align: 'left' },
                        { name: 'typapp', index: 'typapp', width: 100, align: 'left' },
                        { name: 'serialNumber', index: 'serialNumber', width: 150, align: 'left' },
                        { name: 'startdate', index: 'startdate', width: 150, align: 'center', search: false, 
                        formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F, Y' } },
                        { name: 'year', index: 'year', width: 80, sortable: true },
                        { name: 'createddate', index: 'createddate', width: 175, align: 'center', editable: false, search: false, formatter: 'date', formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd F, Y H:i:s' } },
                        { name: 'createdby', index: 'createdby', width: 115, search: false, editable: false }
                    ],
                    jsonreader: {
                        repeatitems: false,
                        id: 'idapp',
                        root: 'rows'
                    },
                    pager: $('#NA_Acc_pager'),
                    rowList: [20, 50, 100, 200, 300, 500],
                    rowNum: 300,
                    loadui: 'disable', // Disable Loading Text
                    cellEdit: false,
                    sortname: 'idapp',
                    sortorder: "desc",
                    viewrecords: true,
                    iconSet: "fontAwesome",
                    hidegrid: true,
                    shrinkToFit: false,
                    caption: 'Nufarm -- Asset Depreciation',
                    height: $('div.fltlft').height() - ($('div.fltlft').height() * 0.173),
                    width: 'inherit',
                    subGrid: true,
                    subGridRowExpanded: showChildGrid,
                    subGridOptions: {
                    	"plusicon": "ui-icon-triangle-1-e",
                    	"minusicon": "ui-icon-triangle-1-s",
                    	"openicon": "ui-icon-arrowreturnthick-1-e"
                    },
                    prmNames: {
                        oper: 'oper', addoper: 'add', editoper: 'edit', deloper: 'del', id: 'idapp'
                    },
                    ondblClickRow: function (rowId) {
                        var btnOpen = NA.common.doc.querySelector('ul.nav.navbar-nav>li:nth-child(2)>button');
                        if (btnOpen) {
                            btnOpen.click();
                        }
                    },
                    gridComplete: function () {
                        $('.ui-sgcollapsed').dblclick(function (event) {
                            event.preventDefault();
                            event.stopPropagation(); //stop/remove event double click in row
                        });
                    },
                });
            }
        };

        function showChildGrid(parentRowID, parentRowKey) {
        	var childGridID = parentRowID + "_table";
            var childGridPagerID = parentRowID + "_pager";
            var rowData = acc_grid.getRowData(parentRowKey);
            var url_children = 'getData/?' + win.encodeURIComponent('columnName') + '=' + win.encodeURIComponent(NA.common.SearchData.getColumnKey()) +
            '&' + win.encodeURIComponent('valueKey') + '=' + win.encodeURIComponent('') +
            '&' + win.encodeURIComponent('dataType') + '=' + win.encodeURIComponent(NA.common.SearchData.getDataType()) +
            '&' + win.encodeURIComponent('criteria') + '=' + win.encodeURIComponent(NA.common.SearchData.getCriteria()) +
            '&' + win.encodeURIComponent('is_parent') + '=' + win.encodeURIComponent('0') + '&' + win.encodeURIComponent('serialnumber') + '=' +
            win.encodeURIComponent(rowData['serialNumber']);

        	$('#' + parentRowID).append('<table id=' + childGridID + '></table><div id=' + childGridPagerID + ' class=scroll></div>');

        	$("#" + childGridID).jqGrid({
        		url: url_children,
        		mtype: "GET",
        		datatype: "json",
                page: 1,
                colNames: ['idapp', 'No', 'Item code', 'Goods',  'Type of Goods','Serial Number', 'Date Acquisition', 'Date Depreciation', 'Depreciation Method', 'Depreciation Expense', 'Depreciation Accumulation', 'Book Value', 'Createddate', 'Createdby'],
        		colModel: [
                    { name: 'idapp', index: 'idapp', width: 65, search: false, editable: false, hidden: true, key: true },//
                    { name: 'no', index: 'no', width: 50, align: 'right' },
                    { name: 'itemcode', index: 'itemcode', width: 80, align: 'left' },
                    { name: 'goods', index: 'goods', width: 170, align: 'left' },
                    { name: 'typapp', index: 'typapp', width: 100, align: 'left' },
                    { name: 'serialNumber', index: 'serialNumber', width: 150, align: 'left' },
                    { name: 'startdate', index: 'startdate', width: 150, align: 'center', search: false, 
                    formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F, Y' } },
                    { name: 'date_depreciation', index: 'date_depreciation', width: 150, align: 'center', search: false, 
                    formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F, Y' } },
                    {
                        name: 'depreciationmethod', index: 'depreciationmethod', width: 150, align: 'left', formatter: 'select', editoptions: {
                            value: 'SL:Straight Line Method;DDB:Double Declining Balance;STYD:Sum Of The Year Digit'
                        }
                    },
                    {
                        name: 'depr_expense', index: 'depr_expense', width: 140, align: 'right', formatter: 'currency', formatoptions: {
                            decimalSeparator: ",", thousandsSeparator: ".",
                            decimalPlaces: 2, prefix: "Rp "
                        }, filter: { type: 'textbox', condition: 'contains', listeners: ['keyup'] }
                    },
                    {
                        name: 'depr_accumulation', index: 'depr_accumulation', width: 165, align: 'right', formatter: 'currency', formatoptions: {
                            decimalSeparator: ",", thousandsSeparator: ".",
                            decimalPlaces: 2, prefix: "Rp "
                        }, filter: { type: 'textbox', condition: 'contains', listeners: ['keyup'] }
                    },
                    {
                        name: 'bookvalue', index: 'bookvalue', width: 165, align: 'right', formatter: 'currency', formatoptions: {
                            decimalSeparator: ",", thousandsSeparator: ".",
                            decimalPlaces: 2, prefix: "Rp "
                        }, filter: { type: 'textbox', condition: 'contains', listeners: ['keyup'] }
                    },
                    { name: 'createddate', index: 'createddate', width: 175, align: 'center', editable: false, search: false, formatter: 'date', formatoptions: { srcformat: 'Y-m-dTH:i:s', newformat: 'd F, Y H:i:s' } },
                    { name: 'createdby', index: 'createdby', width: 115, search: false, editable: false }
                ],
        		viewrecords: true,
				rowNum:10,
        		width: 'inherit',
                height: '100%',
                hidegrid: true,
                shrinkToFit: false,
                pager: "#" + childGridPagerID,
            });

            $("div#gbox_" + childGridID + ", div#gview_" + childGridID + ", div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv, div#"+childGridPagerID).css({
                'width':'inherit'
            });

            function getChildGridId() {
        		return $('#' + childGridID).jqGrid('getGridParam', 'selrow');
            }

            $('#' + childGridID).navGrid('#' + childGridPagerID, {
                edit: false,
                add: false,
                del: false,
                search: false,
                refresh: false,
                cloneToTop: false
            }).navButtonAdd('#' + childGridPagerID, {
                caption: "",
                buttonicon: "ui-icon-trash",
                onClickButton: function () {
                    var idapp = getChildGridId();
                    if (idapp == null) {
                        return dialogAlert('Please select data you want to delete', NA.common.message.titleInfo);
                    }
                    return dialogConfirm(NA.common.message.confirmDelete, NA.common.message.titleInfo, function () {
                        var permission_url_delete = 'delete/';
                        $.ajax({
                            url: permission_url_delete,
                            method: 'POST',
                            beforeSend: function (xhr) {
                                xhr.setRequestHeader('X-CSRFToken', NA.CookieUtil.get('csrftoken'))
                            },
                            data: {
                                'children':true,
                                'idapp': idapp
                            },
                            success: function (data) {
                                $("#" + childGridID).trigger('reloadGrid');
                            }
                        })
                    })
                },
                position: "last"
            });
        }

        var SearchData = NA.common.SearchData;
        SearchData.setDefaultSearchData('goodsname', 'Varchar', 'like');

        LoadData();

        function handlerSearchInput(event) {
            event = NA.NAEvent.getEvent(event);
            var target = NA.NAEvent.getTarget(event);
            if (target == btnSearchMaster) {
                NA.NAEvent.preventDefault(event);
                var elSearch = NA.common.doc.querySelector('li.dropdown>a#bySearch'),
                SearchBy = NA.common.doc.querySelector('li.dropdown>a#bySearch').textContent.trim(),
                SearchInput = NA.common.doc.querySelector('input[name=q]');
                if (SearchBy.trim() == 'By') {
                    NA.common.SearchData.setDefaultSearchData('goodsname', 'Varchar', 'like');
                    var curPage = parseInt(acc_grid.getGridParam('page'));
                    window.document.body.style.cursor = 'wait';
                    NA.common.SearchData.setValue(SearchInput.value);
                    LoadData(curPage);
                }
                else {
                    //submit search
                    submitSearch(event);
                }
                NA.NAEvent.stopPropagation(event);
            }
            window.document.body.style.cursor = '';
        }
        //=======================handler txt & button Search master keyboard event and click================================
        NA.NAEvent.addHandler(txtSearchMaster, 'keydown', handlerSearchInput);
        NA.NAEvent.addHandler(btnSearchMaster, 'click', handlerSearchInput);

        acc_grid.on("keyup", "tr", function (e) {
            var rowId = acc_grid.jqGrid('getGridParam', 'selrow');
            if (e.keyCode == 46) {
                var btnDelete = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav li:nth-child(5)')
                btnDelete.click();
                //return false;
            }
        });
        acc_grid.navGrid('#NA_Employee_pager', {
            edit: true,
            add: true,
            del: true,
            search: true,
            refresh: true,
            view: true,
            cloneToTop: false
        });

        $("div#gbox_NA_Acc_grid, div#gview_NA_Acc_grid, div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv").css({
            'width':'inherit'
        });


//================================ Search by ==============================//


        //================================= End Search by ======================================//
    function submitSearch(event) {
        window.document.body.style.cursor = 'wait';
        if (event)
            NA.NAEvent.preventDefault(event);

        var elementOption = null, columnKey = '', valueKey = '',
        elCriteria = null,//NA.common.doc.querySelector('td.columns select.selectopts.NA-Form-Control option:checked');
        valCriteria = '',//elCriteria.nodeValue;
        elDataType = '';//elementOption.dataset.dataType;
        if (event.target.getAttribute('id') === 'fbox_jqGrid_search' || event.target.getAttribute('id') === 'jqg1') {//fbox_jqGrid_search == button search,jqg1 = txtSearch nya
            elementOption = NA.common.doc.querySelector('td.columns select.NA-Form-Control option:checked');
            columnKey = elementOption.getAttribute('name'), valueKey = NA.common.getElementID('jqg1').value;
            elCriteria = NA.common.doc.querySelector('td.operators select.selectopts.NA-Form-Control option:checked');
            criteria = elCriteria.value;
            switch (criteria) {
                case "eq": { valCriteria = 'equal'; break; }
                case "ne": { valCriteria = 'notequal'; break; }
                case "bw": { valCriteria = 'beginwith'; break; }
                case "ew": { valCriteria = "endwith"; break; }
                case "cn": { valCriteria = "like"; break; }
                case "in": { valCriteria = "in"; break; }
                case "ni": { valCriteria = "notin"; break; }
                case "gt": { valCriteria = "greater"; break; }
                case "le": { valCriteria = "less"; break; }
                case "leq": { valCriteria = "lessorequal"; break; }
                case "gtq": { valCriteria = "greaterorequal"; break; }
                case "bwe": { valCriteria = "between"; break; }
            };
            elDataType = elementOption.dataset.tipe;
        }
        else if (event.target == txtSearchMaster || event.target == btnSearchMaster) {
            var txtSearchMaster = NA.common.doc.querySelector('form.navbar-form div.input-group input[name="q"]'),
            elSearch = null;
            valueKey = txtSearchMaster.value.trim();
            var listElem = NA.common.doc.querySelector('ul.dropdown-menu.search').children;//return list Element
            var textToSearch = NA.common.getElementID('bySearch').firstChild.nodeValue;
            Array.prototype.forEach.call(listElem, function (item) {//buat jadi foreach mesti convert dulu ke array
                if (item.firstChild.textContent === textToSearch) {
                    elSearch = item.firstChild;
                }
            });
            columnKey = elSearch.dataset.column
            elDataType = elSearch.dataset.tipe;
            valCriteria = 'like'
            if (!elSearch.dataset.column) {
                switch (elDataType) {
                    case "bigint":
                    case "integer":
                    case "money":
                    case "float":
                    case "decimal":
                    case "boolean":
                    case "datetime": {
                        if (valueKey.toString().indexOf(',') > -1) {
                            criteria = 'in'
                        }
                        criteria = 'equal';
                        break;
                    }
                };
            }
        }

        NA.common.SearchData.setValue(valueKey);
        NA.common.SearchData.setColumnName(columnKey);
        NA.common.SearchData.setDataType(elDataType)
        NA.common.SearchData.setCriteria(valCriteria);
        window.document.body.style.cursor = 'wait';
        LoadData(1);
        document.body.style.cursor = 'default';
        acc_grid.jqGrid('setGridParam').trigger("reloadGrid", [{ page: 1 }]);//karena searching harus di set ke page 1
    };

        //function untuk Reset
    function submitReset(event) {
        //reload jqueryGrid
        //check apakah target dari btn reset
        if (event) {
            var target = NA.NAEvent.getTarget(event);
        }
        NA.common.SearchData.setDefaultSearchData('goodsname', 'varchar', 'like');
        NA.common.SearchData.setValue('');
        LoadData(1);
        window.document.body.style.cursor = 'default';
    };
        //========================Function Untuk memanggil Custom Search========================
    window.showDialogCustomSearch = function (event) {
        $('div.containerDialog').load("customFilter/", function (responseTxt, statusTxt, xhr) {
            if (statusTxt == "success") {
                var dialog = NA.common.doc.querySelector('div.containerDialog');
                NA.common.getElementID('searchmodfbox').style.display = 'block';
                var btnClose = NA.common.doc.querySelector('div#searchhdfbo a.ui-jqdialog-titlebar-close.ui-corner-all'),
                txtSearchCustom = NA.common.getElementID('jqg1');
                var selectColumn = NA.common.qs('div#fbox select.NA-Form-Control');
                NA.NAEvent.addHandler(selectColumn, 'change', function (event) {
                    if (this.value === 'startdate') {
                        $('input#jqg1').datepicker({
                            dateFormat: 'yy-mm-dd',
                            changeMonth: true,
                            changeYear: true,
                            dayNamesMin: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri ', 'Sat'],
                        });
                    } else {
                        $('input#jqg1').datepicker('destroy');
                    }
                });
                NA.NAEvent.addHandler(btnClose, 'click', function (event) {
                    NA.common.dialog.closeDialog(dialog);
                });
                var btnFind = NA.common.getElementID('fbox_jqGrid_search');
                NA.NAEvent.addHandler(btnFind, 'click', function (event) {
                    submitSearch(event);
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
                var btnReset = NA.common.getElementID('fbox_jqGrid_reset');
                NA.NAEvent.addHandler(btnReset, 'click', function (event) {
                    submitReset(event);
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
                NA.NAEvent.addHandler(txtSearchCustom, 'keydown', function (event) {
                    event = NA.NAEvent.getEvent(event);
                    if (event.keyCode === 13) {
                        submitSearch(event);
                    }
                    if (event) {
                        NA.NAEvent.stopPropagation(event);
                    }
                });
            }
        });
    };


            //script load dialog style sebelum panggil dialog
    var containerMenu = NA.common.dialog.doc.querySelector('ul.nav.navbar-nav');//inistialisasi menu
    //load Dialog Style css
    NA.common.loadStyles("../../../static/app/content/Dialog.css", "DialogEntryStyle");//Load Style buat dialog sebelum di pakai
    NA.common.loadStyles("../../../static/app/content/NA_commonEntry.css","CommonEntry");//Load Style buat form sebelum di pakai

    NA.common.dialog.initDialog(containerMenu,'Nufarm Entry Goods - Asset Depreciation');//inistialisasi menu

    var elementMenus = [];
    var menus = NA.common.doc.querySelectorAll('div.sidebar ul.list-sidebar.bg-defoult li ul li a');
    Array.prototype.forEach.call(menus, function (item) {
        if (item.textContent.indexOf("Email Data") > -1) {
            elementMenus.push(item);
        }
    });
    NA.common.dialog.initDialog(null,'Nufarm Send Email - Master Data',elementMenus);//inistialisasi menu

    function getGridId() {
        return $(acc_grid).jqGrid('getGridParam', 'selrow')
    }

    function getGridValue (grid,jqgId, column) {
        var col = grid.jqGrid('getCell', jqgId, column);
        return col
    }
    function getValues_accForm() {
        var data = {
            fk_goods: qs('input#id_fk_goods').value.trim(),
            itemcode: qs('input#id_itemcode').value.trim(),
            typeApp:qs('input#id_typeApp').value.trim(),
            //brandname: qs('input#id_brandname').value.trim(),
            goods_name: qs('input#id_goods_name').value.trim(),
            serialNumber:qs('input#id_serialNumber').value.trim(),
            startdate: qs('input#id_startdate').value.trim(),
            enddate:qs('input#id_enddate').value.trim(),
            depr_method:qs('input#id_depr_method').value.trim(),
            price: typeof qs('input#id_price').Value == 'undefined' ? '' : qs('input#id_price').Value.trim(),
            economiclife:qs('input#id_economiclife').value.trim()
        };
        return data
    }


    var btnDelete = qs('ul.nav.navbar-nav li:nth-child(5)')
    NA.NAEvent.addHandler(btnDelete, 'click', function (event) {
        var get_idapp = getGridId(),
        serial_number = acc_grid.jqGrid('getRowData', get_idapp)['serialNumber'];
        if (get_idapp) {
            NA.NAEvent.preventDefault(event);
            return dialogConfirm(NA.common.message.confirmDelete, NA.common.message.titleInfo, function () {
                $.ajax({
                    url: 'delete/',
                    method: 'POST',
                    data: {
                        'parent':true,
                        'serial_number': serial_number
                    },
                    beforeSend: function(xhr){
                        xhr.setRequestHeader('X-CSRFToken', NA.CookieUtil.get('csrftoken'));
                    },
                    success: function (data) {
                        var rowNum = acc_grid.getGridParam('rowNum'),
                         allRecords = acc_grid.getGridParam('records'),
                         totalPages = parseInt((allRecords / rowNum) + 1),
                         curPage = acc_grid.getGridParam('page'),
                         rowId = acc_grid.jqGrid('getGridParam', 'selrow'),
                            curRecount = acc_grid.jqGrid('getGridParam', 'reccount');
                        mustReload = true;
                        if (parseInt(curRecount) === 1) {
                            if (totalPages > 1) {
                                curPage--;
                            }
                            else {
                                mustReload = false;
                                acc_grid.delRowData(rowId);
                            }
                        }
                        else if (parseInt(totalPages) === 1) {
                            mustReload = false;
                            acc_grid.delRowData(rowId);
                        }
                        else if (parseInt(curRecount) > 1) {
                            mustReload = false;
                            acc_grid.delRowData(rowId);
                        }
                        if (mustReload) {
                            window.document.body.style.cursor = 'wait';
                            acc_grid.trigger("reloadGrid", [{ page: curPage }]);
                        }
                        reload_LogEvent();
                    }
                });
            },
            function () {
                return false;
            })
        }
        else {
            document.body.style.cursor = 'default';
            return dialogAlert('Please select data you want to delete',NA.common.message.titleInfo);
        }
        return false;
    });

    status = status || window.status
    function AccSubmit() {
        var grid_form_acc = grid_form_acc || $('#grid_form_acc');
        var data = grid_form_acc.jqGrid('getGridParam', 'selarrrow');
        var arr_idapp = [];
        for(var i=0; i<data.length; i++) {
            arr_idapp.push(
                grid_form_acc.getRowData(data[i]).idapp_detail_receive
            )
        }
        $.ajax({
            url: 'ShowEntry/',
            method: 'POST',
            beforeSend: function (jqXHR) {
                jqXHR.setRequestHeader('X-CSRFToken', get_csrf())
            },
            data: {
                idapp_detail_receive: arr_idapp.join(),
                mode: 'Add'
            },
            success: function (data) {
                var dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
                NA.common.dialog.closeDialog(dialog);
                var loading = $('div#load_NA_Acc_grid');
                setTimeout(function() {
                    loading.show();
                }, 500);
                
                setTimeout(function () {
                    loading.hide();
                    acc_grid.trigger('reloadGrid');
                }, 1000);
                
                reload_LogEvent();
            }
        });
    };

    function ExecuteHandler(TextElement) {
        var initializeForm = NA.common.getElementID('id_initializeForm');
        var dialog = NA.common.dialog.doc.querySelector("div.containerDialog"),
        frmEntry = NA.common.doc.querySelector('form#acc_form'),
        emailForm = NA.common.doc.querySelector('form#email_data'),
        originalData = status !== 'Open' ? JSON.parse(initializeForm.Value) : '',
        valuesForm = getValues_accForm(),
        typeApp = qs('input#id_typeApp');
        
        if (frmEntry) {
            switch (TextElement) {
                case 'OK': {
                    if (typeApp.value === '') {
                        return typeApp.validity.valid = false;
                    }
                    if (!frmEntry.checkValidity()) {
                        //NA.NAEvent.preventDefault(event);
                        var inputbtn = NA.common.getElementID('acc_submit');
                        inputbtn.click();
                    }
                    else {
                        if (NA.common.detectInputChanges(originalData, valuesForm)) {
                            AccSubmit();
                        }
                        else {
                            NA.common.dialog.closeDialog(dialog);
                        }
                    }
                    break;
                }
                case 'Cancel':
                case 'Close': {
                    if (status === 'Open' || initializeForm.Value == '') { NA.common.dialog.closeDialog(dialog); return false; }
                    if (NA.common.detectInputChanges(originalData, valuesForm)) {
                        return dialogConfirm(NA.common.message.dataHasChanged, NA.common.message.titleInfo, function () {
                            if (!frmEntry.checkValidity()) {
                                var inputbtn = NA.common.getElementID('acc_submit');
                                inputbtn.click();
                            } else {
                                if (NA.common.detectInputChanges(originalData, valuesForm)) {
                                    AccSubmit();
                                } else {
                                    NA.common.dialog.closeDialog(dialog);
                                }
                            }
                        },
                        function () {
                            NA.common.dialog.closeDialog(dialog);
                        });
                    } else {
                        NA.common.dialog.closeDialog(dialog);
                    }
                }
            };
        } else if (emailForm) {
            var emailForm = NA.common.doc.querySelector('form#email_data');
            switch (TextElement) {
                case 'Cancel':
                case 'Close': {
                    var initializeEmail = NA.common.getElementID('initializeEmail');
                    var originalData = initializeEmail.Value;
                    var valuesForm = getValues_emailForm();

                    if (NA.common.detectInputChanges(originalData, valuesForm)) {
                        if (confirm('Data has changed, \nAre you sure to Send mail ?')) {
                            if (!emailForm.checkValidity()) {
                                //NA.NAEvent.preventDefault(event);
                                var inputbtn = NA.common.getElementID('emailData_submit');
                                inputbtn.click();
                            } else {
                                NA.common.doc.querySelector('div.dialogButtonOKCancel>a.button:nth-child(1)').click()
                            }
                        } else {
                            NA.common.dialog.closeDialog(dialog);
                        }
                    } else {
                        NA.common.dialog.closeDialog(dialog);
                    }
                }

            }
        }

    };
    function restyleBoostrapDialog() {
        var BSDialogContent = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content');
        BSDialogContent.style.cssText = 'width: 450px; height: 350px;';
        var ContentBody = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content>.modal-body');
        ContentBody.style.cssText = 'padding:0px;';
        var contentFooter = NA.common.doc.querySelector('div.modal-dialog.modal-sm >.modal-content>.modal-footer');
        contentFooter.style.cssText = 'padding-bottom:0px;padding-top:0px;';
        var mHeader = NA.common.doc.querySelector('div.bootstrap-dialog .modal-header.bootstrap-dialog-draggable');
        mHeader.style.cssText = 'height:30px;padding:5px;font-weight:bold';
        var footerButton = NA.common.doc.querySelector('div.bootstrap-dialog-footer-buttons');
        footerButton.style.cssText = 'padding-top:8px;';
        };
    function getGridCellValue(thegrid,CeltoGet) {
            var reccount = thegrid.jqGrid('getGridParam', 'reccount');
            var rowId, rowData, colData;
            if (reccount > 0) {
                rowId = thegrid.jqGrid('getGridParam', 'selrow');
                if (rowId) {
                    rowData = thegrid.getRowData(rowId);
                    colData = rowData[CeltoGet];
                }
            }
            return colData;
    };
    function dialogConfirm(message, title, callTrue, callFalse) {
        return BootstrapDialog.confirm({
            title: title || NA.common.message.titleInfo,
            message: message,
            type: BootstrapDialog.TYPE_WARNING,
            size: BootstrapDialog.SIZE_SMALL,
            animate: false,
            cssClass: 'login-dialog',
            closeByBackdrop: false,
            closeByKeyboard: false,
            closable: false,
            draggable: true,
            btnCancelLabel: 'NO.',
            btnOKLabel: 'Yes.',
            btnOKClass: 'btn-success',
            callback: function (result) {
                if (result) {
                    if (callTrue) {
                        callTrue();
                    }
                }
                else {
                    if (callFalse) {
                        callFalse();
                    }
                }
            },
            onshown: function (dialogRef) {
                var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
                divHeader.style.backgroundColor = 'green';
            }
        });
    };

    function dialogAlert(message, title, callback) {
        return BootstrapDialog.alert({
            title: title || NA.common.message.titleInfo,
            message: message,
            size: BootstrapDialog.SIZE_SMALL,
            //animate:false,
            cssClass: 'login-dialog',
            closeByBackdrop: false,
            closeByKeyboard: false,
            type: BootstrapDialog.TYPE_INFO,
            closable: false,
            draggable: true,
            buttonLabel: 'OK',
            callback: function (result) {
                if (result) {
                    if (callback) {
                        callback();
                    }
                    return true;
                }
            },
            onshown: function (dialogRef) {
                var divHeader = NA.common.doc.querySelector('div.modal-header:nth-child(1)');
                divHeader.style.backgroundColor = 'green';
            }
        });
    };
    window.showDialogEntry = function (event) {//function ini akan di panggil oleh NAJS.common.dialog,setiap menu add/edit/delete,etc di clik
        //add handler to btnOK untuk mengantisipasi form load gagal
        var win = window
        var target = NA.NAEvent.getTarget(event);

        try {

            if (target.innerText === 'Email Data') {
                var bottomRight = $('div.dialogButtonRightOther');
                bottomRight.find('a.btn-link:eq(1)').css({
                    'cursor': 'pointer',
                    'pointer-events': 'all',
                    'width': 'auto',
                    'margin-right':'5px'
                }).text('Export To PDF');
                bottomRight.find('a.btn-link:eq(0)').css({
                    'cursor': 'pointer',
                    'pointer-events': 'all',
                    'width': 'auto'
                }).text('Preview PDF');
                //$('<a class="btn btn-success" style="#8FBC8F">Export To PDF</a>').insertAfter($('div.dialogButtonRightOther').find('a.btn-link'))
                var btnToPDF = document.querySelector('div.bottomDialogContent a.btn-link:nth-child(1)');
                //====================================== Display Email Data Dialog =========================================
                $('div.maindialogContent').load(url_emailData(), function (response, status, xhr) {
                    if (status == "success") {
                        var jspdf = "../../../static/app/scripts/jspdf.js";
                        var sfm = "../../../static/app/scripts/standard_fonts_metrics.js";
                        var stz = "../../../static/app/scripts/split_text_to_size.js";
                        var js_pdf = "../../../static/app/scripts/jspdf.plugin.autotable.min.js";
                        var jqUI = "../../../static/app/scripts/jquery-ui.min.js";
                        var autoComp = "../../../static/app/scripts/autocomplete.js";
                        var emailDataJS = "../../../static/app/scripts/NA_EmailData.js";
                        var oneLoad = $('body > script[src="' + jspdf + '"]') && $('head > script[src="' + jspdf + '"]') && $('head > script[src="' + jspdf + '"]');
                        if (!oneLoad.length) {
                            var afterJquery = $('script#jq_uery');
                            $('<script type="text/javascript" src="' + jspdf + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + sfm + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + stz + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + js_pdf + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + jqUI + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + autoComp + '">').insertAfter(afterJquery);
                            $('<script type="text/javascript" src="' + emailDataJS + '">').insertAfter(afterJquery);
                        };
                        var originalData = getValues_emailForm();
                        var initializeEmail = NA.common.getElementID('initializeEmail');
                        initializeEmail.Value = originalData;

                        //=========================================== End Display Email Data Dialog ===========================================
                    }

                });

                //if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; }
                //return false;
            } else if (target.innerText.trim() === 'Add' || target.innerText.trim() === 'Edit' || target.innerText.trim() == 'Open') {
                if (target.innerText.trim() == 'Edit'||target.innerText.trim() =='Open') {
                    var idapp = getGridId();
                    if (typeof idapp == 'undefined' || !idapp || idapp == '') {
                        var dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
                        NA.common.dialog.closeDialog(dialog);
                        var message = 'No Data Found at Here'
                        if (acc_grid.getGridParam('records') > 0) {
                            message = 'Please Select data to Open or Edit !!'
                        };
                        return dialogAlert(message, NA.common.message.titleInfo, function () {
                            return acc_grid.trigger('reloadGrid');
                        });
                    }
                }

                if (target.innerText.trim() == 'Add'){
                    var container_grid_form = document.createElement('div');
                    var placeHolder = 'Enter goods descriptions to search for .. .';
                    var container_search_form = NA.common.dialog.createFormContainer('search_acc_fa', placeHolder,
                    function (e) {//event for blur
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') === '') {
                                this.setAttribute('placeholder', placeHolder);
                            }
                        }
                    },
                    function (e) {//event for focus
                        if (this.value === '') {
                            if (this.getAttribute('placeholder') === placeHolder) {
                                this.setAttribute('placeholder', '');
                            }
                        }
                    },
                    function (e) {//even for keydown txtSearch                                                  
                        if (e.keyCode === 13) {
                            NA.NAEvent.preventDefault(e);
                            win.document.body.style.cursor = 'wait';
                            //cari data ke database
                            var url = 'SearchGoodsByForm/?' + win.encodeURIComponent('goods_filter') + '=' + win.encodeURIComponent(e.target.value.trim());
                            $('#grid_form_acc').setGridParam({ url: url, search: true }).trigger("reloadGrid", [{ page: 1, }]);
                            win.document.body.style.cursor = 'default';
                            NA.NAEvent.stopPropagation(e);
                        }
                    }, function (e) {
                        txtSearch = NA.common.getElementID('txtsearch_fk_goods');
                        NA.common.triggerKeyboardEvent(txtSearch, 13);
                    });
                    container_grid_form.id = 'container_grid_form';
                    container_grid_form.style.width = '750px';
                    container_grid_form.style.marginTop = '10px';
                    container_grid_form.style.marginBottom = '20px';
                    var grid_form_acc = document.createElement('table')
                    grid_form_acc.id = 'grid_form_acc';
                    var pager_form_acc = document.createElement('div');
                    pager_form_acc.id = 'pager_form_acc';
                    pager_form_acc.className = 'scroll';
                    pager_form_acc.style.textAlign = 'center';
                    container_grid_form.appendChild(grid_form_acc);
                    container_grid_form.appendChild(pager_form_acc);
                    var url = 'SearchGoodsByForm/?' + win.encodeURIComponent('goods_filter') + '=' + win.encodeURIComponent('');
                    var container_dialog = qs('div.maindialogContent');
                    container_dialog.appendChild(container_search_form);
                    container_dialog.appendChild(container_grid_form);
                    
                    var grid_form_acc = $('#grid_form_acc');
                    grid_form_acc.jqGrid({
                        url: url,
                        mtype: "GET",
                        datatype: "json",
                        page: 1,
                        colNames: ['idapp', 'NO', 'itemcode', 'goods Description', 'Serial Number', 
                        'Price', 'Economic life', 'Depreciation method', 'Start Date', 'End Date' , 'idapp_detail_receive'],
                        colModel: [
                            { name: 'idapp', hidden: true, align: 'left' },
                            { name: 'no', width: 40, align: 'right', sortable: false, editable: false, key: true, },
                            { name: 'itemcode', width: 80, align: 'left', sortable: true, editable: false, },
                            { name: 'goods', index: 'goods', width: 200, sortable: true, editable: false, align: 'left', },
                            { name: 'serialnumber', index: 'serialnumber', width: 150, sortable: true, editable: false, align: 'left', },
                            { name: 'price', index: 'price', width: 150, sortable: true, editable: false, align: 'left', },
                            { name: 'economic_life', index: 'economic_life', width: 100, sortable: true, editable: false, align: 'left', },
                            { name: 'depr_method', index: 'depr_method', width: 150, sortable: true, editable: false, align: 'left',formatter: 'select',
							editoptions: {
								value: 'SL:Straight Line;DDB:Double Declining Balance;STYD:Sum of The Year Digit'
							} },
                            { name: 'startdate', index: 'startdate', width: 150, sortable: true, editable: false, align: 'left',
                            formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' } },
                            { name: 'enddate', index: 'enddate', width: 150, sortable: true, editable: false, align: 'left', 
                            formatter: 'date', formatoptions: { srcformat: 'Y-m-d', newformat: 'd F Y' } },
                            { name: 'idapp_detail_receive', index: 'idapp_detail_receive', hidden: true }
                        ],
                        viewrecords: true,
                        hidegrid: true,
                        multiselect: true,
                        shrinkToFit: false,
                        width: 'inherit',
                        height: '400px',
                        pager: '#pager_form_acc',
                        rowList: [20, 50, 100, 200, 300, 500],
                        rowNum: 300,
                    });
                    $('div#gbox_grid_form_acc, div#gview_grid_form_acc, div.ui-jqgrid-bdiv, div.ui-jqgrid-hdiv, div#pager_form_acc, div#pg_pager_form_acc').css('width', 'inherit')
                }
            }
            var dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
            $('div.dialogButtonOKCancel>a.button').on('click', function () {
                var innerText = $(this).text()
                if (innerText == 'OK'){
                    AccSubmit()
                }
            });
            $('button.ui-button.ui-dialog-titlebar-close').on('click', function (event) {
                NA.NAEvent.preventDefault(event);
                NA.common.dialog.closeDialog(dialog);
            });


        } catch (e) {
            dialog = NA.common.dialog.doc.querySelector("div.containerDialog");
            if (window.document.body.style.cursor != 'default') { window.document.body.style.cursor = 'default'; }
            alert(e);
        }
    };
});
</script>

{% endblock %}
